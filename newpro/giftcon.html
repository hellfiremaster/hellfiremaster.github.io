<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2a4065">
  <title>ë‰´í”„ë¡œ â€” ì‹œí¬ë¦¿ ì‚°íƒ€</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Comic+Neue:wght@400;700&family=Poor+Story&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- ê³µí†µ ìŠ¤íƒ€ì¼ (ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
  <link rel="stylesheet" href="./common/common.css" />

  <style>
    /* ë“œë¡­ì¡´ */
    .dropzone{
      position:relative; text-align:center;
      border:2px dashed #cfd8e3; border-radius:14px; padding:18px;
      background:linear-gradient(180deg,#ffffffaa,#f7fbffcc);
      transition:.2s ease;
    }
    .dropzone.dragover{ background:#f0f7ff; border-color:#99bce8; }
    .dropzone input[type="file"]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    [data-bs-theme="dark"] .dropzone{
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(2,6,23,.92)); /* ì–´ë‘ìš´ ë°°ê²½ */
      border-color: rgba(255,255,255,.16);
    }
    [data-bs-theme="dark"] .dropzone.dragover{
      background: rgba(30,41,59,.95);
      border-color:#86b7fe; /* ë“œë˜ê·¸ ì‹œ ê°•ì¡° */
    }
    [data-bs-theme="dark"] .dropzone .fw-semibold{ color:#e5e7eb; }  /* ì œëª© í…ìŠ¤íŠ¸ */
    [data-bs-theme="dark"] .dropzone .text-muted{ color:#cbd5e1 !important; } /* ë³´ì¡° í…ìŠ¤íŠ¸ */
    [data-bs-theme="dark"] .dropzone .bi{ color:#cbd5e1 !important; } /* ì•„ì´ì½˜ */

    /* í”„ë¦¬ë·°+ë©”íƒ€ ì˜ì—­: flex â†’ grid ë¡œ ë³€ê²½ (í­ ë¬¸ì œ í•´ê²°) */
    .preview-wrap{
      display:grid; gap:16px; align-items:stretch;
      grid-template-columns: 1fr; /* ê¸°ë³¸ì€ 1ì—´(ëª¨ë°”ì¼) */
    }
    @media (min-width: 768px){
      .preview-wrap{
        /* ì™¼ìª½ í¬ê²Œ, ì˜¤ë¥¸ìª½ ì ë‹¹íˆ â€” ì¢ì•„ì§€ì§€ ì•Šê²Œ minmax */
        grid-template-columns: minmax(480px, 1fr) minmax(260px, 360px);
      }
    }
    @media (min-width: 1200px){
      .preview-wrap{
        grid-template-columns: minmax(640px, 1fr) minmax(280px, 400px);
      }
    }

    /* í”„ë¦¬ë·° ë°•ìŠ¤ (ì´ë¯¸ì§€ ì—†ì„ ë•Œë„ ì˜ˆì˜ê²Œ â€” CSS-only ë¹ˆìƒíƒœ) */
    .preview-img{
      position:relative; display:grid; place-items:center;
      min-height:320px; border-radius:12px; overflow:hidden;
      border:1px dashed #d6e0ef;
      background: #475467;
      transition:border-color .2s ease, background .2s ease;
    }
    .preview-img:hover{ border-color:#9db7e8; }

    .preview-img img{
      max-width:100%; max-height:60vh; object-fit:contain; border-radius:10px;
    }

    /* ì´ë¯¸ì§€ ì—†ì„ ë•Œ ë¬¸êµ¬ ë³´ì—¬ì£¼ê¸° (JS ì—†ì´ ìë™) */
    .preview-img:not(:has(img[src^="data:"], img[src^="blob:"], img[src^="http"], img[src^="/"]))::before{
      content:"ì‹œí¬ë¦¿ ì„ ë¬¼ ë¯¸ë¦¬ë³´ê¸°âœ¨";
      white-space:pre-line; text-align:center; color:#667085; line-height:1.4;
      font-size:.95rem; padding:18px 24px; border-radius:10px;
      background:rgba(255,255,255,.85);
      box-shadow:0 6px 20px rgba(16,24,40,.08);
    }
    .preview-img:not(:has(img[src^="data:"], img[src^="blob:"], img[src^="http"], img[src^="/"])) img{ display:none; }

    /* ì´ë¯¸ì§€ê°€ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ ë‹¤í¬ ë°°ê²½ìœ¼ë¡œ ì „í™˜ */
    .preview-img:has(img[src^="data:"], img[src^="blob:"], img[src^="http"], img[src^="/"]){
      border-style:solid; background:#0b1220;
    }

    /* ë©”íƒ€ íŒ¨ë„ */
    .meta{
      background:#f8fafc; border:1px solid #e9eef6; border-radius:12px; padding:14px;
    }
    .meta .row + .row{ margin-top:8px; }
    .meta .key{ color:#6b7280; width:95px; }
    #resultPath{ word-break:break-all; }

    /* ë²„íŠ¼ */
    .btn-big{ padding:.9rem 1.1rem; font-weight:700; border-radius:12px; }

    /* ê¶Œí•œ ì œí•œ ë·° */
    .guard{ text-align:center; padding:48px 16px; color:#475467; }

    [data-bs-theme="dark"] .meta{
      background: rgba(15,23,42,0.6);      /* #0f172a ê³„ì—´ ë°˜íˆ¬ëª… */
      color: #e5e7eb;
      border-color: rgba(255,255,255,0.14);
    }
  </style>
</head>
<body>
  <!-- Navbar (ê³µí†µ) -->
  <div id="menu-container"></div>

  <section class="hero-section">
    <h1 class="hero-title">ì‹œí¬ë¦¿ ì‚°íƒ€</h1>
    <p class="hero-subtitle">ì‹œí¬ë¦¿ ì‚°íƒ€ê°€ ë˜ì–´ ê¹œì§ ì„ ë¬¼ì„ ë“±ë¡í•´ì¤˜! âœ¨<br>ë“±ë¡ëœ ì„ ë¬¼ì€ ì¹´ë“œ ì•¨ë²”ì„ ì „ë¶€ ëª¨ì€ ë‰´í”„ë¡œ ì¹œêµ¬ì—ê²Œ ëª°ë˜~ ì§ ! í•˜ê³  ì „ë‹¬ëœë‹µë‹ˆë‹¤ğŸ’</p>
  </section>

  <div class="container pb-5">
    <div id="guardView" class="glass-card p-4 guard d-none">
      <div class="mb-2">ì´ í˜ì´ì§€ëŠ” <b>ê´€ë¦¬ì ì „ìš©</b>ì…ë‹ˆë‹¤.</div>
      <div class="small text-muted mb-3">ê´€ë¦¬ì ê¶Œí•œì´ ìˆëŠ” ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</div>
    </div>

    <div id="app" class="glass-card p-3 p-md-4 d-none">
      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="badge text-bg-secondary">ğŸ… ì‚°íƒ€</span>
        <h5 class="mb-0">ì„ ë¬¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
        <!-- <div class="ms-auto small text-muted" id="whoami">â€”</div> -->
      </div>

      <!-- 1) íŒŒì¼ ì„ íƒ ì˜ì—­ -->
      <div class="dropzone mb-3" id="dropzone">
        <input id="fileInput" type="file" accept="image/*" />
        <div class="d-flex flex-column align-items-center gap-2">
          <i class="bi bi-cloud-arrow-up" style="font-size:2rem; color:#667085"></i>
          <div class="fw-semibold">ì´ë¯¸ì§€ë¥¼ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•´ì¤˜</div>
          <div class="text-muted small">PNG, JPG ê¶Œì¥ Â· ìµœëŒ€ 10MB</div>
          <button type="button" class="btn btn-outline-secondary btn-sm mt-1" id="chooseBtn">íŒŒì¼ ì„ íƒ</button>
        </div>
      </div>

      <!-- 2) ë¯¸ë¦¬ë³´ê¸° & ë©”íƒ€ -->
      <div class="preview-wrap mb-3">
        <div class="preview-img"><img id="previewImg" alt="preview" /></div>
        <div class="meta">
          <div class="row align-items-center mb-2">
            <div class="col-auto key">ì„ ë¬¼ì´ë¦„</div>
            <div class="col">
              <input type="text" class="form-control form-control-sm" id="giftNameInput"
                     placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸" />
            </div>
          </div>
      
          <div class="row"><div class="col-auto key">íŒŒì¼ëª…</div><div class="col" id="metaName">â€”</div></div>
          <div class="row"><div class="col-auto key">ìš©ëŸ‰</div><div class="col" id="metaSize">â€”</div></div>
          <div class="row"><div class="col-auto key">í¬ê¸°</div><div class="col" id="metaDim">â€”</div></div>
          <div class="row"><div class="col-auto key">MIME</div><div class="col" id="metaType">â€”</div></div>
          <div class="row d-none"><div class="col-auto key">eventId</div><div class="col" id="metaEventId">â€”</div></div>
          <div class="row d-none"><div class="col-auto key">ë¬¸ì„œ(ë£¨íŠ¸)</div><div class="col" id="metaDoc">â€”</div></div>
          <div class="row d-none"><div class="col-auto key">ë¬¸ì„œ(results)</div><div class="col" id="metaResultDoc">â€”</div></div>
          <div class="row d-none"><div class="col-auto key">ê²°ê³¼ ê²½ë¡œ</div><div class="col"><code id="resultPath">â€”</code></div></div>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-light btn-sm d-none" id="copyPathBtn" disabled>ê²½ë¡œ ë³µì‚¬</button>
            <button class="btn btn-outline-danger btn-sm" id="resetBtn">ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <!-- 3) ì•¡ì…˜ -->
      <div class="d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-secondary btn-big" id="cancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-big" id="uploadBtn" disabled>
          <span class="me-1">í™•ì¸</span><i class="bi bi-upload"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Common HTML -->
  <div id="common-html"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Firebase (ESM) -->
  <script type="module">    
    import { showLoader, showToast } from './common/common.js'
    import { auth, storage } from './common/firebase-init.js';
    import { onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-functions.js';
    import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-storage.js';

    // ------- UI helpers (ê³µí†µì´ ì—†ì„ ë•Œ ëŒ€ë¹„) -------
    const guardView = document.getElementById('guardView');
    const app = document.getElementById('app');

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');

    const previewImg = document.getElementById('previewImg');
    const metaName = document.getElementById('metaName');
    const metaSize = document.getElementById('metaSize');
    const metaDim  = document.getElementById('metaDim');
    const metaType = document.getElementById('metaType');
    const giftNameInput = document.getElementById('giftNameInput');
    const metaEventId = document.getElementById('metaEventId');
    const metaDoc = document.getElementById('metaDoc');
    const metaResultDoc = document.getElementById('metaResultDoc');
    const resultPath = document.getElementById('resultPath');
    const copyPathBtn = document.getElementById('copyPathBtn');

    const resetBtn = document.getElementById('resetBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const uploadBtn = document.getElementById('uploadBtn');

    // Firebase Functions (callable)
    const functions = getFunctions();
    const registerGiftcon = httpsCallable(functions, 'registerGiftcon');

    let admin = true;
    let selectedFile = null;
    let imgDim = null;

    // ------ ê¶Œí•œ ì²´í¬ (ADMIN_UIDë§Œ í—ˆìš©) ------
    onAuthStateChanged(auth, async (user) => {
      // if (!user) {        
      //   admin = false;
      //   guardView.classList.remove('d-none');
      //   app.classList.add('d-none');
      //   return;
      // }

      // const idTokenResult = await user.getIdTokenResult()
      // const claims = idTokenResult.claims;
      // admin = claims.admin ?? false;
      admin = true;
      if (admin) {
        guardView.classList.add('d-none');
        app.classList.remove('d-none');
      } else {
        guardView.classList.remove('d-none');
        app.classList.add('d-none');
        showToast('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´!');
      }
    });

    // ------ íŒŒì¼ ì„ íƒ & ë“œë˜ê·¸ ì²˜ë¦¬ ------
    chooseBtn.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault(); dropzone.classList.remove('dragover');
      const f = e.dataTransfer.files?.[0];
      if (f) handleFile(f);
    });
    fileInput.addEventListener('change', () => { const f = fileInput.files?.[0]; if (f) handleFile(f); });

    function handleFile(file){
      if (!file.type.startsWith('image/')) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ê°€ëŠ¥í•´!'); return; }
      if (file.size > 10 * 1024 * 1024) { showToast('íŒŒì¼ì´ ë„ˆë¬´ ì»¤ (ìµœëŒ€ 10MB)!'); return; }

      selectedFile = file;
      metaName.textContent = file.name;
      metaSize.textContent = prettyBytes(file.size);
      metaType.textContent = file.type;
      metaEventId.textContent = 'â€”';
      metaDoc.textContent = 'â€”';
      metaResultDoc.textContent = 'â€”';
      resultPath.textContent = 'â€”';
      copyPathBtn.disabled = true;

      const fr = new FileReader();
      fr.onload = () => {
        previewImg.src = fr.result;
        const img = new Image();
        img.onload = () => { imgDim = { w: img.width, h: img.height }; metaDim.textContent = `${img.width} Ã— ${img.height}`; };
        img.src = fr.result;
      };
      fr.readAsDataURL(file);

      uploadBtn.disabled = false;
    }

    function prettyBytes(bytes){
      const units = ['B','KB','MB','GB'];
      let i = 0; let v = bytes;
      while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
      return `${v.toFixed(1)} ${units[i]}`;
    }

    resetBtn.addEventListener('click', resetAll);
    cancelBtn.addEventListener('click', resetAll);

    function resetAll(){
      selectedFile = null; imgDim = null; fileInput.value = '';
      giftNameInput.value = '';
      previewImg.src = '';
      metaName.textContent = 'â€”'; metaSize.textContent = 'â€”'; metaDim.textContent = 'â€”'; metaType.textContent = 'â€”';
      metaEventId.textContent = 'â€”'; metaDoc.textContent = 'â€”'; metaResultDoc.textContent = 'â€”';
      resultPath.textContent = 'â€”'; copyPathBtn.disabled = true;
      uploadBtn.disabled = true;
    }

    copyPathBtn.addEventListener('click', async () => {
      const txt = resultPath.textContent.trim();
      if (!txt || txt === 'â€”') return;
      try { await navigator.clipboard.writeText(txt); showToast('ê²½ë¡œë¥¼ ë³µì‚¬í–ˆì–´!'); } catch {}
    });

    // ===== ê·œì¹™: eventId = YYYYMMDD-HHmmss, Storage: giftcons/{eventId}/{fileName}, Firestore ê¸°ë¡ì€ Callableì—ì„œ ì²˜ë¦¬ =====
    uploadBtn.addEventListener('click', onUpload);

    async function onUpload(){
      if (!selectedFile) { showToast('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜!'); return; }
      const user = auth.currentUser;
      if (!user) { showToast('ë¡œê·¸ì¸ë¶€í„° í•´ì¤˜!'); return; }
      if (!admin) { showToast('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´!'); return; }
      const raw = giftNameInput?.value?.trim();
      if(!raw) {
        showToast('ì„ ë¬¼ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
        return;
      }

      try {
        showLoader(true);

        const giftName = raw ? raw : null;        

        const eventId = generateEventId();
        const { fullPath } = await uploadToStorage(selectedFile, eventId, user.uid);

        const res = await registerGiftcon({ eventId, giftconPath: fullPath, giftName });
        const finalEventId = (res && res.data && res.data.eventId) ? res.data.eventId : eventId;

        // UI ë°˜ì˜
        metaEventId.textContent = finalEventId;
        metaDoc.textContent = `card_events/${finalEventId}`;
        metaResultDoc.textContent = `card_events/${finalEventId}/results/result`;
        resultPath.textContent = fullPath; // giftconPath (Storage ê²½ë¡œ)
        copyPathBtn.disabled = false;

        confetti({ particleCount: 80, spread: 70, origin: { y: .6 } });
        showToast('ì—…ë¡œë“œ & ê¸°ë¡ ì™„ë£Œ! âœ¨');
      } catch(e){
        console.error(e); showToast(e?.message || 'ì—…ë¡œë“œ/ê¸°ë¡ ì‹¤íŒ¨ ã… ã… ');
      } finally { showLoader(false); }
    }

    function generateEventId(){
      // ë¸Œë¼ìš°ì € ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ (KST í™˜ê²½ì—ì„œ ì‚¬ìš©)
      return moment().format('YYYYMMDD-HHmmss');
    }

    function sanitizeFileName(name){
      return (name || 'gift.png').replace(/[^a-zA-Z0-9._-]+/g, '_');
    }

    function buildStoragePath(file, eventId){
      const safe = sanitizeFileName(file.name);
      return `giftcons/${eventId}/${safe}`;
    }

    async function uploadToStorage(file, eventId, uid){
      const fullPath = buildStoragePath(file, eventId);
      const storageRef = ref(storage, fullPath);
      const meta = { contentType: file.type || 'image/png', customMetadata: {
        uploadedBy: uid,
        source: 'secret-gift-ui',
        width: String(imgDim?.w || ''),
        height: String(imgDim?.h || ''),
        eventId
      }};
      await uploadBytes(storageRef, file, meta);
      await getDownloadURL(storageRef); // í•„ìš” ì‹œ ì‚¬ìš©
      return { fullPath };
    }    
  </script>
</body>
</html>
