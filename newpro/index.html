<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="description" content="코딩은 모험이다! 뉴프로 커뮤니티에서 아이디어를 나누고, 즐거운 코드 토크를 펼쳐보세요!" />
  <meta name="keywords" content="코딩, 커뮤니티, 프로그래밍, 개발자, 뉴프로" />
  <meta name="author" content="프로그래밍 갤러리 위원회" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="뉴프로 커뮤니티" />
  <meta property="og:description" content="코딩은 모험이다! 뉴프로 커뮤니티에서 아이디어를 나누고, 즐거운 코드 토크를 펼쳐보세요!" />
  <title>뉴프로 커뮤니티</title>

  <!-- Google Font (Jua) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
    rel="stylesheet"
  />

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- Toast UI Editor: CSS/JS, 코드블록 하이라이트 플러그인 -->
  <link
    rel="stylesheet"
    href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
  />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <link
    rel="stylesheet"
    href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"
  />
  <script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.js"></script>

  <style>
    /* 남색 계열 그라디언트 배경 */
    body {
      background: linear-gradient(135deg, #1f2945, #2a4065);
      min-height: 100vh;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: rgba(10, 10, 20, 0.7) !important;
    }
    /* 상단 왼쪽 "뉴프로" 폰트 적용 */
    .navbar-brand {
      font-family: 'Jua', sans-serif;
      font-size: 1.8rem;
    }
    /* Hero 영역 */
    .hero-section {
      text-align: center;
      padding: 3rem 1rem;
      background: transparent;
    }
    .hero-title {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      color: #fff;
      font-family: 'Jua', sans-serif; 
    }
    .hero-subtitle {
      font-size: 1.25rem;
      opacity: 0.9;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
      color: #d5d9e0;
      font-family: 'Jua', sans-serif;
    }
    /* .glass-card: 반투명 흰색 배경 */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      color: #000; /* 카드 내부 텍스트 어두운색 */
    }
    /* 토스트 - 중앙 하단 / 어두운 배경 + 밝은 글자 */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .toast.dark-bg {
      background-color: rgba(0,0,0,0.8);
      color: #fff;
    }
    .toast.dark-bg .toast-header {
      background-color: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }
    .toast.dark-bg .btn-close {
      filter: invert(1);
    }
    /* 숨김 상태 */
    .d-none {
      display: none !important;
    }
    /* 모달 내용은 흰 배경 + 검정 텍스트 (가독성) */
    .modal-content {
      background-color: #fff !important;
      color: #000 !important;
    }
    /* 댓글 영역 스타일 */
    .comment-item {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      color: #000;
    }
    /* 작성자+시간 겹침 방지 (flex-wrap) */
    .post-subtitle {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    /* 로딩 시 회전 애니메이션 */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* 로딩 버튼에 적용할 클래스 */
    .auth-loading {
      animation: spin 1.0s linear infinite;
    }

    #postList img {
      max-width: 100%;
      height: auto;
      /* 필요시 display: block; margin: 0 auto; 로 가운데 정렬 */
    }
  </style>
</head>
<body>
  <!-- 네비게이션 바 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand fw-bold">뉴프로</span>
      <div class="ms-auto">
        <!-- 로딩중 상태를 보여줄 임시 버튼 (처음에만 보임) -->
        <button class="btn btn-outline-light me-2 auth-loading" id="authLoadingBtn">
          로딩중...
        </button>

        <!-- 로그인/회원가입/로그아웃 버튼들 (초기에 숨김) -->
        <button class="btn btn-outline-light me-2 d-none" id="loginBtn" data-bs-toggle="modal" data-bs-target="#loginModal">
          로그인
        </button>
        <button class="btn btn-success me-2 d-none" id="signupBtn" data-bs-toggle="modal" data-bs-target="#signupModal">
          회원가입
        </button>
        <button class="btn btn-danger d-none" id="logoutBtn">로그아웃</button>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <h1 class="hero-title">코딩은 모험이다!</h1>
    <p class="hero-subtitle">
      뉴프로 커뮤니티에서 아이디어를 마음껏 나누고, 즐거운 코드 토크를 펼쳐보세요!
    </p>
  </section>

  <!-- 메인 컨테이너 -->
  <div class="container mb-5">
    <!-- 글 목록 카드 상단에 "글쓰기" 버튼 (로그인 시에만 표시) -->
    <div class="d-flex justify-content-end mb-2">
      <button class="btn btn-light d-none" id="togglePostFormBtn">글쓰기</button>
    </div>

    <!-- 글쓰기 카드 (기본 숨김) -->
    <div class="card glass-card p-3 d-none" id="postCard">
      <div class="card-body">
        <h5 class="card-title">새 글 작성</h5>
        <div class="mb-3">
          <label for="postTitle" class="form-label">제목</label>
          <input
            type="text"
            class="form-control"
            id="postTitle"
            placeholder="제목을 입력하세요"
          />
        </div>
        <div class="mb-3">
          <label for="editor" class="form-label">내용</label>
          <!-- Toast UI Editor 삽입 영역 -->
          <div id="editor"></div>
        </div>
        <button class="btn btn-primary mt-2" id="savePostBtn">글 저장하기</button>
      </div>
    </div>

    <!-- 글 목록 카드 -->
    <div class="card glass-card mt-4">
      <div class="card-body">
        <h4 class="card-title">글 목록</h4>
        <div id="postList" class="mt-3">
          <!-- 처음 5개 불러오기 -> 스크롤 시 다음 5개 ... -->
        </div>
      </div>
    </div>
  </div>

  <!-- [수정 모달] -->
  <div
    class="modal fade"
    id="editModal"
    tabindex="-1"
    aria-labelledby="editModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">글 수정</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editPostId" />
          <div class="mb-3">
            <label for="editTitle" class="form-label">제목</label>
            <input
              type="text"
              class="form-control"
              id="editTitle"
              placeholder="제목을 입력하세요"
            />
          </div>
          <div class="mb-3">
            <label for="editContentEditor" class="form-label">내용</label>
            <!-- Toast UI Editor 수정용 영역 -->
            <div id="editContentEditor"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            닫기
          </button>
          <button type="button" class="btn btn-success" id="updatePostBtn">
            수정하기
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- [댓글 삭제 확인 모달] -->
  <div
    class="modal fade"
    id="deleteCommentModal"
    tabindex="-1"
    aria-labelledby="deleteCommentModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCommentModalLabel">댓글 삭제</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>해당 댓글을 삭제하시겠습니까?</p>
          <input type="hidden" id="deleteCommentPostId" />
          <input type="hidden" id="deleteCommentId" />
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            닫기
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteCommentBtn">
            삭제
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 회원가입 모달 -->
  <div
    class="modal fade"
    id="signupModal"
    tabindex="-1"
    aria-labelledby="signupModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="signupForm">
          <div class="modal-header">
            <h5 class="modal-title" id="signupModalLabel">회원가입</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="signupEmail" class="form-label">이메일</label>
              <input
                type="email"
                class="form-control"
                id="signupEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label for="signupPassword" class="form-label">비밀번호</label>
              <input
                type="password"
                class="form-control"
                id="signupPassword"
                required
              />
            </div>
            <div class="mb-3">
              <label for="signupNickname" class="form-label">닉네임</label>
              <input
                type="text"
                class="form-control"
                id="signupNickname"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button type="submit" class="btn btn-success">회원가입</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 로그인 모달 -->
  <div
    class="modal fade"
    id="loginModal"
    tabindex="-1"
    aria-labelledby="loginModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">로그인</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">이메일</label>
              <input
                type="email"
                class="form-control"
                id="loginEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">비밀번호</label>
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button type="submit" class="btn btn-primary">로그인</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast (중앙 하단, 어두운 배경+밝은 글자) -->
  <div class="toast-container">
    <div
      id="liveToast"
      class="toast align-items-center dark-bg"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">알림</strong>
        <small class="text-muted" id="toastTime"></small>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
      <div class="toast-body" id="toastMessage">
        메시지 내용
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (Popper 포함) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase ES Modules -->
  <script type="module">
    /********************************
     * Firebase Import & Init
     ********************************/
    import {
      initializeApp
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js';

    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';

    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      serverTimestamp,
      arrayUnion,
      arrayRemove,
      query,
      orderBy,
      getDocs,
      startAfter,
      limit
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';

    // Firebase 설정 (사용자의 firebaseConfig로 교체)
    const firebaseConfig = {
      apiKey: "AIzaSyC-etI5o4uWbBp2Arj9KpxdDyRebguErnY",
      authDomain: "newpro-4bc73.firebaseapp.com",
      projectId: "newpro-4bc73",
      storageBucket: "newpro-4bc73.firebasestorage.app",
      messagingSenderId: "267192611563",
      appId: "1:267192611563:web:94fb5ec97872cd452a84ae"
    };

    // 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /********************************
     * Toast UI Editor 초기화
     ********************************/
    const { Editor } = toastui;
    const { codeSyntaxHighlight } = Editor.plugin;

    // "글쓰기"용 에디터
    let createEditor = new Editor({
      el: document.querySelector('#editor'),
      // height: '200px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });

    // "수정" 모달 에디터
    let editEditor = new Editor({
      el: document.querySelector('#editContentEditor'),
      // height: '200px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });

    /********************************
     * 날짜/시간 포맷팅
     ********************************/
    function formatDateTime(timestamp) {
      if (!timestamp || !timestamp.seconds) return '';
      const date = new Date(timestamp.seconds * 1000);

      let year = date.getFullYear();
      let month = date.getMonth() + 1;
      let day = date.getDate();

      let hours = date.getHours();
      let minutes = date.getMinutes();
      let seconds = date.getSeconds();

      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours === 0 ? 12 : hours;

      minutes = minutes.toString().padStart(2, '0');
      seconds = seconds.toString().padStart(2, '0');

      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    function formatDateForToast(date) {
      let year = date.getFullYear();
      let month = date.getMonth() + 1;
      let day = date.getDate();

      let hours = date.getHours();
      let minutes = date.getMinutes();
      let seconds = date.getSeconds();

      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours === 0 ? 12 : hours;

      minutes = minutes.toString().padStart(2, '0');
      seconds = seconds.toString().padStart(2, '0');

      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    /********************************
     * Toast 함수
     ********************************/
    function showToast(message, title = '알림') {
      const toastEl = document.getElementById('liveToast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastTime = document.getElementById('toastTime');

      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toastTime.textContent = formatDateForToast(new Date());

      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
    }

    /********************************
     * DOM 요소 참조
     ********************************/
    const authLoadingBtn = document.getElementById('authLoadingBtn');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // 글쓰기 버튼
    const togglePostFormBtn = document.getElementById('togglePostFormBtn');
    const postCard = document.getElementById('postCard');
    const savePostBtn = document.getElementById('savePostBtn');

    const postList = document.getElementById('postList');

    // 회원가입
    const signupForm = document.getElementById('signupForm');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupNickname = document.getElementById('signupNickname');

    // 로그인
    const loginForm = document.getElementById('loginForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');

    // 글 작성
    const postTitle = document.getElementById('postTitle');

    // 수정 모달
    const editModalEl = document.getElementById('editModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const editPostId = document.getElementById('editPostId');
    const editTitle = document.getElementById('editTitle');
    const updatePostBtn = document.getElementById('updatePostBtn');

    // 댓글 삭제 모달
    const deleteCommentModalEl = document.getElementById('deleteCommentModal');
    const deleteCommentModal = new bootstrap.Modal(deleteCommentModalEl);
    const deleteCommentPostId = document.getElementById('deleteCommentPostId');
    const deleteCommentId = document.getElementById('deleteCommentId');
    const confirmDeleteCommentBtn = document.getElementById('confirmDeleteCommentBtn');

    /********************************
     * 닉네임 로딩
     ********************************/
    let currentNickname = null;
    async function fetchUserNickname(uid) {
      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        return snap.data().nickname || null;
      }
      return null;
    }

    /********************************
     * 회원가입
     ********************************/
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = signupEmail.value.trim();
      const pwVal = signupPassword.value.trim();
      const nickVal = signupNickname.value.trim();

      if (!emailVal || !pwVal || !nickVal) {
        showToast('모든 항목을 입력하세요.', '회원가입 실패');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, emailVal, pwVal);
        const user = userCredential.user;
        // Firestore에 닉네임 저장
        await setDoc(doc(db, 'users', user.uid), {
          nickname: nickVal,
          createdAt: serverTimestamp()
        });
        showToast('회원가입 성공!', '회원가입');

        // 모달 닫기
        bootstrap.Modal.getInstance(signupModal).hide();
      } catch (err) {
        showToast(err.message, '회원가입 실패');
      }
    });

    /********************************
     * 로그인
     ********************************/
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = loginEmail.value.trim();
      const pwVal = loginPassword.value.trim();

      if (!emailVal || !pwVal) {
        showToast('이메일/비밀번호를 입력하세요.', '로그인 실패');
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, emailVal, pwVal);
        showToast('로그인 성공!', '로그인');
        // 모달 닫기
        bootstrap.Modal.getInstance(loginModal).hide();
      } catch (err) {
        showToast(err.message, '로그인 실패');
      }
    });

    /********************************
     * 로그아웃
     ********************************/
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('로그아웃 완료', '로그아웃');
      } catch (error) {
        showToast(error.message, '로그아웃 실패');
      }
    });

    /********************************
     * Auth 상태 감지 -> UI 업데이트
     ********************************/
    onAuthStateChanged(auth, async (user) => {
      // 로딩 버튼은 숨긴다
      authLoadingBtn.classList.add('d-none');

      if (user) {
        // 로그인됨
        loginBtn.classList.add('d-none');
        signupBtn.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
        togglePostFormBtn.classList.remove('d-none');

        currentNickname = await fetchUserNickname(user.uid);
      } else {
        // 로그아웃됨
        loginBtn.classList.remove('d-none');
        signupBtn.classList.remove('d-none');
        logoutBtn.classList.add('d-none');
        togglePostFormBtn.classList.add('d-none');
        postCard.classList.add('d-none');

        currentNickname = null;
      }
    });

    /********************************
     * 글쓰기 버튼 토글
     ********************************/
    togglePostFormBtn.addEventListener('click', () => {
      if (postCard.classList.contains('d-none')) {
        postCard.classList.remove('d-none');
      } else {
        postCard.classList.add('d-none');
      }
    });

    /********************************
     * 글 작성
     ********************************/
    savePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      if (!currentNickname) {
        showToast('닉네임을 불러오지 못했습니다.', '오류');
        return;
      }

      const titleVal = postTitle.value.trim();
      const contentVal = createEditor ? createEditor.getHTML() : '';

      if (!titleVal) {
        showToast('제목을 입력하세요.', '오류');
        return;
      }
      if (!contentVal.trim()) {
        showToast('내용을 입력하세요.', '오류');
        return;
      }

      try {
        await addDoc(collection(db, 'posts'), {
          uid: user.uid,
          nickname: currentNickname,
          title: titleVal,
          content: contentVal,
          createdAt: serverTimestamp(),
          likes: [],
          dislikes: []
        });

        showToast('글이 등록되었습니다.', '글 작성');

        // 에디터 & 제목 초기화
        postTitle.value = '';
        createEditor.setHTML('');

        // 글쓰기 카드 접기
        postCard.classList.add('d-none');

        // 목록 리셋 & 다시 가져오기
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, '글 작성 실패');
      }
    });

    /********************************
     * 글 수정 모달 열기
     ********************************/
    async function openEditModal(postDoc) {
      editPostId.value = postDoc.id;
      editTitle.value = postDoc.data().title;
      if (editEditor) {
        editEditor.setHTML(postDoc.data().content);
      }
      editModal.show();
    }

    /********************************
     * 글 수정 (여기에서 목록 리로드)
     ********************************/
    updatePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      const docId = editPostId.value;
      const newTitle = editTitle.value.trim();
      const newContent = editEditor ? editEditor.getHTML() : '';

      if (!newTitle || !newContent.trim()) {
        showToast('제목과 내용을 입력하세요.', '오류');
        return;
      }

      try {
        const postRef = doc(db, 'posts', docId);
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) {
          showToast('존재하지 않는 글입니다.', '오류');
          return;
        }
        if (postSnap.data().uid !== user.uid) {
          showToast('본인 글만 수정할 수 있습니다.', '오류');
          return;
        }

        // Firestore 데이터 업데이트
        await updateDoc(postRef, {
          title: newTitle,
          content: newContent
        });

        showToast('글이 수정되었습니다.', '성공');
        editModal.hide();

        // 수정 직후 목록 갱신
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();

      } catch (err) {
        showToast(err.message, '수정 실패');
      }
    });

    /********************************
     * 글 삭제
     ********************************/
    async function deletePost(postDoc) {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      const postData = postDoc.data();
      if (postData.uid !== user.uid) {
        showToast('본인 글만 삭제할 수 있습니다.', '오류');
        return;
      }
      if (!confirm('이 글을 삭제하시겠습니까?')) {
        return;
      }
      try {
        await deleteDoc(postDoc.ref);
        showToast('글이 삭제되었습니다.', '삭제');

        // 목록 리로드
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, '삭제 실패');
      }
    }

    /********************************
     * 댓글 추가
     ********************************/
    async function addComment(postId, content) {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      if (!content.trim()) {
        showToast('댓글 내용을 입력하세요.', '오류');
        return;
      }
      if (!currentNickname) {
        showToast('닉네임을 불러오지 못했습니다.', '오류');
        return;
      }

      try {
        await addDoc(collection(db, 'posts', postId, 'comments'), {
          uid: user.uid,
          nickname: currentNickname,
          content,
          createdAt: serverTimestamp()
        });
        showToast('댓글이 등록되었습니다.', '댓글 작성');
      } catch (err) {
        showToast(err.message, '댓글 등록 실패');
      }
    }

    /********************************
     * 댓글 삭제 모달 열기
     ********************************/
    function openDeleteCommentModal(postId, commentId) {
      deleteCommentPostId.value = postId;
      deleteCommentId.value = commentId;
      deleteCommentModal.show();
    }

    confirmDeleteCommentBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      const postId = deleteCommentPostId.value;
      const commentId = deleteCommentId.value;
      try {
        const commentRef = doc(db, 'posts', postId, 'comments', commentId);
        const commentSnap = await getDoc(commentRef);
        if (!commentSnap.exists()) {
          showToast('존재하지 않는 댓글입니다.', '오류');
          return;
        }
        if (commentSnap.data().uid !== user.uid) {
          showToast('본인 댓글만 삭제할 수 있습니다.', '오류');
          return;
        }
        await deleteDoc(commentRef);
        showToast('댓글이 삭제되었습니다.', '댓글 삭제');
        deleteCommentModal.hide();
      } catch (err) {
        showToast(err.message, '댓글 삭제 실패');
      }
    });

    /********************************
     * 댓글 목록 렌더링
     ********************************/
    function renderComments(postId, comments, containerEl) {
      const commentHeaderEl = document.getElementById(`commentHeader-${postId}`);
      if (commentHeaderEl) {
        if (comments.length === 0) {
          commentHeaderEl.classList.add('d-none');
        } else {
          commentHeaderEl.classList.remove('d-none');
        }
      }

      containerEl.innerHTML = '';
      comments.forEach((c) => {
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `
          <div class="fw-bold">${c.nickname || '익명'}</div>
          <div class="small text-muted mb-1">
            ${formatDateTime(c.createdAt)}
          </div>
          <div>${c.content}</div>
        `;
        if (auth.currentUser && auth.currentUser.uid === c.uid) {
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-danger ms-2';
          delBtn.textContent = '삭제';
          delBtn.addEventListener('click', () => {
            openDeleteCommentModal(postId, c.commentId);
          });
          div.appendChild(delBtn);
        }
        containerEl.appendChild(div);
      });
    }

    /********************************
     * 좋아요/싫어요 (중복 클릭 방지)
     ********************************/
    let likeDislikeInProgress = new Set();

    async function toggleLike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);

      try {
        const postRef = doc(db, 'posts', postId);
        const snapshot = await getDoc(postRef);
        if (!snapshot.exists()) return;

        const data = snapshot.data();
        const likes = data.likes || [];
        const dislikes = data.dislikes || [];

        if (likes.includes(user.uid)) {
          // 좋아요 해제
          await updateDoc(postRef, {
            likes: arrayRemove(user.uid)
          });
        } else {
          // 좋아요 추가
          const updates = { likes: arrayUnion(user.uid) };
          if (dislikes.includes(user.uid)) {
            updates.dislikes = arrayRemove(user.uid);
          }
          await updateDoc(postRef, updates);
        }
      } catch (err) {
        showToast(err.message, '오류');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }

    async function toggleDislike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('로그인이 필요합니다.', '오류');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);

      try {
        const postRef = doc(db, 'posts', postId);
        const snapshot = await getDoc(postRef);
        if (!snapshot.exists()) return;

        const data = snapshot.data();
        const likes = data.likes || [];
        const dislikes = data.dislikes || [];

        if (dislikes.includes(user.uid)) {
          // 싫어요 해제
          await updateDoc(postRef, {
            dislikes: arrayRemove(user.uid)
          });
        } else {
          // 싫어요 추가
          const updates = { dislikes: arrayUnion(user.uid) };
          if (likes.includes(user.uid)) {
            updates.likes = arrayRemove(user.uid);
          }
          await updateDoc(postRef, updates);
        }
      } catch (err) {
        showToast(err.message, '오류');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }

    /********************************
     * 개별 글 DOM 생성 함수
     ********************************/
    function createPostItem(docSnap) {
      const data = docSnap.data();
      const postId = docSnap.id;

      const card = document.createElement('div');
      card.className = 'card mb-3';

      let isAuthor = false;
      if (auth.currentUser && auth.currentUser.uid === data.uid) {
        isAuthor = true; 
      }

      // 좋아요/싫어요 초기값
      const likeCount = data.likes ? data.likes.length : 0;
      const dislikeCount = data.dislikes ? data.dislikes.length : 0;

      // 카드 내용
      card.innerHTML = `
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>${data.title}</span>
          ${
            isAuthor
              ? `
                <div>
                  <button class="btn btn-sm btn-warning me-2" id="editBtn-${postId}">수정</button>
                  <button class="btn btn-sm btn-danger" id="deleteBtn-${postId}">삭제</button>
                </div>
              `
              : ''
          }
        </div>
        <div class="card-body">
          <h6 class="card-subtitle text-muted mb-2 post-subtitle">
            <span>작성자: ${data.nickname || '익명'}</span>
            <span>${formatDateTime(data.createdAt)}</span>
          </h6>
          <div class="card-text mt-2">${data.content}</div>
          
          <!-- 추천/비추천 -->
          <div class="mt-3 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-primary" id="likeBtn-${postId}">👍</button>
            <span id="likeCount-${postId}">${likeCount}</span>
            <button class="btn btn-sm btn-outline-danger" id="dislikeBtn-${postId}">👎</button>
            <span id="dislikeCount-${postId}">${dislikeCount}</span>
          </div>

          <!-- 댓글 리스트 -->
          <div class="mt-3">
            <h6 id="commentHeader-${postId}">댓글</h6>
            <div id="commentList-${postId}"></div>
          </div>

          <!-- 댓글 작성 폼 (로그인 시만 보이게) -->
          <div class="mt-2 d-none" id="commentForm-${postId}">
            <textarea class="form-control mb-2" rows="2" placeholder="댓글을 입력하세요" id="commentInput-${postId}"></textarea>
            <button class="btn btn-secondary" id="commentBtn-${postId}">댓글 달기</button>
          </div>
        </div>
      `;

      // 수정/삭제 버튼
      if (isAuthor) {
        const editBtn = card.querySelector(`#editBtn-${postId}`);
        editBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) {
            openEditModal(postSnap);
          } else {
            showToast('글 정보를 불러오지 못했습니다.', '오류');
          }
        });

        const deleteBtn = card.querySelector(`#deleteBtn-${postId}`);
        deleteBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) {
            await deletePost(postSnap);
          }
        });
      }

      // 좋아요/싫어요
      const likeBtn = card.querySelector(`#likeBtn-${postId}`);
      likeBtn.addEventListener('click', () => {
        toggleLike(postId);
      });

      const dislikeBtn = card.querySelector(`#dislikeBtn-${postId}`);
      dislikeBtn.addEventListener('click', () => {
        toggleDislike(postId);
      });

      // 이미 좋아요/싫어요했는지에 따른 버튼 색상
      if (auth.currentUser) {
        if (data.likes?.includes(auth.currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        }
        if (data.dislikes?.includes(auth.currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        }
      }

      // 댓글 작성 폼 (로그인 상태에서만)
      const commentListEl = card.querySelector(`#commentList-${postId}`);
      const commentFormEl = card.querySelector(`#commentForm-${postId}`);
      const commentInputEl = card.querySelector(`#commentInput-${postId}`);
      const commentBtn = card.querySelector(`#commentBtn-${postId}`);

      if (auth.currentUser) {
        commentFormEl.classList.remove('d-none');
      }

      commentBtn.addEventListener('click', () => {
        const text = commentInputEl.value.trim();
        addComment(postId, text);
        commentInputEl.value = '';
      });

      return card;
    }

    /********************************
     * 실시간 글 UI 갱신
     ********************************/
    function updatePostUI(postSnap) {
      const postId = postSnap.id;
      const data = postSnap.data();

      // 좋아요/싫어요
      const likeCountEl = document.getElementById(`likeCount-${postId}`);
      const dislikeCountEl = document.getElementById(`dislikeCount-${postId}`);
      if (likeCountEl) likeCountEl.textContent = data.likes?.length || 0;
      if (dislikeCountEl) dislikeCountEl.textContent = data.dislikes?.length || 0;

      // 버튼 색상
      const likeBtn = document.getElementById(`likeBtn-${postId}`);
      const dislikeBtn = document.getElementById(`dislikeBtn-${postId}`);
      if (likeBtn && dislikeBtn && auth.currentUser) {
        if (data.likes?.includes(auth.currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        } else {
          likeBtn.classList.remove('btn-primary');
          likeBtn.classList.add('btn-outline-primary');
        }
        if (data.dislikes?.includes(auth.currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        } else {
          dislikeBtn.classList.remove('btn-danger');
          dislikeBtn.classList.add('btn-outline-danger');
        }
      }

      // (추가) 제목이나 내용이 바뀐 경우 즉시 반영하고 싶으면 아래 로직도 가능
      // const titleHeader = document.querySelector(`#editBtn-${postId}`)?.closest('.card-header')?.querySelector('span');
      // if (titleHeader) {
      //   titleHeader.textContent = data.title;
      // }
      // const contentBody = document.querySelector(`#likeBtn-${postId}`)?.closest('.card-body')?.querySelector('.card-text');
      // if (contentBody) {
      //   contentBody.innerHTML = data.content;
      // }
    }

    /********************************
     * 무한 스크롤 -> 5개씩 조회
     ********************************/
    let lastVisible = null;
    let isLoading = false;
    const PAGE_SIZE = 5;

    async function loadMorePosts() {
      if (isLoading) return;
      isLoading = true;

      let q = query(
        collection(db, 'posts'),
        orderBy('createdAt', 'desc'),
        limit(PAGE_SIZE)
      );

      if (lastVisible) {
        q = query(
          collection(db, 'posts'),
          orderBy('createdAt', 'desc'),
          startAfter(lastVisible),
          limit(PAGE_SIZE)
        );
      }

      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        let newLastDoc = null;

        snapshot.forEach((docSnap) => {
          // 글 DOM 생성
          const item = createPostItem(docSnap);
          postList.appendChild(item);

          // 각 글에 대한 실시간 onSnapshot
          onSnapshot(doc(db, 'posts', docSnap.id), (updatedSnap) => {
            if (updatedSnap.exists()) {
              updatePostUI(updatedSnap);
            }
          });

          // 댓글 실시간
          const cmtQuery = query(
            collection(db, 'posts', docSnap.id, 'comments'),
            orderBy('createdAt', 'asc')
          );
          onSnapshot(cmtQuery, (cmtSnapshot) => {
            const cmtData = [];
            cmtSnapshot.forEach((cmtDoc) => {
              const cdata = cmtDoc.data();
              cdata.commentId = cmtDoc.id;
              cmtData.push(cdata);
            });
            const commentListEl = document.querySelector(`#commentList-${docSnap.id}`);
            if (commentListEl) {
              renderComments(docSnap.id, cmtData, commentListEl);
            }
          });

          newLastDoc = docSnap;
        });

        // 마지막 문서 갱신
        lastVisible = newLastDoc;
      }

      isLoading = false;
    }

    // 스크롤 바닥 부근 -> 다음 5개 로드
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadMorePosts();
      }
    });

    // 페이지 처음 진입 시 5개 로드
    loadMorePosts();
  </script>
</body>
</html>
