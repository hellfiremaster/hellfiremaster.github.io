<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="description" content="ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤! ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!" />
  <meta name="keywords" content="ì½”ë”©, ì»¤ë®¤ë‹ˆí‹°, í”„ë¡œê·¸ë˜ë°, ê°œë°œì, ë‰´í”„ë¡œ" />
  <meta name="author" content="í”„ë¡œê·¸ë˜ë° ê°¤ëŸ¬ë¦¬ ìœ„ì›íšŒ" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°" />
  <meta property="og:description" content="ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤! ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!" />
  <title>ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°</title>

  <!-- Google Font (Jua) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
    rel="stylesheet"
  />
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- Toast UI Editor: CSS/JS, ì½”ë“œë¸”ë¡ í•˜ì´ë¼ì´íŠ¸ í”ŒëŸ¬ê·¸ì¸ -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <link rel="stylesheet" href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />
  <script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.js"></script>

  <!-- DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.3/purify.min.js" integrity="sha512-Ll+TuDvrWDNNRnFFIM8dOiw7Go7dsHyxRp4RutiIFW/wm3DgDmCnRZow6AqbXnCbpWu93yM1O34q+4ggzGeXVA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* ê¸°ë³¸ ë°°ê²½ ë° ê¸€ê¼´ ë“± */
    body {
      background: linear-gradient(135deg, #1f2945, #2a4065);
      min-height: 100vh;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: rgba(10, 10, 20, 0.7) !important;
    }
    .navbar-brand {
      font-family: 'Jua', sans-serif;
      font-size: 1.8rem;
    }
    .hero-section {
      text-align: center;
      padding: 3rem 1rem;
      background: transparent;
    }
    .hero-title {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      color: #fff;
      font-family: 'Jua', sans-serif;
    }
    .hero-subtitle {
      font-size: 1.25rem;
      opacity: 0.9;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
      color: #d5d9e0;
      font-family: 'Jua', sans-serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      color: #000;
    }
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .toast.dark-bg {
      background-color: rgba(0,0,0,0.8);
      color: #fff;
    }
    .toast.dark-bg .toast-header {
      background-color: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }
    .toast.dark-bg .btn-close {
      filter: invert(1);
    }
    .d-none {
      display: none !important;
    }
    .modal-content {
      background-color: #fff !important;
      color: #000 !important;
    }
    .comment-item {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      color: #000;
    }
    .post-subtitle {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .auth-loading {
      animation: spin 1.0s linear infinite;
    }
    #postList img {
      max-width: 100%;
      height: auto;
    }
    .shining-btn {
      position: relative;
      overflow: hidden;
      background-color: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 5px;
      box-shadow: 0 0 8px rgba(255,105,180, 0.6);
      font-weight: bold;
      cursor: pointer;
    }
    .shining-btn::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.7) 0%,
        rgba(255, 255, 255, 0) 40%,
        rgba(255, 255, 255, 0) 60%,
        rgba(255, 255, 255, 0.7) 100%
      );
      animation: shine 2.5s infinite;
      transform: rotate(0deg);
    }
    @keyframes shine {
      0% {
        transform: translate(-100%, -100%);
      }
      50% {
        transform: translate(100%, 100%);
      }
      100% {
        transform: translate(-100%, -100%);
      }
    }
    .keep-line-breaks {
      white-space: pre-line;
    }
    .notice-banner {
      background: linear-gradient(130deg, #002f2f, #004a3f);
      border: 1px solid #0a7f5f;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      color: #69ffa2;
      font-weight: bold;
      text-shadow: 0 0 5px #69ffa2, 0 0 10px #69ffa2;
      transition: filter 0.3s;
      cursor: pointer;
    }
    .notice-banner:hover {
      filter: brightness(1.2);
    }
    .notice-banner p {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .video-responsive {
      position: relative;
      width: 560px;
      max-width: 100%;
      margin: 1rem 0;
    }
    .video-responsive::before {
      content: "";
      display: block;
      padding-top: 56.25%;
    }
    .video-responsive iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      border: 0;
    }
    .magic-btn {
      position: relative;
      overflow: hidden;
      color: #000;
      border-radius: 5px;
      margin-left: 5px;
      padding: 2px 6px;
      transition: box-shadow 0.3s;
    }
    .magic-btn:hover {
      box-shadow: 0 0 8px 2px rgba(255, 215, 0, 0.8);
    }
    .magic-btn:disabled {
      border: none !important;
      box-shadow: none !important;
    }
    .magic-shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.1) 100%);
      background-size: 200% auto;
      animation: shimmer 1.5s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% center; }
      100% { background-position: -200% center; }
    }
    .magic-blessing {
      background: linear-gradient(45deg, rgba(255,215,0,0.4), rgba(255,215,0,0.8));
      animation: blessingPulse 2s ease-in-out infinite;
    }
    @keyframes blessingPulse {
      0%, 100% { box-shadow: 0 0 10px 2px rgba(255,215,0,0.8); }
      50% { box-shadow: 0 0 20px 4px rgba(255,215,0,1); }
    }
    .magic-curse {
      filter: invert(1) blur(2px);
    }
    .magic-font {
      font-family: 'Comic Neue', cursive, sans-serif !important;
      color: #d9534f;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .magic-title {
      direction: rtl;
      unicode-bidi: bidi-override;
    }
    .magic-rainbow {
      background: linear-gradient(45deg,
        rgba(255, 0, 0, 0.4),
        rgba(255, 165, 0, 0.4),
        rgba(255, 255, 0, 0.4),
        rgba(0, 128, 0, 0.4),
        rgba(0, 0, 255, 0.4),
        rgba(75, 0, 130, 0.4),
        rgba(238, 130, 238, 0.4)
      );
      animation: rainbowPulse 2s ease-in-out infinite;
    }
    @keyframes rainbowPulse {
      0%, 100% {
        box-shadow: 0 0 10px 2px rgba(255, 0, 0, 0.8);
      }
      50% {
        box-shadow: 0 0 20px 4px rgba(238, 130, 238, 1);
      }
    }
    .magic-ultimate {
      background: radial-gradient(circle, rgba(255,215,0,0.4), rgba(255,215,0,0.2), rgba(0,0,0,0));
      animation: ultimateGlow 30s infinite, pulseGlow 2s infinite, borderGlow 2s infinite;
      border: 3px solid #ff595e;
      box-shadow: 0 0 10px 5px #ff595e;
    }

    @keyframes ultimateGlow {
      0%   { transform: scale(0.9) rotate(-10deg); }
      25%   { transform: scale(0.9) rotate(360deg); }
      50%  { transform: scale(1.1) rotate(10deg); }
      50%  { transform: scale(1.25) rotate(10deg); }
      100% { transform: scale(0.9) rotate(-10deg); }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px 5px rgba(255,215,0,0.7); }
      50% { box-shadow: 0 0 20px 10px rgba(255,215,0,1); }
    }

    @keyframes borderGlow {
      0% { border-color: #ff595e; box-shadow: 0 0 10px 5px #ff595e; }
      25% { border-color: #ffca3a; box-shadow: 0 0 10px 5px #ffca3a; }
      50% { border-color: #8ac926; box-shadow: 0 0 10px 5px #8ac926; }
      75% { border-color: #1982c4; box-shadow: 0 0 10px 5px #1982c4; }
      100% { border-color: #ff595e; box-shadow: 0 0 10px 5px #ff595e; }
    }

    .magic-basic {
      animation: basicGlow 2s infinite;
    }
    @keyframes basicGlow {
      0% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
      50% { box-shadow: 0 0 15px rgba(0, 255, 255, 1); }
      100% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
    }
    @media (max-width: 576px) {
      .action-buttons {
        margin-left: auto;
        text-align: right;
        display: flex;
        gap: 0.1rem;
      }
    }

    /* ì¢‹ì•„ìš”(ì¶”ì²œ) ë²„íŠ¼ íƒ€ì˜¤ë¥´ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes likeFlame {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); /* íŒŒë€ìƒ‰ (Bootstrap primary ìƒ‰ìƒ ê³„ì—´) */
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 10px 6px rgba(0, 123, 255, 0.4);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
      }
    }
    .like-flame {
      animation: likeFlame 0.5s ease-in-out;
    }
    .adventure {
      font-family: 'Jua', sans-serif !important;
    }

    @keyframes burningAnimation {
      0% {
        filter: brightness(1) drop-shadow(0 0 5px rgba(255, 69, 0, 0.8));
      }
      50% {
        filter: brightness(1) drop-shadow(0 0 15px rgba(255, 69, 0, 1));
      }
      100% {
        filter: brightness(1) drop-shadow(0 0 5px rgba(255, 69, 0, 0.8));
      }
    }
    .burning {
      animation: burningAnimation 1.5s infinite;
    }

    /* ë‹¨ì¼ ì´ëª¨ì§€ì¼ ê²½ìš° í¬ê²Œ ë³´ì´ë„ë¡ í•˜ëŠ” CSS */
    .emoji-large {
      font-size: 4rem; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì • */
      line-height: 1;
    }

    /* Toast UI Editor ì»¨í…ì¸ ì˜ ê¸°ë³¸ ê¸€ì”¨ í¬ê¸°ë¥¼ 18pxë¡œ ì„¤ì • */
    .toastui-editor-contents {
      font-size: 16px;
    }

  /* í€´ì¦ˆ ì¹´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
  .quiz-card {
    border: 2px solid #4CAF50;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }
  .quiz-card .card-title {
    color: #4CAF50;
  }
  .quiz-option {
    margin: 0.3rem;
  }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand fw-bold">ë‰´í”„ë¡œ</span>
      <div class="ms-auto">
        <button class="btn btn-outline-light me-2 auth-loading" id="authLoadingBtn">ë¡œë”©ì¤‘...</button>
        <button class="btn btn-outline-light me-2 d-none" id="loginBtn" data-bs-toggle="modal" data-bs-target="#loginModal">ë¡œê·¸ì¸</button>
        <button class="btn btn-success me-2 d-none" id="signupBtn" data-bs-toggle="modal" data-bs-target="#signupModal">íšŒì›ê°€ì…</button>
        <!-- ë¡œê·¸ì¸ ì‹œ ë³´ì—¬ì§ˆ ì‚¬ìš©ì í”„ë¡œí•„(ë“œë¡­ë‹¤ìš´) -->
        <div class="dropdown d-none" id="userDropdown">
          <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
            <!-- ë‹‰ë„¤ì„, ë“±ê¸‰, ì ìˆ˜ë¡œ ë™ì  ì—…ë°ì´íŠ¸ -->
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownMenuButton">
            <!-- <li><a class="dropdown-item" href="#">í”„ë¡œí•„</a></li> -->
            <!-- <li><hr class="dropdown-divider"></li> -->
            <a class="dropdown-item" href="terms.html" target="_blank">ğŸ“œ ì´ìš© ì•½ê´€</a>
            <li><a class="dropdown-item" href="#" id="logoutBtnDropdown">ğŸšª ë¡œê·¸ì•„ì›ƒ</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <h1 class="hero-title">ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤!</h1>
    <p class="hero-subtitle">ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë§ˆìŒê» ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!</p>
  </section>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container mb-5">
    <div class="d-flex justify-content-end mb-2">
      <button class="btn shining-btn me-2" id="showRankBtn" data-bs-toggle="modal" data-bs-target="#rankModal">ë‚´ ê³„ê¸‰ ë³´ê¸°</button>
      <button class="btn btn-outline-info me-2" id="showRankingBtn" data-bs-toggle="modal" data-bs-target="#rankingModal">ë­í‚¹</button>
      <button class="btn btn-light d-none" id="togglePostFormBtn">ê¸€ì“°ê¸°</button>
    </div>

    <div id="noticeContainer" class="notice-container mb-3"></div>

    <!-- ê¸€ì“°ê¸° ì¹´ë“œ (ìˆ¨ê¹€) -->
    <div class="card glass-card p-3 d-none" id="postCard">
      <div class="card-body">
        <h5 class="card-title">ìƒˆ ê¸€ ì‘ì„±</h5>
        <div class="mb-3">
          <label for="postTitle" class="form-label">ì œëª©</label>
          <input type="text" class="form-control" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>
        <div class="mb-3">
          <label for="editor" class="form-label">ë‚´ìš©</label>
          <div id="editor"></div>
        </div>
        <button class="btn btn-primary mt-2" id="savePostBtn">ê¸€ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>

    <!-- ê¸€ ëª©ë¡ ì¹´ë“œ -->
    <div class="card glass-card mt-4">
      <div class="card-body px-0 px-md-3">
        <h4 class="card-title adventure text-center">ëª¨í—˜ì˜ ê¸°ë¡</h4>
        <div id="postList" class="mt-3"><!-- ê²Œì‹œê¸€ ëª©ë¡ì´ ë¡œë“œë©ë‹ˆë‹¤ --></div>
      </div>
    </div>
  </div>

  <!-- [ìˆ˜ì • ëª¨ë‹¬] -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">ê¸€ ìˆ˜ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editPostId" />
          <div class="mb-3">
            <label for="editTitle" class="form-label">ì œëª©</label>
            <input type="text" class="form-control" id="editTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>
          <div class="mb-3">
            <label for="editContentEditor" class="form-label">ë‚´ìš©</label>
            <div id="editContentEditor"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button type="button" class="btn btn-success" id="updatePostBtn">ìˆ˜ì •í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- [ëŒ“ê¸€ ì‚­ì œ í™•ì¸ ëª¨ë‹¬] -->
  <div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCommentModalLabel">ëŒ“ê¸€ ì‚­ì œ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>í•´ë‹¹ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <input type="hidden" id="deleteCommentPostId" />
          <input type="hidden" id="deleteCommentId" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteCommentBtn">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="signupForm">
          <div class="modal-header">
            <h5 class="modal-title" id="signupModalLabel">íšŒì›ê°€ì…</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="signupEmail" class="form-label">ì´ë©”ì¼</label>
              <input type="email" class="form-control" id="signupEmail" required />
              <small class="text-muted">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ë²„ë ¤ë„ ê³„ì •ì„ ì°¾ì„ ìˆ˜ ìˆì–´ìš”!</small>
            </div>
            <div class="mb-3">
              <label for="signupPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" class="form-control" id="signupPassword" required />
            </div>
            <div class="mb-3">
              <label for="signupNickname" class="form-label">ë‹‰ë„¤ì„</label>
              <input type="text" class="form-control" id="signupNickname" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            <button type="submit" class="btn btn-success">íšŒì›ê°€ì…</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">ë¡œê·¸ì¸</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">ì´ë©”ì¼</label>
              <input type="email" class="form-control" id="loginEmail" required />
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" class="form-control" id="loginPassword" required />
            </div>
            <div class="text-end">
              <button type="button" id="resetPasswordBtn" class="btn btn-link btn-sm">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- [ê³„ê¸‰ ì•ˆë‚´ ëª¨ë‹¬] -->
  <div class="modal fade" id="rankModal" tabindex="-1" aria-labelledby="rankModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rankModalLabel">ë‚´ ê³„ê¸‰ ì•ˆë‚´</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>ë‚´ ì ìˆ˜</strong>: <span id="myScore">ë¡œë”©ì¤‘...</span></p>
          <p><strong>ë‚´ ê³„ê¸‰</strong>: <span id="myRank">ë¡œë”©ì¤‘...</span></p>
          <hr/>
          <h6>ê³„ê¸‰ ê¸°ì¤€</h6>
          <ul style="font-size:0.95rem;" id="futureMagicList"><!-- ë™ì  ì±„ì›€ --></ul>
          <small class="text-muted">
            í–‰ë™ë³„ ì ìˆ˜: ê¸€ì“°ê¸° +50, ëŒ“ê¸€ +20, ì¢‹ì•„ìš” +10, ì‹«ì–´ìš” -5
          </small>
          <div class="mt-3">
            <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#accountCollapse" aria-expanded="false" aria-controls="accountCollapse">
              ê³„ì • ê´€ë¦¬
            </button>
            <div class="collapse mt-2" id="accountCollapse">
              <div class="card card-body">
                <button id="deleteAccountBtn" class="btn btn-danger btn-sm">íšŒì›íƒˆí‡´</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- [ë­í‚¹ ëª¨ë‹¬] -->
  <div class="modal fade" id="rankingModal" tabindex="-1" aria-labelledby="rankingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rankingModalLabel">ë­í‚¹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="rankingContainer" style="max-height: 70vh; overflow-y: auto;">
          <!-- Firestore users ë­í‚¹ í•­ëª©ë“¤ì´ ë¬´í•œ ìŠ¤í¬ë¡¤ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>

  <!-- [ë§ˆë²• ëª¨ë‹¬] -->
  <div class="modal fade" id="magicModal" tabindex="-1" aria-labelledby="magicModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="magicModalLabel">ë§ˆë²• ì‚¬ìš©</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="magicPostId" />
          <div id="magicInfo"><!-- ë™ì  ì±„ì›€ --></div>
        </div>
        <div class="modal-footer" id="magicModalFooter">
          <!-- ë²„íŠ¼ì€ ìƒí™©ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Toast (ì•Œë¦¼) -->
  <div class="toast-container">
    <div id="liveToast" class="toast align-items-center dark-bg" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">ì•Œë¦¼</strong>
        <small class="text-muted" id="toastTime"></small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastMessage">ë©”ì‹œì§€ ë‚´ìš©</div>
    </div>
  </div>

  <!-- canvas-confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase ES Modules (ëª¨ë“ˆ ë°©ì‹) -->
  <script type="module">
    /********************************
     * Firebase ì´ˆê¸°í™” ë° ëª¨ë“ˆ ì„í¬íŠ¸
     ********************************/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app-check.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, deleteUser } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, runTransaction, serverTimestamp, arrayUnion, arrayRemove, where, query, orderBy, getDocs, startAfter, limit, onSnapshot, Timestamp, deleteField } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-etI5o4uWbBp2Arj9KpxdDyRebguErnY",
      authDomain: "newpro-4bc73.firebaseapp.com",
      projectId: "newpro-4bc73",
      storageBucket: "newpro-4bc73.firebasestorage.app",
      messagingSenderId: "267192611563",
      appId: "1:267192611563:web:94fb5ec97872cd452a84ae"
    };

    const app = initializeApp(firebaseConfig);
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LcKb8QqAAAAAKReI1hvkatzxiNvquuoryudyXi4'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    /********************************
     * ì „ì—­ ì‚¬ìš©ì ìºì‹œ ë° í•¨ìˆ˜
     ********************************/
    const userCache = {}; // uidë³„ ìºì‹œ
    async function fetchUserDoc(uid) {
      if (userCache[uid]) {
        return { exists: () => true, data: () => userCache[uid] };
      }
      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        userCache[uid] = snap.data();
      }
      return snap;
    }
    async function fetchUserNicknameAndScore(uid) {
      const snap = await fetchUserDoc(uid);
      if (snap.exists()) {
        const data = snap.data();
        return { nickname: data.nickname || null, score: data.score || 0 };
      }
      return { nickname: null, score: 0 };
    }

    /********************************
     * Toast UI Editor ë° DOMPurify ì´ˆê¸°í™”
     ********************************/
    const { Editor } = toastui;
    const { codeSyntaxHighlight } = Editor.plugin;
    let createEditor = new Editor({
      el: document.querySelector('#editor'),
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });
    let editEditor = new Editor({
      el: document.querySelector('#editContentEditor'),
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });

    let quizQuestionsAll;

    function createQuizCard() {
      const card = document.createElement('div');
      card.className = 'card glass-card mb-3 quiz-card';
      card.continueClicks = 0; // "ê³„ì†" ë²„íŠ¼ í´ë¦­ íšŸìˆ˜
      card.currentPoints = 1;  // ì´ˆê¸° ëˆ„ì  í¬ì¸íŠ¸: 1ì 

      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';
      card.appendChild(cardBody);

      function loadQuiz() {
        cardBody.innerHTML = '';
        var quiz = quizQuestionsAll[Math.floor(Math.random() * quizQuestionsAll.length)];
        cardBody.innerHTML = `
          <div>
            <h5 class="card-title" style="display: inline;">í€´ì¦ˆ íƒ€ì„!</h5>
            <span class="quiz-points badge bg-info" style="margin-left: 10px;">ëˆ„ì  ${card.currentPoints}ì </span>
          </div>
          <p class="card-text quiz-question">${quiz.question}</p>
          <div class="quiz-options mb-3"></div>
          <p class="quiz-result text-info" style="display: inline;"></p>
        `;
        const optionsDiv = cardBody.querySelector('.quiz-options');
        const resultEl = cardBody.querySelector('.quiz-result');

        let options = quiz.options.slice();
        options = shuffleArray(options);

        options.forEach(function(option) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-outline-primary quiz-option';
          btn.textContent = option;
          btn.addEventListener('click', function() {
            // ëª¨ë“  ì„ íƒì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
            optionsDiv.querySelectorAll('button').forEach(b => b.disabled = true);
            if (option === quiz.answer) {
              // ì •ë‹µ ì‹œ, "ì •ë‹µì…ë‹ˆë‹¤! 2ì "ì²˜ëŸ¼ í‘œì‹œ (í˜„ì¬ ëˆ„ì  í¬ì¸íŠ¸ ëŒ€ì‹  í˜„ì¬ ë¬¸ì œì— ì¶”ê°€ë  í¬ì¸íŠ¸ë§Œ í‘œì‹œ)
              resultEl.innerHTML = `ì •ë‹µì…ë‹ˆë‹¤! ëˆ„ì ì ìˆ˜: ${card.currentPoints}ì  `;
              const continueBtn = document.createElement('button');
              continueBtn.className = 'btn btn-primary btn-sm';
              continueBtn.textContent = 'ê³„ì†';
              continueBtn.style.marginLeft = '10px';
              const confirmBtn = document.createElement('button');
              confirmBtn.className = 'btn btn-success btn-sm';
              confirmBtn.textContent = 'í™•ì •';
              confirmBtn.style.marginLeft = '5px';

              continueBtn.addEventListener('click', function() {
                card.continueClicks++;
                let newPoints = Math.pow(2, card.continueClicks);
                card.currentPoints = Math.min(newPoints, 50);
                loadQuiz();
              });

              confirmBtn.addEventListener('click', async function() {
                await awardQuizPoints(card.currentPoints);
                resultEl.innerHTML = `í™•ì •í•˜ì˜€ìŠµë‹ˆë‹¤! ${card.currentPoints}ì  íšë“!`;
                // í™•ì • í›„ì—ë„ ì„ íƒì§€ëŠ” ê·¸ëŒ€ë¡œ ë‚¨ì•„ ìˆìŒ.
              });

              if(card.currentPoints < 50) {
                resultEl.appendChild(continueBtn);
              }
              resultEl.appendChild(confirmBtn);
            } else {
              resultEl.innerHTML = `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì€: ${quiz.answer}`;
              card.continueClicks = 0;
              card.currentPoints = 1;
            }
          });
          optionsDiv.appendChild(btn);
        });
      }

      loadQuiz();
      return card;
    }

    async function awardQuizPoints(points) {
      const user = auth.currentUser;
      if (!user) {
        showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "ì˜¤ë¥˜");
        return;
      }
      try {
        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) oldScore = userSnap.data().score || 0;
          transaction.update(userRef, { score: oldScore + points });
        });
        showToast(`í€´ì¦ˆ í¬ì¸íŠ¸ ${points}ì  íšë“!`, "í€´ì¦ˆ ì±Œë¦°ì§€");
      } catch (err) {
        showToast(err.message, "ì˜¤ë¥˜");
      }
    }

    function shuffleArray(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
      }
      return array;
    }

    /********************************
     * ë‚ ì§œ/ì‹œê°„ í¬ë§· í•¨ìˆ˜
     ********************************/
    function formatDateTime(timestamp) {
      if (!timestamp || !timestamp.seconds) return '';
      const date = new Date(timestamp.seconds * 1000);
      let year = date.getFullYear(), month = date.getMonth() + 1, day = date.getDate();
      let hours = date.getHours(), minutes = date.getMinutes(), seconds = date.getSeconds();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12; hours = hours === 0 ? 12 : hours;
      minutes = minutes.toString().padStart(2, '0'); seconds = seconds.toString().padStart(2, '0');
      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }
    function formatDateForToast(date) {
      let year = date.getFullYear(), month = date.getMonth() + 1, day = date.getDate();
      let hours = date.getHours(), minutes = date.getMinutes(), seconds = date.getSeconds();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12; hours = hours === 0 ? 12 : hours;
      minutes = minutes.toString().padStart(2, '0'); seconds = seconds.toString().padStart(2, '0');
      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    /********************************
     * Toast í•¨ìˆ˜
     ********************************/
    function showToast(message, title = 'ì•Œë¦¼') {
      const toastEl = document.getElementById('liveToast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastTime = document.getElementById('toastTime');
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toastTime.textContent = formatDateForToast(new Date());
      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
    }

    /********************************
     * DOM ìš”ì†Œ ì°¸ì¡°
     ********************************/
    const authLoadingBtn = document.getElementById('authLoadingBtn');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    // ê¸°ì¡´ logoutBtnëŠ” ì œê±°í•˜ê³  ë“œë¡­ë‹¤ìš´ì—ì„œ ì²˜ë¦¬í•¨
    const togglePostFormBtn = document.getElementById('togglePostFormBtn');
    const showRankBtn = document.getElementById('showRankBtn');
    const postCard = document.getElementById('postCard');
    const savePostBtn = document.getElementById('savePostBtn');
    const postList = document.getElementById('postList');
    const signupForm = document.getElementById('signupForm');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupNickname = document.getElementById('signupNickname');
    const loginForm = document.getElementById('loginForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const postTitle = document.getElementById('postTitle');
    const editModalEl = document.getElementById('editModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const editPostId = document.getElementById('editPostId');
    const editTitle = document.getElementById('editTitle');
    const updatePostBtn = document.getElementById('updatePostBtn');
    const deleteCommentModalEl = document.getElementById('deleteCommentModal');
    const deleteCommentModal = new bootstrap.Modal(deleteCommentModalEl);
    const deleteCommentPostId = document.getElementById('deleteCommentPostId');
    const deleteCommentId = document.getElementById('deleteCommentId');
    const confirmDeleteCommentBtn = document.getElementById('confirmDeleteCommentBtn');
    const rankModalEl = document.getElementById('rankModal');
    const myScoreEl = document.getElementById('myScore');
    const myRankEl = document.getElementById('myRank');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const noticeContainer = document.getElementById('noticeContainer');

    /********************************
     * ì „ì—­ ìƒíƒœ ë³€ìˆ˜
     ********************************/
    let currentNickname = null;
    let currentScore = 0;
    let commentUnsubscribers = {};

    function clearPostList() {
      Object.values(commentUnsubscribers).forEach(unsub => unsub());
      commentUnsubscribers = {};
      postList.innerHTML = '';
      lastVisible = null;
    }

    /********************************
     * ê³„ê¸‰(Rank) ê³„ì‚° ë° ë§ˆë²• ê´€ë ¨ í•¨ìˆ˜
     ********************************/
    function getRankByScore(score) {
      if (score >= 50000) return { name: 'ì´í„°ë„', icon: 'ğŸŒŒ' };
      else if (score >= 25000) return { name: 'ë ˆì „ë“œ', icon: 'ğŸ‘‘' };
      else if (score >= 10000) return { name: 'ë§ˆìŠ¤í„°', icon: 'ğŸ†' };
      else if (score >= 5000) return { name: 'ë‹¤ì´ì•„ëª¬ë“œ', icon: 'ğŸ’' };
      else if (score >= 1000) return { name: 'í”Œë˜í‹°ë„˜', icon: 'ğŸ›¡ï¸' };
      else if (score >= 500) return { name: 'ê³¨ë“œ', icon: 'ğŸ¥‡' };
      else if (score >= 100) return { name: 'ì‹¤ë²„', icon: 'ğŸ¥ˆ' };
      else return { name: 'ë¸Œë¡ ì¦ˆ', icon: 'ğŸ¥‰' };
    }
    function getAvailableMagicTypes(rankName) {
      switch(rankName) {
        case 'ë¸Œë¡ ì¦ˆ': return ['magic-basic'];
        case 'ì‹¤ë²„': return ['magic-basic', 'magic-shimmer'];
        case 'ê³¨ë“œ': return ['magic-basic', 'magic-shimmer', 'magic-blessing'];
        case 'í”Œë˜í‹°ë„˜': return ['magic-basic', 'magic-shimmer', 'magic-blessing', 'magic-curse'];
        case 'ë‹¤ì´ì•„ëª¬ë“œ': return ['magic-basic', 'magic-shimmer', 'magic-blessing', 'magic-curse', 'magic-font'];
        case 'ë§ˆìŠ¤í„°': return ['magic-basic', 'magic-shimmer', 'magic-blessing', 'magic-curse', 'magic-font', 'magic-title'];
        case 'ë ˆì „ë“œ': return ['magic-basic', 'magic-shimmer', 'magic-blessing', 'magic-curse', 'magic-font', 'magic-title', 'magic-rainbow'];
        case 'ì´í„°ë„': return ['magic-basic', 'magic-shimmer', 'magic-blessing', 'magic-curse', 'magic-font', 'magic-title', 'magic-rainbow', 'magic-ultimate'];
        default: return ['magic-basic'];
      }
    }
    const magicDisplayNames = {
      'magic-basic': 'ê¸°ë³¸ ë§ˆë²•',
      'magic-shimmer': 'ë°˜ì§ì´ëŠ” ë§ˆë²•',
      'magic-blessing': 'ì¶•ë³µì˜ ë§ˆë²•',
      'magic-curse': 'ì €ì£¼ì˜ ë§ˆë²•',
      'magic-font': 'ê¸€ê¼´ ë³€ê²½ ë§ˆë²•',
      'magic-title': 'ê¸€ì ë’¤ì§‘ê¸° ë§ˆë²•',
      'magic-rainbow': 'ë¬´ì§€ê°œ ë§ˆë²•',
      'magic-ultimate': 'ê¶ê·¹ì˜ ë§ˆë²•'
    };
    function decodeHtml(html) {
      const txt = document.createElement("textarea");
      txt.innerHTML = html;
      return txt.value;
    }
    function parseTimeParameter(timeStr) {
      let seconds = 0;
      const hMatch = timeStr.match(/(\d+)h/);
      if (hMatch) seconds += parseInt(hMatch[1], 10) * 3600;
      const mMatch = timeStr.match(/(\d+)m/);
      if (mMatch) seconds += parseInt(mMatch[1], 10) * 60;
      const sMatch = timeStr.match(/(\d+)s/);
      if (sMatch) seconds += parseInt(sMatch[1], 10);
      if (!hMatch && !mMatch && !sMatch && /^\d+$/.test(timeStr)) seconds = parseInt(timeStr, 10);
      return seconds;
    }
    function convertYouTubeLinks(text) {
      // ì´ë¯¸ iframe íƒœê·¸ê°€ ìˆë‹¤ë©´ ë³€í™˜í•˜ì§€ ì•Šê³  ì›ë³¸ ë°˜í™˜
      if (/(&lt;iframe|<iframe)/i.test(text)) return text;

      return text.replace(
        /(?:https?:\/\/)?(?:www\.)?(?:(?:youtu\.be\/)|(?:youtube\.com\/(?:watch\?v=|shorts\/)))([A-Za-z0-9_-]{11})([^<\s]*)/g,
        (match, videoId, params) => {
          let startParam = '';
          if (params) {
            // HTML ì´ìŠ¤ì¼€ì´í”„ëœ &amp;ë¥¼ ì‹¤ì œ &ë¡œ ë³µì›í•˜ê³ , ì•ë¶€ë¶„ì˜ ? ë˜ëŠ” &ë¥¼ ì œê±°
            const queryString = params.replace(/&amp;/g, '&').replace(/^[\?&]/, '');
            const searchParams = new URLSearchParams(queryString);
            const t = searchParams.get('t');
            if (t) {
              const seconds = parseTimeParameter(t);
              startParam = `?start=${seconds}`;
            }
          }
          return `<div class="video-responsive">
                    <iframe width="560" height="315" 
                            src="https://www.youtube.com/embed/${videoId}${startParam}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                    </iframe>
                  </div>`;
        }
      );
    }
    function convertLinks(text) {
      return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    /********************************
     * ê³µì§€ì‚¬í•­ ë¡œë“œ
     ********************************/
    async function fetchActiveNotices() {
      const now = new Date();
      const q = query(
        collection(db, 'notices'),
        where('startDate', '<=', now),
        where('endDate', '>=', now),
        orderBy('startDate', 'desc')
      );
      let celebrating = false;
      const snapshot = await getDocs(q);
      noticeContainer.innerHTML = '';
      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const bannerEl = document.createElement('div');
        bannerEl.classList.add('notice-banner');
        bannerEl.textContent = data.content;
        if (data.content.includes('ğŸ‰')) {
          bannerEl.addEventListener('click', launchFireworks);
          celebrating = true;
        }
        noticeContainer.appendChild(bannerEl);
      }
      if (celebrating) launchFireworks();
    }

    /********************************
     * íšŒì›ê°€ì…, ë¡œê·¸ì¸, ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”, ë¡œê·¸ì•„ì›ƒ
     ********************************/
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = signupEmail.value.trim();
      const pwVal = signupPassword.value.trim();
      const nickVal = signupNickname.value.trim();
      if (!emailVal || !pwVal || !nickVal) {
        showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'íšŒì›ê°€ì… ì‹¤íŒ¨');
        return;
      }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, emailVal, pwVal);
        const user = userCredential.user;
        await setDoc(doc(db, 'users', user.uid), {
          nickname: nickVal,
          score: 0,
          createdAt: serverTimestamp()
        });
        showToast('íšŒì›ê°€ì… ì„±ê³µ!', 'íšŒì›ê°€ì…');
        bootstrap.Modal.getInstance(document.getElementById('signupModal')).hide();
        location.reload();
      } catch (err) {
        showToast(err.message, 'íšŒì›ê°€ì… ì‹¤íŒ¨');
      }
    });
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = loginEmail.value.trim();
      const pwVal = loginPassword.value.trim();
      if (!emailVal || !pwVal) {
        showToast('ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, emailVal, pwVal);
        showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'ë¡œê·¸ì¸');
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        location.reload();
      } catch (err) {
        showToast(err.message, 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
      }
    });
    resetPasswordBtn.addEventListener('click', async () => {
      const emailVal = loginEmail.value.trim();
      if (!emailVal) {
        showToast('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      if (confirm(`${emailVal}ë¡œ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ë©”ì¼ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
          await sendPasswordResetEmail(auth, emailVal);
          showToast('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.', 'ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”');
        } catch (err) {
          showToast(err.message, 'ì˜¤ë¥˜');
        }
      }
    });
    // ê¸°ì¡´ logoutBtn ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì œê±°í•˜ê³  ì•„ë˜ì—ì„œ ë“œë¡­ë‹¤ìš´ ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    onAuthStateChanged(auth, async (user) => {
      authLoadingBtn.classList.add('d-none');
      if (user) {
        loginBtn.classList.add('d-none');
        signupBtn.classList.add('d-none');
        document.getElementById('userDropdown').classList.remove('d-none');
        togglePostFormBtn.classList.remove('d-none');
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentNickname = userData.nickname;
        currentScore = userData.score;
        const rankInfo = getRankByScore(currentScore);
        document.getElementById('userDropdownMenuButton').innerText = `${currentNickname} ${rankInfo.icon}`;
      } else {
        loginBtn.classList.remove('d-none');
        signupBtn.classList.remove('d-none');
        document.getElementById('userDropdown').classList.add('d-none');
        togglePostFormBtn.classList.add('d-none');
        postCard.classList.add('d-none');
        currentNickname = null;
        currentScore = 0;
      }
      const commentForms = document.querySelectorAll('[id^="commentForm-"]');
      if (user) {
        commentForms.forEach(form => form.classList.remove('d-none'));
      } else {
        commentForms.forEach(form => form.classList.add('d-none'));
      }
    });
    // ë“œë¡­ë‹¤ìš´ì˜ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById('logoutBtnDropdown').addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'ë¡œê·¸ì•„ì›ƒ');
        location.reload();
      } catch (error) {
        showToast(error.message, 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }
    });
    togglePostFormBtn.addEventListener('click', () => {
      postCard.classList.toggle('d-none');
      if (!postCard.classList.contains('d-none')) {
        postTitle.focus();
      }
    });

    rankModalEl.addEventListener('show.bs.modal', async () => {
      const futureMagicListEl = document.getElementById('futureMagicList');
      if (!auth.currentUser) {
        myScoreEl.textContent = '(ë¡œê·¸ì¸ í•„ìš”)';
        myRankEl.textContent = '-';
      } else {
        const snap = await getDoc(doc(db, 'users', auth.currentUser.uid));
        if (snap.exists()) {
          const data = snap.data();
          userCache[auth.currentUser.uid] = data;
          currentScore = data.score || 0;
          currentNickname = data.nickname || null;
        }
        myScoreEl.textContent = `${currentScore}ì `;
        const rankInfo = getRankByScore(currentScore);
        myRankEl.textContent = `${rankInfo.name} ${rankInfo.icon}`;
      }
      const lastMagicTypes = getAvailableMagicTypes('ì´í„°ë„');
      const rankMagicMapping = [
        { rank: 'ë¸Œë¡ ì¦ˆ', icon: 'ğŸ¥‰', range: '0~99' },
        { rank: 'ì‹¤ë²„', icon: 'ğŸ¥ˆ', range: '100~499' },
        { rank: 'ê³¨ë“œ', icon: 'ğŸ¥‡', range: '500~999' },
        { rank: 'í”Œë˜í‹°ë„˜', icon: 'ğŸ›¡ï¸', range: '1,000~4,999' },
        { rank: 'ë‹¤ì´ì•„ëª¬ë“œ', icon: 'ğŸ’', range: '5,000~9,999' },
        { rank: 'ë§ˆìŠ¤í„°', icon: 'ğŸ†', range: '10,000~24,999' },
        { rank: 'ë ˆì „ë“œ', icon: 'ğŸ‘‘', range: '25,000~49,999' },
        { rank: 'ì´í„°ë„', icon: 'ğŸŒŒ', range: '50,000+' }
      ];
      let futureMagicHTML = '';
      rankMagicMapping.forEach((mapping, i) => {
        mapping.magic = [ lastMagicTypes[i] ];
        const magicList = mapping.magic.map(type => magicDisplayNames[type] || type).join(', ');
        futureMagicHTML += `<li>${mapping.icon} ${mapping.rank} (${mapping.range}): ${magicList}</li>`;
      });
      futureMagicListEl.innerHTML = futureMagicHTML;
    });

    /********************************
     * ê¸€ ì‘ì„± (DOMPurify ë° ìœ íŠœë¸Œ ì„ë² ë””ë“œ ì ìš©)
     ********************************/
    savePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (!currentNickname) {
        showToast('ë‹‰ë„¤ì„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const titleVal = DOMPurify.sanitize(postTitle.value.trim(), { ALLOWED_TAGS: [] });
      const contentVal = createEditor ? createEditor.getHTML() : '';
      if (!titleVal) {
        showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      if (!contentVal.trim()) {
        showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      try {
        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) oldScore = userSnap.data().score || 0;
          const newPostRef = doc(collection(db, 'posts'));
          transaction.set(newPostRef, {
            uid: user.uid,
            nickname: currentNickname,
            title: titleVal,
            content: contentVal,
            createdAt: serverTimestamp(),
            likes: [],
            dislikes: []
          });
          transaction.update(userRef, { score: oldScore + 50 });
        });
        showToast('ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ê¸€ ì‘ì„±');
        postTitle.value = '';
        createEditor.setHTML('');
        postCard.classList.add('d-none');
        clearPostList();
        await loadMorePosts();
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ê¸€ ì‘ì„± ì‹¤íŒ¨');
      }
    });

    /********************************
     * ê¸€ ìˆ˜ì • ë° ì‚­ì œ
     ********************************/
    async function openEditModal(postDoc) {
      editPostId.value = postDoc.id;
      editTitle.value = postDoc.data().title;
      if (editEditor) editEditor.setHTML(postDoc.data().content);
      editModal.show();
    }
    updatePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const docId = editPostId.value;
      const newTitle = editTitle.value.trim();
      const newContent = editEditor ? editEditor.getHTML() : '';
      if (!newTitle || !newContent.trim()) {
        showToast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      try {
        const postRef = doc(db, 'posts', docId);
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) {
          showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€ì…ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        if (postSnap.data().uid !== user.uid) {
          showToast('ë³¸ì¸ ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        await updateDoc(postRef, { title: newTitle, content: newContent });
        showToast('ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì„±ê³µ');
        editModal.hide();
        clearPostList();
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    });
    async function deletePost(postDoc) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const postData = postDoc.data();
      if (postData.uid !== user.uid) {
        showToast('ë³¸ì¸ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (!confirm('ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await deleteDoc(postDoc.ref);
        showToast('ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì‚­ì œ');
        clearPostList();
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    /********************************
     * ëŒ“ê¸€ ë“±ë¡ (ë¶€ëª¨ ëŒ“ê¸€ ID ì„ íƒì )
     ********************************/
    async function addComment(postId, content, parentCommentId = null) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const sanitizedContent = DOMPurify.sanitize(content, { ALLOWED_TAGS: [] });
      if (!sanitizedContent.trim()) {
        showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      try {
        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) oldScore = userSnap.data().score || 0;
          const cmtRef = doc(collection(db, 'posts', postId, 'comments'));
          transaction.set(cmtRef, {
            uid: user.uid,
            nickname: currentNickname,
            content: sanitizedContent,
            createdAt: serverTimestamp(),
            parentCommentId: parentCommentId || null,
            likes: [],
            dislikes: []
          });
          transaction.update(userRef, { score: oldScore + 20 });
        });
        showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ëŒ“ê¸€ ì‘ì„±');
      } catch (err) {
        showToast(err.message, 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
      }
    }

    /********************************
     * ëŒ“ê¸€ ì‚­ì œ
     ********************************/
    function openDeleteCommentModal(postId, commentId) {
      deleteCommentPostId.value = postId;
      deleteCommentId.value = commentId;
      deleteCommentModal.show();
    }
    confirmDeleteCommentBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const postId = deleteCommentPostId.value;
      const commentId = deleteCommentId.value;
      try {
        const commentRef = doc(db, 'posts', postId, 'comments', commentId);
        const commentSnap = await getDoc(commentRef);
        if (!commentSnap.exists()) {
          showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëŒ“ê¸€ì…ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        if (commentSnap.data().uid !== user.uid) {
          showToast('ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        await deleteDoc(commentRef);
        showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ëŒ“ê¸€ ì‚­ì œ');
        deleteCommentModal.hide();
      } catch (err) {
        showToast(err.message, 'ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
      }
    });

    /********************************
     * ëŒ“ê¸€ ë Œë”ë§ (ê³„ì¸µêµ¬ì¡° ì²˜ë¦¬)
     ********************************/
     async function renderComments(postId, comments, containerEl) {
      containerEl.innerHTML = '';
      const header = document.getElementById(`commentHeader-${postId}`);
      if (comments.length === 0) {
        if (header) header.style.display = 'none';
      } else {
        if (header) header.style.display = '';
      }
      const commentMap = {};
      comments.forEach(c => {
        c.children = [];
        commentMap[c.commentId] = c;
      });
      const roots = [];
      comments.forEach(c => {
        if (c.parentCommentId && commentMap[c.parentCommentId]) {
          commentMap[c.parentCommentId].children.push(c);
        } else {
          roots.push(c);
        }
      });

      function isOnlyEmoji(text) {
        const trimmed = text.trim();
        // ì •ê·œí‘œí˜„ì‹: í…ìŠ¤íŠ¸ê°€ ë‹¨ì¼ ì´ëª¨ì§€(í•„ìˆ˜ì ìœ¼ë¡œ FE0F ì„ íƒì  í¬í•¨)ë§Œ í¬í•¨í•˜ëŠ”ì§€ ê²€ì‚¬
        const regex = /^(?:\p{Extended_Pictographic}(?:\uFE0F)?)$/u;
        return regex.test(trimmed);
      }

      function renderCommentNode(comment, indent = 0) {
        let rankIcon = '';
        let commentNickname = comment.nickname || 'ìµëª…';
        const div = document.createElement('div');
        div.className = 'comment-item';
        // indentëŠ” rem ë‹¨ìœ„ë¡œ ì ìš©ë˜ë©°, ìµœëŒ€ 2remê¹Œì§€ë§Œ ë“¤ì—¬ì“°ê¸°í•©ë‹ˆë‹¤.
        div.style.marginLeft = indent + 'rem';

        const safeContent = DOMPurify.sanitize(comment.content ?? '', { ALLOWED_TAGS: [] });
        let finalContent;
        if (isOnlyEmoji(safeContent)) {
          finalContent = `<span class="emoji-large">${safeContent}</span>`;
        } else {
          finalContent = convertLinks(safeContent);
        }
        const dateStr = formatDateTime(comment.createdAt);

        // ìµœìƒìœ„ ëŒ“ê¸€(indentê°€ 0ì¸ ê²½ìš°)ì—ë§Œ ë‹µê¸€ ë²„íŠ¼ê³¼ í¼ì„ ë…¸ì¶œ
        const replyButtonHtml = indent === 0
          ? `<button class="btn btn-sm btn-link" id="replyBtn-${postId}-${comment.commentId}">ë‹µê¸€</button>`
          : '';
        const replyFormHtml = indent === 0
          ? `<div class="reply-form d-none" id="replyForm-${postId}-${comment.commentId}">
              <textarea class="form-control mb-2" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" id="replyInput-${postId}-${comment.commentId}"></textarea>
              <button class="btn btn-secondary btn-sm" id="replySubmitBtn-${postId}-${comment.commentId}">ëŒ“ê¸€ ë‹¬ê¸°</button>
            </div>`
          : '';

        div.innerHTML = `
          <div class="fw-bold">
            ${commentNickname} <span style="cursor:pointer;" id="commentRankIcon-${postId}-${comment.commentId}">${rankIcon}</span>
          </div>
          <div class="small text-muted mb-1">
            ${dateStr}
          </div>
          <div class="keep-line-breaks">${finalContent}</div>
          <div class="mt-1 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-primary" id="commentLikeBtn-${postId}-${comment.commentId}">ğŸ‘</button>
            <span id="commentLikeCount-${postId}-${comment.commentId}">${comment.likes ? comment.likes.length : 0}</span>
            <button class="btn btn-sm btn-outline-danger" id="commentDislikeBtn-${postId}-${comment.commentId}">ğŸ‘</button>
            <span id="commentDislikeCount-${postId}-${comment.commentId}">${comment.dislikes ? comment.dislikes.length : 0}</span>            
            ${auth.currentUser && auth.currentUser.uid === comment.uid ? `<button id="delBtn-${postId}-${comment.commentId}" class="btn btn-sm btn-danger ms-2">ì‚­ì œ</button>` : ''}
            ${replyButtonHtml}
          </div>
          ${replyFormHtml}
        `;

        // --- ì¶”ê°€ëœ ë¶€ë¶„: í˜„ì¬ ì‚¬ìš©ìê°€ ì´ë¯¸ ì¢‹ì•„ìš”/ì‹«ì–´ìš” í•œ ê²½ìš° ë²„íŠ¼ í™œì„±í™” ì²˜ë¦¬ --- 
        if (auth.currentUser) {
          const userId = auth.currentUser.uid;
          const commentLikeBtn = div.querySelector(`#commentLikeBtn-${postId}-${comment.commentId}`);
          const commentDislikeBtn = div.querySelector(`#commentDislikeBtn-${postId}-${comment.commentId}`);
          if (comment.likes && comment.likes.includes(userId)) {
            commentLikeBtn.classList.remove('btn-outline-primary');
            commentLikeBtn.classList.add('btn-primary');
          }
          if (comment.dislikes && comment.dislikes.includes(userId)) {
            commentDislikeBtn.classList.remove('btn-outline-danger');
            commentDislikeBtn.classList.add('btn-danger');
          }
        }
        // ---------------------------------------------------------------------------

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        const delBtn = div.querySelector(`#delBtn-${postId}-${comment.commentId}`);
        if (delBtn) {
          delBtn.addEventListener('click', () => {
            openDeleteCommentModal(postId, comment.commentId);
          });
        }

        // ì¢‹ì•„ìš” / ì‹«ì–´ìš” ë²„íŠ¼ ì´ë²¤íŠ¸
        const commentLikeBtn = div.querySelector(`#commentLikeBtn-${postId}-${comment.commentId}`);
        const commentDislikeBtn = div.querySelector(`#commentDislikeBtn-${postId}-${comment.commentId}`);
        commentLikeBtn.addEventListener('click', () => {
          toggleCommentLike(postId, comment.commentId)
        });
        commentDislikeBtn.addEventListener('click', () => toggleCommentDislike(postId, comment.commentId));

        // ë‹µê¸€ ë²„íŠ¼ê³¼ í¼ì€ indentê°€ 0ì¸ ê²½ìš°(ìµœìƒìœ„ ëŒ“ê¸€)ì¼ ë•Œë§Œ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
        if (indent === 0) {
          const replyBtn = div.querySelector(`#replyBtn-${postId}-${comment.commentId}`);
          const replyForm = div.querySelector(`#replyForm-${postId}-${comment.commentId}`);
          replyBtn.addEventListener('click', () => {
            replyForm.classList.toggle('d-none');
          });
          const replySubmitBtn = div.querySelector(`#replySubmitBtn-${postId}-${comment.commentId}`);
          replySubmitBtn.addEventListener('click', () => {
            const replyInput = div.querySelector(`#replyInput-${postId}-${comment.commentId}`);
            const text = replyInput.value.trim();
            if (text) {
              addComment(postId, text, comment.commentId);
              replyInput.value = '';
              replyForm.classList.add('d-none');
            }
          });
        }

        // ê³„ê¸‰ ì•„ì´ì½˜ ì„¤ì •
        const rankIconEl = div.querySelector(`#commentRankIcon-${postId}-${comment.commentId}`);
        if (comment.uid) {
          fetchUserDoc(comment.uid).then(snap => {
            if (snap.exists()) {
              const userData = snap.data();
              const userScore = userData.score || 0;
              const rankInfo = getRankByScore(userScore);
              rankIconEl.textContent = rankInfo.icon;
              rankIconEl.addEventListener('click', () => {
                showToast(`ê³„ê¸‰: ${rankInfo.name} (${userScore}ì )`, userData.nickname || 'ìµëª…');
              });
            }
          });
        }

        // ìì‹ ëŒ“ê¸€ ë Œë”ë§
        // indentê°€ 0ì¸ ê²½ìš°ì—ë§Œ 2rem ë“¤ì—¬ì“°ê¸°ë¡œ ì¦ê°€í•˜ê³ , ê·¸ ì´í›„ì—” ìµœëŒ€ ë“¤ì—¬ì“°ê¸°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
        if (comment.children && comment.children.length > 0) {
          // ìµœìƒìœ„ ëŒ“ê¸€ì¼ ë•ŒëŠ” indent 0 â†’ 2, ë‹µê¸€ì¸ ê²½ìš°ëŠ” ê³„ì† 2remì„ ìœ ì§€
          const newIndent = indent === 0 ? indent + 2 : indent;
          comment.children.forEach(child => {
            const childDiv = renderCommentNode(child, newIndent);
            div.appendChild(childDiv);
          });
        }
        return div;
      }

      roots.forEach(comment => {
        const commentNode = renderCommentNode(comment, 0);
        containerEl.appendChild(commentNode);
      });
    }

    /********************************
     * ì¢‹ì•„ìš”/ì‹«ì–´ìš” (ê²Œì‹œê¸€)
     ********************************/
    let likeDislikeInProgress = new Set();
    async function toggleLike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);
      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) return;
          const data = postSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) oldScore = userSnap.data().score || 0;
          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);
          if (alreadyLiked) {
            transaction.update(postRef, { likes: arrayRemove(user.uid) });
            scoreDiff -= 10;
          } else {
            transaction.update(postRef, { likes: arrayUnion(user.uid) });
            if (alreadyDisliked) {
              transaction.update(postRef, { dislikes: arrayRemove(user.uid) });
              scoreDiff += 5;
            }
            scoreDiff += 10;
          }
          transaction.update(userRef, { score: oldScore + scoreDiff });
        });
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }
    async function toggleDislike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);
      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) return;
          const data = postSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) oldScore = userSnap.data().score || 0;
          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);
          if (alreadyDisliked) {
            transaction.update(postRef, { dislikes: arrayRemove(user.uid) });
            scoreDiff += 5;
          } else {
            transaction.update(postRef, { dislikes: arrayUnion(user.uid) });
            if (alreadyLiked) {
              transaction.update(postRef, { likes: arrayRemove(user.uid) });
              scoreDiff -= 10;
            }
            scoreDiff -= 5;
          }
          transaction.update(userRef, { score: oldScore + scoreDiff });
        });
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }

    /********************************
     * ì¢‹ì•„ìš”/ì‹«ì–´ìš” (ëŒ“ê¸€)
     ********************************/
    let commentLikeDislikeInProgress = new Set();
    async function toggleCommentLike(postId, commentId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const key = `comment-${postId}-${commentId}`;
      if (commentLikeDislikeInProgress.has(key)) return;
      commentLikeDislikeInProgress.add(key);
      try {
        await runTransaction(db, async (transaction) => {
          const commentRef = doc(db, 'posts', postId, 'comments', commentId);
          const commentSnap = await transaction.get(commentRef);
          if (!commentSnap.exists()) return;
          const data = commentSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];
          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);
          if (alreadyLiked) {
            transaction.update(commentRef, { likes: arrayRemove(user.uid) });
            scoreDiff -= 5;
          } else {
            transaction.update(commentRef, { likes: arrayUnion(user.uid) });
            if (alreadyDisliked) {
              transaction.update(commentRef, { dislikes: arrayRemove(user.uid) });
              scoreDiff += 3;
            }
            scoreDiff += 5;
          }
        });
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        commentLikeDislikeInProgress.delete(`comment-${postId}-${commentId}`);
      }
    }
    async function toggleCommentDislike(postId, commentId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const key = `comment-${postId}-${commentId}`;
      if (commentLikeDislikeInProgress.has(key)) return;
      commentLikeDislikeInProgress.add(key);
      try {
        await runTransaction(db, async (transaction) => {
          const commentRef = doc(db, 'posts', postId, 'comments', commentId);
          const commentSnap = await transaction.get(commentRef);
          if (!commentSnap.exists()) return;
          const data = commentSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];
          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);
          if (alreadyDisliked) {
            transaction.update(commentRef, { dislikes: arrayRemove(user.uid) });
            scoreDiff += 3;
          } else {
            transaction.update(commentRef, { dislikes: arrayUnion(user.uid) });
            if (alreadyLiked) {
              transaction.update(commentRef, { likes: arrayRemove(user.uid) });
              scoreDiff -= 5;
            }
            scoreDiff -= 3;
          }
        });
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        commentLikeDislikeInProgress.delete(`comment-${postId}-${commentId}`);
      }
    }

    /********************************
     * ê°œë³„ ê¸€ DOM ìƒì„± (ê²Œì‹œê¸€ ë‚´ìš©, ì¢‹ì•„ìš”/ì‹«ì–´ìš”, ìˆ˜ì •/ì‚­ì œ, ë§ˆë²•, ëŒ“ê¸€ ë“±)
     ********************************/
    async function createPostItem(docSnap) {
      const data = docSnap.data();
      const postId = docSnap.id;
      const card = document.createElement('div');
      card.className = 'card mb-3';
      card.id = 'postCard-' + postId;
      let authorNickname = data.nickname || 'ìµëª…';
      let authorRankEmoji = '';
      let authorScore = 0;
      try {
        const snap = await fetchUserDoc(data.uid);
        if (snap.exists()) {
          const userData = snap.data();
          authorScore = userData.score || 0;
          const rankInfo = getRankByScore(userData.score || 0);
          authorRankEmoji = rankInfo.icon;
          authorNickname = userData.nickname || authorNickname;
        }
      } catch (_) {}
      let isAuthor = false;
      const currentUser = auth.currentUser;
      if (currentUser && currentUser.uid === data.uid) isAuthor = true;
      const likeCount = data.likes ? data.likes.length : 0;
      const dislikeCount = data.dislikes ? data.dislikes.length : 0;
      const title = DOMPurify.sanitize(data.title, { ALLOWED_TAGS: [] });
      const finalContent = convertYouTubeLinks(data.content);
      card.innerHTML = `
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>${title}</span>
          <div class="action-buttons">
            ${isAuthor ? `
              <button class="btn btn-sm btn-warning me-2" id="editBtn-${postId}">ìˆ˜ì •</button>
              <button class="btn btn-sm btn-danger me-2" id="deleteBtn-${postId}">ì‚­ì œ</button>
            ` : ''}
            ${currentUser ? `<button class="btn btn-sm magic-btn" id="magicBtn-${postId}">ğŸ’«</button>` : ''}
          </div>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle text-muted mb-2 post-subtitle">
            <span>ì‘ì„±ì: ${authorNickname} <span style="cursor:pointer;" id="rankIcon-${postId}">${authorRankEmoji}</span></span>
            <span>${formatDateTime(data.createdAt)}</span>
          </h6>
          <div class="card-text mt-2 toastui-editor-contents">${finalContent}</div>
          <div class="mt-3 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-primary" id="likeBtn-${postId}">ğŸ‘</button>
            <span id="likeCount-${postId}">${likeCount}</span>
            <button class="btn btn-sm btn-outline-danger" id="dislikeBtn-${postId}">ğŸ‘</button>
            <span id="dislikeCount-${postId}">${dislikeCount}</span>
            <span class="vr mx-2"></span>
            <button class="btn btn-sm btn-outline-secondary" id="shareBtn-${postId}">ğŸ”—</button>
          </div>
          <div class="mt-3">
            <h6 id="commentHeader-${postId}">ëŒ“ê¸€</h6>
            <div id="commentList-${postId}"></div>
          </div>
          <div class="mt-2 d-none" id="commentForm-${postId}">
            <textarea class="form-control mb-2" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" id="commentInput-${postId}"></textarea>
            <button class="btn btn-secondary" id="commentBtn-${postId}">ëŒ“ê¸€ ë‹¬ê¸°</button>
          </div>
        </div>
      `;
      if (currentUser) {
        const magicBtn = card.querySelector(`#magicBtn-${postId}`);
        if (magicBtn) {
          magicBtn.addEventListener('click', () => {
            if (currentUser.uid !== data.uid && currentScore <= authorScore) {
              showToast("ë§ˆë ¥ì´ ë¯¸ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ë§ˆë²•");
              return;
            }
            openMagicModal(postId, data, authorScore);
          });
        }
      }
      if (isAuthor) {
        const editBtn = card.querySelector(`#editBtn-${postId}`);
        editBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) openEditModal(postSnap);
          else showToast('ê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        });
        const deleteBtn = card.querySelector(`#deleteBtn-${postId}`);
        deleteBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) await deletePost(postSnap);
        });
      }
      const likeBtn = card.querySelector(`#likeBtn-${postId}`);
      const dislikeBtn = card.querySelector(`#dislikeBtn-${postId}`);
      likeBtn.addEventListener('click', () => {
        likeBtn.classList.add('like-flame');
        toggleLike(postId);
        if (card.classList.contains('magic-ultimate')) {
          launchFireworkSpread();
        }
        setTimeout(() => {
          likeBtn.classList.remove('like-flame');
        }, 500);
      });
      dislikeBtn.addEventListener('click', () => toggleDislike(postId));
      const shareBtn = card.querySelector(`#shareBtn-${postId}`);
      shareBtn.addEventListener('click', () => {
        const shareUrl = window.location.origin + window.location.pathname + '?postId=' + postId;
        navigator.clipboard.writeText(shareUrl).then(() => {
          showToast('URL ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ê³µìœ ');
        }).catch((err) => {
          showToast('URL ë³µì‚¬ ì‹¤íŒ¨: ' + err, 'ê³µìœ ');
        });
      });
      if (currentUser) {
        if (data.likes?.includes(currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        }
        if (data.dislikes?.includes(currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        }
      }
      const commentListEl = card.querySelector(`#commentList-${postId}`);
      const commentFormEl = card.querySelector(`#commentForm-${postId}`);
      const commentInputEl = card.querySelector(`#commentInput-${postId}`);
      const commentBtn = card.querySelector(`#commentBtn-${postId}`);
      if (currentUser) commentFormEl.classList.remove('d-none');
      commentBtn.addEventListener('click', () => {
        const text = commentInputEl.value.trim();
        addComment(postId, text);
        commentInputEl.value = '';
      });
      const rankIconEl = card.querySelector(`#rankIcon-${postId}`);
      rankIconEl.addEventListener('click', async () => {
        try {
          const snap = await fetchUserDoc(data.uid);
          if (snap.exists()) {
            const uData = snap.data();
            const s = uData.score || 0;
            const rInfo = getRankByScore(s);
            showToast(`ê³„ê¸‰: ${rInfo.name} (${s}ì )`, authorNickname);
          } else {
            showToast('ìœ ì € ì •ë³´ ì—†ìŒ', 'ì•Œë¦¼');
          }
        } catch (err) {
          showToast(err.message, 'ì•Œë¦¼');
        }
      });
      if (data.magic && data.magic.expiresAt) {
        const now = new Date();
        const exp = new Date(data.magic.expiresAt.seconds * 1000);
        if (now < exp) card.classList.add(data.magic.magicType);
      }
      return card;
    }

    /********************************
     * ë§ˆë²• ê´€ë ¨ í•¨ìˆ˜
     ********************************/
    async function openMagicModal(postId, postData, authorScore) {
      const magicModalEl = document.getElementById('magicModal');
      const magicModal = new bootstrap.Modal(magicModalEl);
      const magicPostIdInput = document.getElementById('magicPostId');
      const magicInfoDiv = document.getElementById('magicInfo');
      const magicModalFooter = document.getElementById('magicModalFooter');
      magicPostIdInput.value = postId;
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      const postDocData = postSnap.data();
      let magic = postDocData.magic || null;
      if (magic && magic.expiresAt) {
        const now = new Date();
        const exp = new Date(magic.expiresAt.seconds * 1000);
        if (now >= exp) magic = null;
      }
      magicInfoDiv.innerHTML = "";
      magicModalFooter.innerHTML = "";
      if (magic) {
        magicInfoDiv.innerHTML = `
          <p>í˜„ì¬ ì ìš©ëœ ë§ˆë²•: <strong>${magicDisplayNames[magic.magicType]}</strong></p>
          <p>ì‹œì „ì: <strong>${magic.casterNickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong></p>
          <p>ì¢…ë£Œ ì‹œê°: <strong>${magic.expiresAt ? formatDateTime(magic.expiresAt) : 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong></p>
        `;
        const casterSnap = await getDoc(doc(db, 'users', magic.casterUid));
        const casterData = casterSnap.exists() ? casterSnap.data() : null;
        const casterScore = casterData ? (casterData.score || 0) : 0;
        if (currentScore >= casterScore) {
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-danger';
          removeBtn.textContent = 'ë§ˆë²• í•´ì œ';
          removeBtn.addEventListener('click', () => removeMagic(postId));
          magicModalFooter.appendChild(removeBtn);
        }
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-secondary';
        closeBtn.textContent = 'ë‹«ê¸°';
        closeBtn.setAttribute('data-bs-dismiss', 'modal');
        magicModalFooter.appendChild(closeBtn);
      } else {
        if (auth.currentUser.uid === postData.uid || currentScore > authorScore) {
          const rankInfo = getRankByScore(currentScore);
          const availableMagic = getAvailableMagicTypes(rankInfo.name);
          let radioHTML = `<p>ì´ ê¸€ì— ì‹œì „í•  ë§ˆë²•ì„ ì„ íƒí•˜ì„¸ìš”:</p>`;
          availableMagic.forEach((magicType, index) => {
            const displayName = magicDisplayNames[magicType] || magicType;
            radioHTML += `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="magicRadio" id="magicRadio-${magicType}" value="${magicType}" ${index===0 ? 'checked' : ''}>
                <label class="form-check-label" for="magicRadio-${magicType}">${displayName}</label>
              </div>`;
          });
          magicInfoDiv.innerHTML = radioHTML;
          const castBtn = document.createElement('button');
          castBtn.className = 'btn btn-primary';
          castBtn.textContent = 'ë§ˆë²• ì‹œì „';
          castBtn.addEventListener('click', () => {
            const radios = document.getElementsByName('magicRadio');
            let selectedMagic;
            for (let radio of radios) {
              if (radio.checked) { selectedMagic = radio.value; break; }
            }
            castMagic(postId, postData, selectedMagic);
          });
          magicModalFooter.appendChild(castBtn);
        } else {
          magicInfoDiv.innerHTML = `<p>í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•˜ì—¬ ë§ˆë²•ì„ ì‹œì „í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-secondary';
        closeBtn.textContent = 'ë‹«ê¸°';
        closeBtn.setAttribute('data-bs-dismiss', 'modal');
        magicModalFooter.appendChild(closeBtn);
      }
      magicModal.show();
    }
    async function castMagic(postId, postData, magicType) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const durationMapping = {
        'magic-basic': 3000,
        'magic-shimmer': 3000,
        'magic-blessing': 4000,
        'magic-curse': 4000,
        'magic-font': 5000,
        'magic-title': 5000,
        'magic-rainbow': 6000,
        'magic-ultimate': 6000
      };
      const duration = durationMapping[magicType] || 300;
      const expiresAt = Timestamp.fromDate(new Date(Date.now() + duration * 1000));
      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) throw new Error('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          transaction.update(postRef, {
            magic: {
              magicType: magicType,
              casterUid: user.uid,
              casterNickname: currentNickname,
              castTime: serverTimestamp(),
              duration: duration,
              expiresAt: expiresAt
            }
          });
        });
        showToast('ë§ˆë²•ì´ ì‹œì „ë˜ì—ˆìŠµë‹ˆë‹¤!', 'ë§ˆë²•');
        const cardEl = document.getElementById(`postCard-${postId}`);
        if (cardEl) cardEl.classList.add(magicType);
        bootstrap.Modal.getInstance(document.getElementById('magicModal')).hide();
      } catch (err) {
        showToast(err.message, 'ë§ˆë²• ì‹œì „ ì‹¤íŒ¨');
      }
    }
    async function removeMagic(postId) {
      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) throw new Error('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          transaction.update(postRef, { magic: deleteField() });
        });
        showToast('ë§ˆë²•ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ë§ˆë²•');
        const cardEl = document.getElementById(`postCard-${postId}`);
        if (cardEl) cardEl.className = cardEl.className.replace(/\bmagic-\S+\b/g, '');
        bootstrap.Modal.getInstance(document.getElementById('magicModal')).hide();
      } catch (err) {
        showToast(err.message, 'ë§ˆë²• í•´ì œ ì‹¤íŒ¨');
      }
    }

    /********************************
     * ì‹¤ì‹œê°„ ê¸€ UI ë° ëŒ“ê¸€ ì—…ë°ì´íŠ¸, ë¬´í•œ ìŠ¤í¬ë¡¤
     ********************************/
     function updatePostUI(postSnap) {
      const postId = postSnap.id;
      const data = postSnap.data();
      const likeCountEl = document.getElementById(`likeCount-${postId}`);
      const dislikeCountEl = document.getElementById(`dislikeCount-${postId}`);
      if (likeCountEl) likeCountEl.textContent = data.likes?.length || 0;
      if (dislikeCountEl) dislikeCountEl.textContent = data.dislikes?.length || 0;
      
      // â†’ ì¶”ê°€: ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      const currentUser = auth.currentUser;
      const likeBtn = document.getElementById(`likeBtn-${postId}`);
      const dislikeBtn = document.getElementById(`dislikeBtn-${postId}`);
      if (likeBtn) {
        if (currentUser && data.likes && data.likes.includes(currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        } else {
          likeBtn.classList.remove('btn-primary');
          likeBtn.classList.add('btn-outline-primary');
        }
      }
      if (dislikeBtn) {
        if (currentUser && data.dislikes && data.dislikes.includes(currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        } else {
          dislikeBtn.classList.remove('btn-danger');
          dislikeBtn.classList.add('btn-outline-danger');
        }
      }
      
      // ê¸°ì¡´ì˜ ë§ˆë²• íš¨ê³¼ ë° burning íš¨ê³¼ ì²˜ë¦¬
      const cardEl = document.getElementById(`postCard-${postId}`);
      if (cardEl) {
        if (data.magic && data.magic.expiresAt) {
          const now = new Date();
          const exp = new Date(data.magic.expiresAt.seconds * 1000);
          if (now < exp) {
            cardEl.className = cardEl.className.replace(/\bmagic-\S+\b/g, '');
            cardEl.classList.add(data.magic.magicType);
          } else {
            cardEl.className = cardEl.className.replace(/\bmagic-\S+\b/g, '');
          }
        } else {
          cardEl.className = cardEl.className.replace(/\bmagic-\S+\b/g, '');
        }
        if (data.likes && data.likes.length >= 3) {
          cardEl.classList.add('burning');
        } else {
          cardEl.classList.remove('burning');
        }
      }
    }

    let lastVisible = null;
    let isLoading = false;
    const PAGE_SIZE = 5;
    async function loadMorePosts() {
      if (isLoading) return;
      isLoading = true;
      let q = query(
        collection(db, 'posts'),
        orderBy('createdAt', 'desc'),
        limit(PAGE_SIZE)
      );
      if (lastVisible) {
        q = query(
          collection(db, 'posts'),
          orderBy('createdAt', 'desc'),
          startAfter(lastVisible),
          limit(PAGE_SIZE)
        );
      }
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        let newLastDoc = null;
        for (let docSnap of snapshot.docs) {
          const item = await createPostItem(docSnap);

          // í€´ì¦ˆ ì¹´ë“œ í•˜ë‚˜ ì‚½ì…
          if(Math.random() < 0.2) {
            const quizCard = createQuizCard();
            postList.appendChild(quizCard);
          }

          postList.appendChild(item);
          onSnapshot(doc(db, 'posts', docSnap.id), (updatedSnap) => {
            if (updatedSnap.exists()) updatePostUI(updatedSnap);
          });
          if (!commentUnsubscribers[docSnap.id]) {
            const cmtQuery = query(
              collection(db, 'posts', docSnap.id, 'comments'),
              orderBy('createdAt', 'asc')
            );
            commentUnsubscribers[docSnap.id] = onSnapshot(cmtQuery, (cmtSnapshot) => {
              const cmtData = [];
              cmtSnapshot.forEach((cmtDoc) => {
                const cdata = cmtDoc.data();
                cdata.commentId = cmtDoc.id;
                cmtData.push(cdata);
              });
              const commentListEl = document.querySelector(`#commentList-${docSnap.id}`);
              if (commentListEl) renderComments(docSnap.id, cmtData, commentListEl);
            });
          }
          newLastDoc = docSnap;
        }
        lastVisible = newLastDoc;
      }
      isLoading = false;
    }

    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) loadMorePosts();
    });

    /********************************
     * ë­í‚¹ ê´€ë ¨ (ë¬´í•œ ìŠ¤í¬ë¡¤)
     ********************************/
    let rankingLastVisible = null;
    let isRankingLoading = false;
    let rankingCount = 0;
    const RANKING_PAGE_SIZE = 10;
    async function loadMoreRanking() {
      if (isRankingLoading) return;
      isRankingLoading = true;
      let q = query(
        collection(db, 'users'),
        orderBy('score', 'desc'),
        limit(RANKING_PAGE_SIZE)
      );
      if (rankingLastVisible) {
        q = query(
          collection(db, 'users'),
          orderBy('score', 'desc'),
          startAfter(rankingLastVisible),
          limit(RANKING_PAGE_SIZE)
        );
      }
      const snapshot = await getDocs(q);
      const rankingContainer = document.getElementById('rankingContainer');
      if (!snapshot.empty) {
        snapshot.forEach(docSnap => {
          rankingCount++;
          const userData = docSnap.data();
          const rankInfo = getRankByScore(userData.score || 0);
          const item = document.createElement('div');
          item.className = 'p-2 border-bottom';
          item.innerHTML = `<strong>${rankingCount}ìœ„</strong> - ${userData.nickname || 'ìµëª…'} : ${userData.score}ì  ${rankInfo.icon}`;
          rankingContainer.appendChild(item);
          rankingLastVisible = docSnap;
        });
      }
      isRankingLoading = false;
    }
    const rankingModalEl = document.getElementById('rankingModal');
    rankingModalEl.addEventListener('show.bs.modal', () => {
      rankingLastVisible = null;
      rankingCount = 0;
      document.getElementById('rankingContainer').innerHTML = '';
      loadMoreRanking();
    });
    const rankingContainer = document.getElementById('rankingContainer');
    rankingContainer.addEventListener('scroll', () => {
      if (rankingContainer.scrollTop + rankingContainer.clientHeight >= rankingContainer.scrollHeight - 50) loadMoreRanking();
    });

    /********************************
     * í­ì£½(Confetti) ì• ë‹ˆë©”ì´ì…˜
     ********************************/
    function launchFireworks() {
      const duration = 2000;
      const animationEnd = Date.now() + duration;
      const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };
      const interval = setInterval(() => {
        const timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) { clearInterval(interval); return; }
        const particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, {
          particleCount,
          origin: { x: Math.random(), y: Math.random() - 0.2 }
        }));
      }, 250);
    }
    async function highlightPostFromQuery() {
      const urlParams = new URLSearchParams(window.location.search);
      const highlightPostId = urlParams.get('postId');
      if (!highlightPostId) return;
      const existingCard = document.getElementById('postCard-' + highlightPostId);
      if (existingCard) {
        if (postList.firstChild !== existingCard) {
          postList.insertBefore(existingCard, postList.firstChild);
        }
        existingCard.style.border = '3px solid gold';
      } else {
        const postRef = doc(db, 'posts', highlightPostId);
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
          const card = await createPostItem(postSnap);
          card.style.border = '3px solid gold';
          postList.insertBefore(card, postList.firstChild);
          
          // â†’ ì¶”ê°€: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ onSnapshot ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ê²Œì‹œê¸€)
          onSnapshot(postRef, (updatedSnap) => {
            if (updatedSnap.exists()) updatePostUI(updatedSnap);
          });
          
          // â†’ ì¶”ê°€: ëŒ“ê¸€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ëŒ“ê¸€ì´ ë³´ì´ì§€ ì•ŠëŠ” ë²„ê·¸ ìˆ˜ì •)
          if (!commentUnsubscribers[highlightPostId]) {
            const cmtQuery = query(
              collection(db, 'posts', highlightPostId, 'comments'),
              orderBy('createdAt', 'asc')
            );
            commentUnsubscribers[highlightPostId] = onSnapshot(cmtQuery, (cmtSnapshot) => {
              const cmtData = [];
              cmtSnapshot.forEach((cmtDoc) => {
                const cdata = cmtDoc.data();
                cdata.commentId = cmtDoc.id;
                cmtData.push(cdata);
              });
              const commentListEl = document.querySelector(`#commentList-${highlightPostId}`);
              if (commentListEl) renderComments(highlightPostId, cmtData, commentListEl);
            });
          }
        }
      }
    }

    deleteAccountBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (!confirm('íšŒì›íƒˆí‡´ ì‹œ, ì‘ì„±í•˜ì‹  ëŒ“ê¸€ì€ ì‚­ì œë˜ì§€ ì•Šê³  ë‚¨ìŠµë‹ˆë‹¤.\nëŒ“ê¸€ì€ ë³„ë„ë¡œ ì§ì ‘ ì‚­ì œí•˜ì…”ì•¼ í•˜ë©°,\nëŒ“ê¸€ì„ ì œì™¸í•œ ëª¨ë“  ì‘ì„±ê¸€ê³¼ ê³„ì •ì´ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const postsQuery = query(collection(db, 'posts'), where('uid', '==', user.uid));
        const postsSnapshot = await getDocs(postsQuery);
        const deletePromises = postsSnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
        await Promise.all(deletePromises);
        await deleteDoc(doc(db, 'users', user.uid));
        await deleteUser(user);
        showToast('íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'íšŒì›íƒˆí‡´');
        await signOut(auth);
      } catch (err) {
        showToast(err.message, 'íšŒì›íƒˆí‡´ ì‹¤íŒ¨');
      }
    });

    function launchFireworkSpread() {
      const duration = 500; // íš¨ê³¼ ì§€ì† ì‹œê°„ (ms)
      const animationEnd = Date.now() + duration;
      const defaults = {
        origin: { x: 0.5, y: 0.5 },
        colors: ['#ff595e', '#ffca3a', '#8ac926', '#1982c4', '#6a4c93'],
        startVelocity: 45,
        particleCount: 20,
        spread: 360,
        ticks: 60
      };
      (function frame() {
        const timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return;
        confetti(Object.assign({}, defaults, {
          particleCount: 20,
          startVelocity: 30 + Math.random() * 20,
          angle: Math.random() * 360
        }));
        requestAnimationFrame(frame);
      }());
    }

    async function init() {
      fetchActiveNotices();    
      const response = await fetch('quiz.json');
      quizQuestionsAll = await response.json();

      await loadMorePosts();
      await highlightPostFromQuery();
    }

    init();
  </script>
</body>
</html>
