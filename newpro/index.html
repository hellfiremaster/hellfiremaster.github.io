<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="description" content="ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤! ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!" />
  <meta name="keywords" content="ì½”ë”©, ì»¤ë®¤ë‹ˆí‹°, í”„ë¡œê·¸ë˜ë°, ê°œë°œì, ë‰´í”„ë¡œ" />
  <meta name="author" content="í”„ë¡œê·¸ë˜ë° ê°¤ëŸ¬ë¦¬ ìœ„ì›íšŒ" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°" />
  <meta property="og:description" content="ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤! ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!" />
  <title>ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°</title>

  <!-- Google Font (Jua) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
    rel="stylesheet"
  />

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- Toast UI Editor: CSS/JS, ì½”ë“œë¸”ë¡ í•˜ì´ë¼ì´íŠ¸ í”ŒëŸ¬ê·¸ì¸ -->
  <link
    rel="stylesheet"
    href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
  />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <link
    rel="stylesheet"
    href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"
  />
  <script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.js"></script>

  <!-- DOMPurify (3.2.3) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.3/purify.min.js" integrity="sha512-Ll+TuDvrWDNNRnFFIM8dOiw7Go7dsHyxRp4RutiIFW/wm3DgDmCnRZow6AqbXnCbpWu93yM1O34q+4ggzGeXVA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* ë‚¨ìƒ‰ ê³„ì—´ ê·¸ë¼ë””ì–¸íŠ¸ ë°°ê²½ */
    body {
      background: linear-gradient(135deg, #1f2945, #2a4065);
      min-height: 100vh;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: rgba(10, 10, 20, 0.7) !important;
    }
    /* ìƒë‹¨ ì™¼ìª½ "ë‰´í”„ë¡œ" í°íŠ¸ ì ìš© */
    .navbar-brand {
      font-family: 'Jua', sans-serif;
      font-size: 1.8rem;
    }
    /* Hero ì˜ì—­ */
    .hero-section {
      text-align: center;
      padding: 3rem 1rem;
      background: transparent;
    }
    .hero-title {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      color: #fff;
      font-family: 'Jua', sans-serif; 
    }
    .hero-subtitle {
      font-size: 1.25rem;
      opacity: 0.9;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
      color: #d5d9e0;
      font-family: 'Jua', sans-serif;
    }
    /* .glass-card: ë°˜íˆ¬ëª… í°ìƒ‰ ë°°ê²½ */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      color: #000; /* ì¹´ë“œ ë‚´ë¶€ í…ìŠ¤íŠ¸ ì–´ë‘ìš´ìƒ‰ */
    }
    /* í† ìŠ¤íŠ¸ - ì¤‘ì•™ í•˜ë‹¨ / ì–´ë‘ìš´ ë°°ê²½ + ë°ì€ ê¸€ì */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .toast.dark-bg {
      background-color: rgba(0,0,0,0.8);
      color: #fff;
    }
    .toast.dark-bg .toast-header {
      background-color: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }
    .toast.dark-bg .btn-close {
      filter: invert(1);
    }
    /* ìˆ¨ê¹€ ìƒíƒœ */
    .d-none {
      display: none !important;
    }
    /* ëª¨ë‹¬ ë‚´ìš©ì€ í° ë°°ê²½ + ê²€ì • í…ìŠ¤íŠ¸ (ê°€ë…ì„±) */
    .modal-content {
      background-color: #fff !important;
      color: #000 !important;
    }
    /* ëŒ“ê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .comment-item {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      color: #000;
    }
    /* ì‘ì„±ì+ì‹œê°„ ê²¹ì¹¨ ë°©ì§€ (flex-wrap) */
    .post-subtitle {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    /* ë¡œë”© ì‹œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* ë¡œë”© ë²„íŠ¼ì— ì ìš©í•  í´ë˜ìŠ¤ */
    .auth-loading {
      animation: spin 1.0s linear infinite;
    }
    #postList img {
      max-width: 100%;
      height: auto;
    }

    /* "ê³„ê¸‰ ì•ˆë‚´" ë²„íŠ¼ --> ë” í™”ë ¤í•˜ê²Œ */
    .shining-btn {
      position: relative;
      overflow: hidden;
      background-color: #ff69b4; /* ê¸°ë³¸ ë°°ê²½: ë¶„í™ë¹› */
      color: #fff;
      border: none;
      border-radius: 5px;
      box-shadow: 0 0 8px rgba(255,105,180, 0.6);
      font-weight: bold;
      cursor: pointer;
    }
    /* ë°˜ì§ì´ëŠ” íš¨ê³¼: ë²„íŠ¼ ìœ„ë¥¼ ê°€ë¡œì§€ë¥´ëŠ” ê·¸ë¼ë””ì–¸íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    .shining-btn::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.7) 0%,
        rgba(255, 255, 255, 0) 40%,
        rgba(255, 255, 255, 0) 60%,
        rgba(255, 255, 255, 0.7) 100%
      );
      animation: shine 2.5s infinite;
      transform: rotate(0deg);
    }
    @keyframes shine {
      0% {
        transform: translate(-100%, -100%);
      }
      50% {
        transform: translate(100%, 100%);
      }
      100% {
        transform: translate(-100%, -100%);
      }
    }

    .keep-line-breaks {
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand fw-bold">ë‰´í”„ë¡œ</span>
      <div class="ms-auto">
        <!-- ë¡œë”©ì¤‘ ìƒíƒœë¥¼ ë³´ì—¬ì¤„ ì„ì‹œ ë²„íŠ¼ (ì²˜ìŒì—ë§Œ ë³´ì„) -->
        <button class="btn btn-outline-light me-2 auth-loading" id="authLoadingBtn">
          ë¡œë”©ì¤‘...
        </button>

        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì…/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ë“¤ (ì´ˆê¸°ì— ìˆ¨ê¹€) -->
        <button class="btn btn-outline-light me-2 d-none" id="loginBtn" data-bs-toggle="modal" data-bs-target="#loginModal">
          ë¡œê·¸ì¸
        </button>
        <button class="btn btn-success me-2 d-none" id="signupBtn" data-bs-toggle="modal" data-bs-target="#signupModal">
          íšŒì›ê°€ì…
        </button>
        <button class="btn btn-danger d-none" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <h1 class="hero-title">ì½”ë”©ì€ ëª¨í—˜ì´ë‹¤!</h1>
    <p class="hero-subtitle">
      ë‰´í”„ë¡œ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë§ˆìŒê» ë‚˜ëˆ„ê³ , ì¦ê±°ìš´ ì½”ë“œ í† í¬ë¥¼ í¼ì³ë³´ì„¸ìš”!
    </p>
  </section>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container mb-5">
    <!-- ê¸€ ëª©ë¡ ì¹´ë“œ ìƒë‹¨ì— "ê¸€ì“°ê¸°" ë²„íŠ¼ + "ê³„ê¸‰ ì•ˆë‚´" ë²„íŠ¼(ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ) -->
    <div class="d-flex justify-content-end mb-2">
      <!-- ë” í™”ë ¤í•œ ë²„íŠ¼ (shining-btn) -->
      <button class="btn shining-btn me-2" id="showRankBtn" data-bs-toggle="modal" data-bs-target="#rankModal">
        ë‚´ ê³„ê¸‰ ë³´ê¸°
      </button>
      <button class="btn btn-light d-none" id="togglePostFormBtn">ê¸€ì“°ê¸°</button>
    </div>

    <!-- ê¸€ì“°ê¸° ì¹´ë“œ (ê¸°ë³¸ ìˆ¨ê¹€) -->
    <div class="card glass-card p-3 d-none" id="postCard">
      <div class="card-body">
        <h5 class="card-title">ìƒˆ ê¸€ ì‘ì„±</h5>
        <div class="mb-3">
          <label for="postTitle" class="form-label">ì œëª©</label>
          <input
            type="text"
            class="form-control"
            id="postTitle"
            placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
          />
        </div>
        <div class="mb-3">
          <label for="editor" class="form-label">ë‚´ìš©</label>
          <!-- Toast UI Editor ì‚½ì… ì˜ì—­ -->
          <div id="editor"></div>
        </div>
        <button class="btn btn-primary mt-2" id="savePostBtn">ê¸€ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>

    <!-- ê¸€ ëª©ë¡ ì¹´ë“œ -->
    <div class="card glass-card mt-4">
      <div class="card-body">
        <h4 class="card-title">ê¸€ ëª©ë¡</h4>
        <div id="postList" class="mt-3">
          <!-- ì²˜ìŒ 5ê°œ ë¶ˆëŸ¬ì˜¤ê¸° -> ìŠ¤í¬ë¡¤ ì‹œ ë‹¤ìŒ 5ê°œ ... -->
        </div>
      </div>
    </div>
  </div>

  <!-- [ìˆ˜ì • ëª¨ë‹¬] -->
  <div
    class="modal fade"
    id="editModal"
    tabindex="-1"
    aria-labelledby="editModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">ê¸€ ìˆ˜ì •</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editPostId" />
          <div class="mb-3">
            <label for="editTitle" class="form-label">ì œëª©</label>
            <input
              type="text"
              class="form-control"
              id="editTitle"
              placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="mb-3">
            <label for="editContentEditor" class="form-label">ë‚´ìš©</label>
            <!-- Toast UI Editor ìˆ˜ì •ìš© ì˜ì—­ -->
            <div id="editContentEditor"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ë‹«ê¸°
          </button>
          <button type="button" class="btn btn-success" id="updatePostBtn">
            ìˆ˜ì •í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- [ëŒ“ê¸€ ì‚­ì œ í™•ì¸ ëª¨ë‹¬] -->
  <div
    class="modal fade"
    id="deleteCommentModal"
    tabindex="-1"
    aria-labelledby="deleteCommentModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCommentModalLabel">ëŒ“ê¸€ ì‚­ì œ</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>í•´ë‹¹ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <input type="hidden" id="deleteCommentPostId" />
          <input type="hidden" id="deleteCommentId" />
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ë‹«ê¸°
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteCommentBtn">
            ì‚­ì œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div
    class="modal fade"
    id="signupModal"
    tabindex="-1"
    aria-labelledby="signupModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="signupForm">
          <div class="modal-header">
            <h5 class="modal-title" id="signupModalLabel">íšŒì›ê°€ì…</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="signupEmail" class="form-label">ì´ë©”ì¼</label>
              <input
                type="email"
                class="form-control"
                id="signupEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label for="signupPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input
                type="password"
                class="form-control"
                id="signupPassword"
                required
              />
            </div>
            <div class="mb-3">
              <label for="signupNickname" class="form-label">ë‹‰ë„¤ì„</label>
              <input
                type="text"
                class="form-control"
                id="signupNickname"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ë‹«ê¸°
            </button>
            <button type="submit" class="btn btn-success">íšŒì›ê°€ì…</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div
    class="modal fade"
    id="loginModal"
    tabindex="-1"
    aria-labelledby="loginModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">ë¡œê·¸ì¸</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">ì´ë©”ì¼</label>
              <input
                type="email"
                class="form-control"
                id="loginEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ë‹«ê¸°
            </button>
            <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- [ê³„ê¸‰ ì•ˆë‚´ ëª¨ë‹¬] -->
  <div
    class="modal fade"
    id="rankModal"
    tabindex="-1"
    aria-labelledby="rankModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rankModalLabel">ë‚´ ê³„ê¸‰ ì•ˆë‚´</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- í˜„ì¬ ê³„ê¸‰/ì ìˆ˜ í‘œì‹œ ì˜ì—­ -->
          <p><strong>ë‚´ ì ìˆ˜</strong>: <span id="myScore">ë¡œë”©ì¤‘...</span></p>
          <p><strong>ë‚´ ê³„ê¸‰</strong>: <span id="myRank">ë¡œë”©ì¤‘...</span></p>
          <hr/>
          <h6>ê³„ê¸‰ ê¸°ì¤€</h6>
          <ul style="font-size:0.95rem;">
            <li>ğŸ¥‰ ë¸Œë¡ ì¦ˆ: 0~99</li>
            <li>ğŸ¥ˆ ì‹¤ë²„: 100~499</li>
            <li>ğŸ¥‡ ê³¨ë“œ: 500~999</li>
            <li>ğŸ›¡ï¸ í”Œë˜í‹°ë„˜: 1,000~4,999</li>
            <li>ğŸ’ ë‹¤ì´ì•„ëª¬ë“œ: 5,000~9,999</li>
            <li>ğŸ† ë§ˆìŠ¤í„°: 10,000~24,999</li>
            <li>ğŸ‘‘ ë ˆì „ë“œ: 25,000~49,999</li>
            <li>ğŸŒŒ ì´í„°ë„: 50,000+</li>
          </ul>
          <small class="text-muted">í–‰ë™ë³„ ì ìˆ˜: ê¸€ì“°ê¸° +50, ëŒ“ê¸€ +20, ì¢‹ì•„ìš” Â±10, ì‹«ì–´ìš” Â±5 (í† ê¸€ ì‹œ ì°¨ê°/ë³µì›).</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast (ì¤‘ì•™ í•˜ë‹¨, ì–´ë‘ìš´ ë°°ê²½+ë°ì€ ê¸€ì) -->
  <div class="toast-container">
    <div
      id="liveToast"
      class="toast align-items-center dark-bg"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">ì•Œë¦¼</strong>
        <small class="text-muted" id="toastTime"></small>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
      <div class="toast-body" id="toastMessage">
        ë©”ì‹œì§€ ë‚´ìš©
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (Popper í¬í•¨) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase ES Modules (App, Auth, Firestore, AppCheck) -->
  <script type="module">
    /********************************
     * Firebase Import & Init
     ********************************/
    import {
      initializeApp
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js';

    import {
      initializeAppCheck,
      ReCaptchaV3Provider
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app-check.js';

    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';

    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      runTransaction,
      serverTimestamp,
      arrayUnion,
      arrayRemove,
      query,
      orderBy,
      getDocs,
      startAfter,
      limit,
      onSnapshot
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-etI5o4uWbBp2Arj9KpxdDyRebguErnY",
      authDomain: "newpro-4bc73.firebaseapp.com",
      projectId: "newpro-4bc73",
      storageBucket: "newpro-4bc73.firebasestorage.app",
      messagingSenderId: "267192611563",
      appId: "1:267192611563:web:94fb5ec97872cd452a84ae"
    };

    const app = initializeApp(firebaseConfig);

    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LcKb8QqAAAAAKReI1hvkatzxiNvquuoryudyXi4'),
      isTokenAutoRefreshEnabled: true
    });

    const auth = getAuth(app);
    const db = getFirestore(app);

    /********************************
     * Toast UI Editor ì´ˆê¸°í™”
     ********************************/
    const { Editor } = toastui;
    const { codeSyntaxHighlight } = Editor.plugin;

    let createEditor = new Editor({
      el: document.querySelector('#editor'),
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });

    let editEditor = new Editor({
      el: document.querySelector('#editContentEditor'),
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      plugins: [codeSyntaxHighlight]
    });

    /********************************
     * ë‚ ì§œ/ì‹œê°„ í¬ë§·
     ********************************/
    function formatDateTime(timestamp) {
      if (!timestamp || !timestamp.seconds) return '';
      const date = new Date(timestamp.seconds * 1000);

      let year = date.getFullYear();
      let month = date.getMonth() + 1;
      let day = date.getDate();

      let hours = date.getHours();
      let minutes = date.getMinutes();
      let seconds = date.getSeconds();

      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours === 0 ? 12 : hours;

      minutes = minutes.toString().padStart(2, '0');
      seconds = seconds.toString().padStart(2, '0');

      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    function formatDateForToast(date) {
      let year = date.getFullYear();
      let month = date.getMonth() + 1;
      let day = date.getDate();

      let hours = date.getHours();
      let minutes = date.getMinutes();
      let seconds = date.getSeconds();

      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours === 0 ? 12 : hours;

      minutes = minutes.toString().padStart(2, '0');
      seconds = seconds.toString().padStart(2, '0');

      return `${year}.${month}.${day}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    /********************************
     * Toast í•¨ìˆ˜
     ********************************/
    function showToast(message, title = 'ì•Œë¦¼') {
      const toastEl = document.getElementById('liveToast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastTime = document.getElementById('toastTime');

      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toastTime.textContent = formatDateForToast(new Date());

      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
    }

    /********************************
     * DOM ìš”ì†Œ ì°¸ì¡°
     ********************************/
    const authLoadingBtn = document.getElementById('authLoadingBtn');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const togglePostFormBtn = document.getElementById('togglePostFormBtn');
    const showRankBtn = document.getElementById('showRankBtn'); 

    const postCard = document.getElementById('postCard');
    const savePostBtn = document.getElementById('savePostBtn');
    const postList = document.getElementById('postList');

    // íšŒì›ê°€ì…
    const signupForm = document.getElementById('signupForm');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupNickname = document.getElementById('signupNickname');

    // ë¡œê·¸ì¸
    const loginForm = document.getElementById('loginForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');

    // ê¸€ ì‘ì„±
    const postTitle = document.getElementById('postTitle');

    // ìˆ˜ì • ëª¨ë‹¬
    const editModalEl = document.getElementById('editModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const editPostId = document.getElementById('editPostId');
    const editTitle = document.getElementById('editTitle');
    const updatePostBtn = document.getElementById('updatePostBtn');

    // ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬
    const deleteCommentModalEl = document.getElementById('deleteCommentModal');
    const deleteCommentModal = new bootstrap.Modal(deleteCommentModalEl);
    const deleteCommentPostId = document.getElementById('deleteCommentPostId');
    const deleteCommentId = document.getElementById('deleteCommentId');
    const confirmDeleteCommentBtn = document.getElementById('confirmDeleteCommentBtn');

    // ê³„ê¸‰ ì•ˆë‚´ ëª¨ë‹¬
    const rankModalEl = document.getElementById('rankModal');
    const myScoreEl = document.getElementById('myScore');
    const myRankEl = document.getElementById('myRank');

    /********************************
     * ì „ì—­ ìƒíƒœ
     ********************************/
    let currentNickname = null;
    let currentScore = 0;

    /********************************
     * ê³„ê¸‰(Rank) ê³„ì‚° í•¨ìˆ˜
     ********************************/
    function getRankByScore(score) {
      if (score >= 50000) {
        return { name: 'ì´í„°ë„', icon: 'ğŸŒŒ' };
      } else if (score >= 25000) {
        return { name: 'ë ˆì „ë“œ', icon: 'ğŸ‘‘' };
      } else if (score >= 10000) {
        return { name: 'ë§ˆìŠ¤í„°', icon: 'ğŸ†' };
      } else if (score >= 5000) {
        return { name: 'ë‹¤ì´ì•„ëª¬ë“œ', icon: 'ğŸ’' };
      } else if (score >= 1000) {
        return { name: 'í”Œë˜í‹°ë„˜', icon: 'ğŸ›¡ï¸' };
      } else if (score >= 500) {
        return { name: 'ê³¨ë“œ', icon: 'ğŸ¥‡' };
      } else if (score >= 100) {
        return { name: 'ì‹¤ë²„', icon: 'ğŸ¥ˆ' };
      } else {
        return { name: 'ë¸Œë¡ ì¦ˆ', icon: 'ğŸ¥‰' };
      }
    }

    /********************************
     * ì‚¬ìš©ì ì •ë³´(userDoc) ê°€ì ¸ì˜¤ê¸°
     ********************************/
    async function fetchUserDoc(uid) {
      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);
      return snap;
    }

    async function fetchUserNicknameAndScore(uid) {
      const snap = await fetchUserDoc(uid);
      if (snap.exists()) {
        const data = snap.data();
        return {
          nickname: data.nickname || null,
          score: data.score || 0
        };
      }
      return { nickname: null, score: 0 };
    }

    /********************************
     * íŠ¸ëœì­ì…˜ ê¸°ë°˜ ì ìˆ˜ ì—…ë°ì´íŠ¸
     ********************************/
    async function updateUserScore(uid, diff) {
      if (!uid) return;
      try {
        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) {
            oldScore = userSnap.data().score || 0;
          }
          transaction.update(userRef, {
            score: oldScore + diff
          });
        });
        const { score } = await fetchUserNicknameAndScore(uid);
        currentScore = score;
      } catch (err) {
        console.error(err);
        showToast('ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + err.message, 'ì˜¤ë¥˜');
      }
    }

    /********************************
     * íšŒì›ê°€ì…
     ********************************/
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = signupEmail.value.trim();
      const pwVal = signupPassword.value.trim();
      const nickVal = signupNickname.value.trim();

      if (!emailVal || !pwVal || !nickVal) {
        showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'íšŒì›ê°€ì… ì‹¤íŒ¨');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, emailVal, pwVal);
        const user = userCredential.user;
        await setDoc(doc(db, 'users', user.uid), {
          nickname: nickVal,
          score: 0,
          createdAt: serverTimestamp()
        });
        showToast('íšŒì›ê°€ì… ì„±ê³µ!', 'íšŒì›ê°€ì…');
        bootstrap.Modal.getInstance(signupModal).hide();
      } catch (err) {
        showToast(err.message, 'íšŒì›ê°€ì… ì‹¤íŒ¨');
      }
    });

    /********************************
     * ë¡œê·¸ì¸
     ********************************/
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailVal = loginEmail.value.trim();
      const pwVal = loginPassword.value.trim();

      if (!emailVal || !pwVal) {
        showToast('ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, emailVal, pwVal);
        showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'ë¡œê·¸ì¸');
        bootstrap.Modal.getInstance(loginModal).hide();
      } catch (err) {
        showToast(err.message, 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
      }
    });

    /********************************
     * ë¡œê·¸ì•„ì›ƒ
     ********************************/
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'ë¡œê·¸ì•„ì›ƒ');
      } catch (error) {
        showToast(error.message, 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }
    });

    /********************************
     * Auth ìƒíƒœ ê°ì§€ -> UI ì—…ë°ì´íŠ¸
     ********************************/
    onAuthStateChanged(auth, async (user) => {
      // ë¡œë”© ë²„íŠ¼ì€ ìˆ¨ê¹€
      authLoadingBtn.classList.add('d-none');

      if (user) {
        loginBtn.classList.add('d-none');
        signupBtn.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
        togglePostFormBtn.classList.remove('d-none');

        // ë‹‰ë„¤ì„ & ì ìˆ˜ ë¡œë“œ
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentNickname = userData.nickname;
        currentScore = userData.score;
      } else {
        loginBtn.classList.remove('d-none');
        signupBtn.classList.remove('d-none');
        logoutBtn.classList.add('d-none');
        togglePostFormBtn.classList.add('d-none');
        postCard.classList.add('d-none');

        currentNickname = null;
        currentScore = 0;
      }
    });

    /********************************
     * ê¸€ì“°ê¸° ë²„íŠ¼ í† ê¸€
     ********************************/
    togglePostFormBtn.addEventListener('click', () => {
      postCard.classList.toggle('d-none');
    });

    /********************************
     * ê³„ê¸‰ ì•ˆë‚´ ëª¨ë‹¬ ë³´ì¼ ë•Œ
     ********************************/
    rankModalEl.addEventListener('show.bs.modal', () => {
      if (!auth.currentUser) {
        myScoreEl.textContent = '(ë¡œê·¸ì¸ í•„ìš”)';
        myRankEl.textContent = '-';
      } else {
        myScoreEl.textContent = `${currentScore}ì `;
        const rankInfo = getRankByScore(currentScore);
        myRankEl.textContent = `${rankInfo.name} ${rankInfo.icon}`;
      }
    });

    /********************************
     * ê¸€ ì‘ì„± (DOMPurify ì ìš©)
     ********************************/
    savePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (!currentNickname) {
        showToast('ë‹‰ë„¤ì„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }

      const titleVal = postTitle.value.trim();
      // ì›ë³¸ Toast UI Editor HTML
      const unsafeContent = createEditor ? createEditor.getHTML() : '';
      // DOMPurifyë¡œ ì •ì œ
      const contentVal = DOMPurify.sanitize(unsafeContent);

      if (!titleVal) {
        showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }
      if (!contentVal.trim()) {
        showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          // 1) ë¨¼ì € userRef ì½ê¸°
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);

          let oldScore = 0;
          if (userSnap.exists()) {
            oldScore = userSnap.data().score || 0;
          }

          // 2) ìƒˆ ê²Œì‹œê¸€ ì“°ê¸°
          const newPostRef = doc(collection(db, 'posts'));
          transaction.set(newPostRef, {
            uid: user.uid,
            nickname: currentNickname,
            title: titleVal,
            content: contentVal, // ì´ë¯¸ Purifyëœ HTML
            createdAt: serverTimestamp(),
            likes: [],
            dislikes: []
          });

          // 3) ì ìˆ˜ +50
          transaction.update(userRef, {
            score: oldScore + 50
          });
        });

        showToast('ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ê¸€ ì‘ì„±');
        postTitle.value = '';
        createEditor.setHTML('');
        postCard.classList.add('d-none');

        // ëª©ë¡ ë¦¬ì…‹ & ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();

        // ë‚´ ì ìˆ˜ ê°±ì‹ 
        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ê¸€ ì‘ì„± ì‹¤íŒ¨');
      }
    });

    /********************************
     * ê¸€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
     ********************************/
    async function openEditModal(postDoc) {
      editPostId.value = postDoc.id;
      editTitle.value = postDoc.data().title;
      if (editEditor) {
        editEditor.setHTML(postDoc.data().content);
      }
      editModal.show();
    }

    /********************************
     * ê¸€ ìˆ˜ì • ì‹œ (DOMPurify ì ìš©)
     ********************************/
    updatePostBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const docId = editPostId.value;
      const newTitle = editTitle.value.trim();

      // ì›ë³¸ ìˆ˜ì •ë‚´ìš©
      const unsafeContent = editEditor ? editEditor.getHTML() : '';
      // Purify
      const newContent = DOMPurify.sanitize(unsafeContent);

      if (!newTitle || !newContent.trim()) {
        showToast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }

      try {
        const postRef = doc(db, 'posts', docId);
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) {
          showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€ì…ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        if (postSnap.data().uid !== user.uid) {
          showToast('ë³¸ì¸ ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        await updateDoc(postRef, {
          title: newTitle,
          content: newContent
        });

        showToast('ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì„±ê³µ');
        editModal.hide();

        // ìˆ˜ì • ì§í›„ ëª©ë¡ ê°±ì‹ 
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    });

    /********************************
     * ê¸€ ì‚­ì œ
     ********************************/
    async function deletePost(postDoc) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const postData = postDoc.data();
      if (postData.uid !== user.uid) {
        showToast('ë³¸ì¸ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (!confirm('ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      try {
        await deleteDoc(postDoc.ref);
        showToast('ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì‚­ì œ');

        // ëª©ë¡ ë¦¬ë¡œë“œ
        lastVisible = null;
        postList.innerHTML = '';
        await loadMorePosts();
      } catch (err) {
        showToast(err.message, 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    /********************************
     * ëŒ“ê¸€ ë“±ë¡ (íŠ¸ëœì­ì…˜) + DOMPurify
     ********************************/
    async function addComment(postId, content) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }

      // DOMPurifyë¡œ ëŒ“ê¸€ ë‚´ìš© ì •ì œ
      const sanitizedContent = DOMPurify.sanitize(content);

      if (!sanitizedContent.trim()) {
        showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'ì˜¤ë¥˜');
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          // (1) ë¨¼ì € ì½ê¸°
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          
          let oldScore = 0;
          if (userSnap.exists()) {
            oldScore = userSnap.data().score || 0;
          }

          // (2) ëŒ“ê¸€ ì¶”ê°€
          const cmtRef = doc(collection(db, 'posts', postId, 'comments'));
          transaction.set(cmtRef, {
            uid: user.uid,
            nickname: currentNickname,
            content: sanitizedContent,
            createdAt: serverTimestamp()
          });

          // (3) ì ìˆ˜ +20
          transaction.update(userRef, {
            score: oldScore + 20
          });
        });

        showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ëŒ“ê¸€ ì‘ì„±');
      } catch (err) {
        showToast(err.message, 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
      }
    }

    /********************************
     * ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
     ********************************/
    function openDeleteCommentModal(postId, commentId) {
      deleteCommentPostId.value = postId;
      deleteCommentId.value = commentId;
      deleteCommentModal.show();
    }

    confirmDeleteCommentBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      const postId = deleteCommentPostId.value;
      const commentId = deleteCommentId.value;
      try {
        const commentRef = doc(db, 'posts', postId, 'comments', commentId);
        const commentSnap = await getDoc(commentRef);
        if (!commentSnap.exists()) {
          showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëŒ“ê¸€ì…ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        if (commentSnap.data().uid !== user.uid) {
          showToast('ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          return;
        }
        await deleteDoc(commentRef);
        showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ëŒ“ê¸€ ì‚­ì œ');
        deleteCommentModal.hide();
      } catch (err) {
        showToast(err.message, 'ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
      }
    });

    /********************************
     * ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ (ì¶œë ¥ ì‹œ DOMPurify ì ìš©)
     ********************************/
    async function renderComments(postId, comments, containerEl) {
      containerEl.innerHTML = '';

      for (const c of comments) {
        let rankIcon = '';
        let commentNickname = c.nickname || 'ìµëª…';

        // (ì‘ì„±ì ë­í¬ ì´ëª¨ì§€)
        if (c.uid) {
          try {
            const userRef = doc(db, 'users', c.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
              const userData = userSnap.data();
              const userScore = userData.score || 0;
              const rankInfo = getRankByScore(userScore);
              rankIcon = rankInfo.icon;
              commentNickname = userData.nickname || commentNickname;
            }
          } catch (err) {
            console.error('ìœ ì € ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', err);
          }
        }

        // ëŒ“ê¸€ ë‚´ìš© DOMPurify + convertLinks
        const safeContent = DOMPurify.sanitize(c.content ?? '');
        const finalContent = convertLinks(safeContent);

        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `
          <div class="fw-bold">
            ${commentNickname} 
            <span style="cursor:pointer;" id="commentRankIcon-${postId}-${c.commentId}">
              ${rankIcon}
            </span>
          </div>
          <div class="small text-muted mb-1">
            ${formatDateTime(c.createdAt)}
          </div>
          <div class="keep-line-breaks">${finalContent}</div>
        `;

        const rankIconEl = div.querySelector(`#commentRankIcon-${postId}-${c.commentId}`);
        if (rankIconEl && rankIcon) {
          rankIconEl.addEventListener('click', async () => {
            try {
              const userRef = doc(db, 'users', c.uid);
              const userSnap = await getDoc(userRef);
              if (userSnap.exists()) {
                const uData = userSnap.data();
                const s = uData.score || 0;
                const rInfo = getRankByScore(s);
                showToast(`ê³„ê¸‰: ${rInfo.name} (${s}ì )`, commentNickname);
              } else {
                showToast('ìœ ì € ì •ë³´ ì—†ìŒ', 'ì•Œë¦¼');
              }
            } catch (err) {
              showToast(err.message, 'ì•Œë¦¼');
            }
          });
        }

        if (auth.currentUser && auth.currentUser.uid === c.uid) {
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-danger ms-2';
          delBtn.textContent = 'ì‚­ì œ';
          delBtn.addEventListener('click', () => {
            openDeleteCommentModal(postId, c.commentId);
          });
          div.appendChild(delBtn);
        }

        containerEl.appendChild(div);
      }
    }

    /********************************
     * ì¢‹ì•„ìš”/ì‹«ì–´ìš” (score ë³€ê²½ í¬í•¨)
     ********************************/
    let likeDislikeInProgress = new Set();

    async function toggleLike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);

      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) return;

          const data = postSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];

          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) {
            oldScore = userSnap.data().score || 0;
          }

          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);

          if (alreadyLiked) {
            transaction.update(postRef, {
              likes: arrayRemove(user.uid)
            });
            scoreDiff -= 10;
          } else {
            transaction.update(postRef, {
              likes: arrayUnion(user.uid)
            });
            if (alreadyDisliked) {
              transaction.update(postRef, {
                dislikes: arrayRemove(user.uid)
              });
              scoreDiff += 5; 
            }
            scoreDiff += 10; 
          }

          transaction.update(userRef, {
            score: oldScore + scoreDiff
          });
        });

        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }

    async function toggleDislike(postId) {
      const user = auth.currentUser;
      if (!user) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ì˜¤ë¥˜');
        return;
      }
      if (likeDislikeInProgress.has(postId)) return;
      likeDislikeInProgress.add(postId);

      try {
        await runTransaction(db, async (transaction) => {
          const postRef = doc(db, 'posts', postId);
          const postSnap = await transaction.get(postRef);
          if (!postSnap.exists()) return;

          const data = postSnap.data();
          const likes = data.likes || [];
          const dislikes = data.dislikes || [];

          const userRef = doc(db, 'users', user.uid);
          const userSnap = await transaction.get(userRef);
          let oldScore = 0;
          if (userSnap.exists()) {
            oldScore = userSnap.data().score || 0;
          }

          let scoreDiff = 0;
          const alreadyLiked = likes.includes(user.uid);
          const alreadyDisliked = dislikes.includes(user.uid);

          if (alreadyDisliked) {
            transaction.update(postRef, {
              dislikes: arrayRemove(user.uid)
            });
            scoreDiff += 5;
          } else {
            transaction.update(postRef, {
              dislikes: arrayUnion(user.uid)
            });
            if (alreadyLiked) {
              transaction.update(postRef, {
                likes: arrayRemove(user.uid)
              });
              scoreDiff -= 10; 
            }
            scoreDiff -= 5;  
          }

          transaction.update(userRef, {
            score: oldScore + scoreDiff
          });
        });

        const userData = await fetchUserNicknameAndScore(user.uid);
        currentScore = userData.score;
      } catch (err) {
        showToast(err.message, 'ì˜¤ë¥˜');
      } finally {
        likeDislikeInProgress.delete(postId);
      }
    }

    /********************************
     * ê°œë³„ ê¸€ DOM ìƒì„± í•¨ìˆ˜ (ì¶œë ¥ ì‹œ DOMPurify)
     ********************************/
    async function createPostItem(docSnap) {
      const data = docSnap.data();
      const postId = docSnap.id;

      let authorNickname = data.nickname || 'ìµëª…';
      let authorRankEmoji = '';
      try {
        const snap = await fetchUserDoc(data.uid);
        if (snap.exists()) {
          const userData = snap.data();
          const userScore = userData.score || 0;
          const rankInfo = getRankByScore(userScore);
          authorRankEmoji = rankInfo.icon; 
          authorNickname = userData.nickname || authorNickname;
        }
      } catch (_) { /* ë¬´ì‹œ */ }

      let isAuthor = false;
      const currentUser = auth.currentUser;
      if (currentUser && currentUser.uid === data.uid) {
        isAuthor = true; 
      }

      const likeCount = data.likes ? data.likes.length : 0;
      const dislikeCount = data.dislikes ? data.dislikes.length : 0;

      // ê²Œì‹œê¸€ ë³¸ë¬¸ë„ DOMPurifyë¡œ ì¬ì°¨ ì •ì œ
      const safeContent = DOMPurify.sanitize(data.content ?? '');

      const card = document.createElement('div');
      card.className = 'card mb-3';
      card.innerHTML = `
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>${data.title}</span>
          ${
            isAuthor
              ? ` 
                <div>
                  <button class="btn btn-sm btn-warning me-2" id="editBtn-${postId}">ìˆ˜ì •</button>
                  <button class="btn btn-sm btn-danger" id="deleteBtn-${postId}">ì‚­ì œ</button>
                </div>
              `
              : ''
          }
        </div>
        <div class="card-body">
          <h6 class="card-subtitle text-muted mb-2 post-subtitle">
            <span>
              ì‘ì„±ì: ${authorNickname}
              <span style="cursor:pointer;" id="rankIcon-${postId}">${authorRankEmoji}</span>
            </span>
            <span>${formatDateTime(data.createdAt)}</span>
          </h6>
          <div class="card-text mt-2">${safeContent}</div>
          
          <!-- ì¶”ì²œ/ë¹„ì¶”ì²œ -->
          <div class="mt-3 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-primary" id="likeBtn-${postId}">ğŸ‘</button>
            <span id="likeCount-${postId}">${likeCount}</span>
            <button class="btn btn-sm btn-outline-danger" id="dislikeBtn-${postId}">ğŸ‘</button>
            <span id="dislikeCount-${postId}">${dislikeCount}</span>
          </div>

          <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
          <div class="mt-3">
            <h6 id="commentHeader-${postId}">ëŒ“ê¸€</h6>
            <div id="commentList-${postId}"></div>
          </div>

          <!-- ëŒ“ê¸€ ì‘ì„± í¼ (ë¡œê·¸ì¸ ì‹œë§Œ ë³´ì´ê²Œ) -->
          <div class="mt-2 d-none" id="commentForm-${postId}">
            <textarea class="form-control mb-2" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" id="commentInput-${postId}"></textarea>
            <button class="btn btn-secondary" id="commentBtn-${postId}">ëŒ“ê¸€ ë‹¬ê¸°</button>
          </div>
        </div>
      `;

      // ìˆ˜ì •/ì‚­ì œ
      if (isAuthor) {
        const editBtn = card.querySelector(`#editBtn-${postId}`);
        editBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) {
            openEditModal(postSnap);
          } else {
            showToast('ê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
          }
        });

        const deleteBtn = card.querySelector(`#deleteBtn-${postId}`);
        deleteBtn.addEventListener('click', async () => {
          const postSnap = await getDoc(doc(db, 'posts', postId));
          if (postSnap.exists()) {
            await deletePost(postSnap);
          }
        });
      }

      // ì¢‹ì•„ìš”/ì‹«ì–´ìš”
      const likeBtn = card.querySelector(`#likeBtn-${postId}`);
      const dislikeBtn = card.querySelector(`#dislikeBtn-${postId}`);
      likeBtn.addEventListener('click', () => toggleLike(postId));
      dislikeBtn.addEventListener('click', () => toggleDislike(postId));

      if (currentUser) {
        if (data.likes?.includes(currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        }
        if (data.dislikes?.includes(currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        }
      }

      // ëŒ“ê¸€ ì‘ì„± í¼
      const commentListEl = card.querySelector(`#commentList-${postId}`);
      const commentFormEl = card.querySelector(`#commentForm-${postId}`);
      const commentInputEl = card.querySelector(`#commentInput-${postId}`);
      const commentBtn = card.querySelector(`#commentBtn-${postId}`);
      if (currentUser) {
        commentFormEl.classList.remove('d-none');
      }
      commentBtn.addEventListener('click', () => {
        const text = commentInputEl.value.trim();
        addComment(postId, text);
        commentInputEl.value = '';
      });

      // "ê³„ê¸‰ ì´ëª¨í‹°ì½˜" í´ë¦­ ì‹œ -> í† ìŠ¤íŠ¸ë¡œ ê³„ê¸‰ëª…+ì ìˆ˜ í‘œì‹œ
      const rankIconEl = card.querySelector(`#rankIcon-${postId}`);
      rankIconEl.addEventListener('click', async () => {
        try {
          const userSnap = await fetchUserDoc(data.uid);
          if (userSnap.exists()) {
            const uData = userSnap.data();
            const s = uData.score || 0;
            const rInfo = getRankByScore(s);
            showToast(`ê³„ê¸‰: ${rInfo.name} (${s}ì )`, authorNickname);
          } else {
            showToast('ìœ ì € ì •ë³´ ì—†ìŒ', 'ì•Œë¦¼');
          }
        } catch (err) {
          showToast(err.message, 'ì•Œë¦¼');
        }
      });

      return card;
    }

    /********************************
     * ì‹¤ì‹œê°„ ê¸€ UI ê°±ì‹ 
     ********************************/
    function updatePostUI(postSnap) {
      const postId = postSnap.id;
      const data = postSnap.data();

      const likeCountEl = document.getElementById(`likeCount-${postId}`);
      const dislikeCountEl = document.getElementById(`dislikeCount-${postId}`);
      if (likeCountEl) likeCountEl.textContent = data.likes?.length || 0;
      if (dislikeCountEl) dislikeCountEl.textContent = data.dislikes?.length || 0;

      const likeBtn = document.getElementById(`likeBtn-${postId}`);
      const dislikeBtn = document.getElementById(`dislikeBtn-${postId}`);
      const currentUser = auth.currentUser;

      if (likeBtn && dislikeBtn && currentUser) {
        if (data.likes?.includes(currentUser.uid)) {
          likeBtn.classList.remove('btn-outline-primary');
          likeBtn.classList.add('btn-primary');
        } else {
          likeBtn.classList.remove('btn-primary');
          likeBtn.classList.add('btn-outline-primary');
        }
        if (data.dislikes?.includes(currentUser.uid)) {
          dislikeBtn.classList.remove('btn-outline-danger');
          dislikeBtn.classList.add('btn-danger');
        } else {
          dislikeBtn.classList.remove('btn-danger');
          dislikeBtn.classList.add('btn-outline-danger');
        }
      }
    }

    /********************************
     * ë¬´í•œ ìŠ¤í¬ë¡¤ -> 5ê°œì”© ì¡°íšŒ
     ********************************/
    let lastVisible = null;
    let isLoading = false;
    const PAGE_SIZE = 5;

    async function loadMorePosts() {
      if (isLoading) return;
      isLoading = true;

      let q = query(
        collection(db, 'posts'),
        orderBy('createdAt', 'desc'),
        limit(PAGE_SIZE)
      );

      if (lastVisible) {
        q = query(
          collection(db, 'posts'),
          orderBy('createdAt', 'desc'),
          startAfter(lastVisible),
          limit(PAGE_SIZE)
        );
      }

      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        let newLastDoc = null;

        for (let docSnap of snapshot.docs) {
          const item = await createPostItem(docSnap);
          postList.appendChild(item);

          // ê¸€ ë¬¸ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
          onSnapshot(doc(db, 'posts', docSnap.id), (updatedSnap) => {
            if (updatedSnap.exists()) {
              updatePostUI(updatedSnap);
            }
          });

          // ëŒ“ê¸€ ì‹¤ì‹œê°„
          const cmtQuery = query(
            collection(db, 'posts', docSnap.id, 'comments'),
            orderBy('createdAt', 'asc')
          );
          onSnapshot(cmtQuery, (cmtSnapshot) => {
            const cmtData = [];
            cmtSnapshot.forEach((cmtDoc) => {
              const cdata = cmtDoc.data();
              cdata.commentId = cmtDoc.id;
              cmtData.push(cdata);
            });
            const commentListEl = document.querySelector(`#commentList-${docSnap.id}`);
            if (commentListEl) {
              renderComments(docSnap.id, cmtData, commentListEl);
            }
          });

          newLastDoc = docSnap;
        }
        lastVisible = newLastDoc;
      }

      isLoading = false;
    }

    function convertLinks(text) {
      // URLì„ ë§í¬ë¡œ ë³€í™˜
      return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    // ìŠ¤í¬ë¡¤ ë°”ë‹¥ ê·¼ì ‘ -> ë‹¤ìŒ 5ê°œ ë¡œë“œ
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadMorePosts();
      }
    });

    // í˜ì´ì§€ ì²« ì§„ì… ì‹œ 5ê°œ ë¡œë“œ
    loadMorePosts();
  </script>
</body>
</html>
