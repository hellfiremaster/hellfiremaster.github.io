<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="뉴프로 카드 사진첩 & 카드 뽑기" />
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="뉴프로 카드 앨범" />
  <meta property="og:description" content="카드를 모아 기프트콘을 받아가요!" />
  <title>뉴프로 카드 앨범</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Jua&family=Comic+Neue:wght@400;700&family=Poor+Story&display=swap"
    rel="stylesheet">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="./common/common.css" />
  <style>
    .badge-soft {
      background: rgba(42, 64, 101, .15);
      color: #2a4065;
      border: 1px solid rgba(42, 64, 101, .25);
    }

    /* Reel (룰렛) */
    .reel-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      background: #0e1a31;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .08);
    }

    .reel-strip {
      display: flex;
      gap: 12px;
      padding: 12px;
      will-change: transform;
    }

    .reel-card {
      width: 110px;
      height: 150px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .5);
    }

    .reel-card img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }

    .reel-card::after {
      content: '?';
      position: absolute;
      inset: 0;
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 0 2px 8px rgba(0, 0, 0, .6);
    }

    .reel-indicator {
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 14px solid #ffd166;
      filter: drop-shadow(0 0 6px rgba(255, 209, 102, .9));
      z-index: 2;
    }

    .draw-area .btn-draw {
      position: relative;
      overflow: hidden;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(255, 105, 180, .6);
      background: #ff69b4;
    }

    .btn-draw::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, rgba(255, 255, 255, .6), rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0) 60%, rgba(255, 255, 255, .6));
      animation: shine 2.5s infinite;
    }

    @keyframes shine {
      0% {
        transform: translate(-100%, -100%)
      }

      50% {
        transform: translate(100%, 100%)
      }

      100% {
        transform: translate(-100%, -100%)
      }
    }

    /* Single Card Spinner */
    .single-wrap {
      height: 240px;
      position: relative;
    }

    .single-card {
      width: 180px;
      height: 260px;
      border-radius: 14px;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
      position: relative;
      transform-style: preserve-3d;
      transition: transform 600ms cubic-bezier(.2, .8, .2, 1);
      margin: 0 auto;
    }

    .single-card.shuffling {
      animation: jiggle 800ms ease-in-out infinite;
      box-shadow: 0 10px 28px rgba(255, 105, 180, .35), 0 0 0 3px rgba(255, 255, 255, .06) inset;
    }

    .single-card.flash::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0) 60%);
      opacity: 0;
      pointer-events: none;
      animation: flash 240ms ease-out;
      border-radius: 14px;
    }

    .single-card.revealed {
      transform: rotateY(180deg);
    }

    .face {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      border-radius: 14px;
      overflow: hidden;
    }

    .face.back {
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 64px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .6);
    }

    .face.front {
      transform: rotateY(180deg);
      background: #000;
    }

    .face.front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @keyframes jiggle {
      0% {
        transform: rotateY(-12deg) scale(1.0);
      }

      50% {
        transform: rotateY(0deg) scale(1.02);
      }

      100% {
        transform: rotateY(12deg) scale(1.0);
      }
    }

    @keyframes flash {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* 앨범 그리드 */
    .album-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 14px;
    }

    .album-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #f0f3f8;
      border: 1px solid #e5eaf2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
    }

    .album-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .album-card .label {
      position: absolute;
      left: 8px;
      top: 8px;
      background: rgba(0, 0, 0, .6);
      color: #fff;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: .9rem;
    }

    .album-card.locked::before {
      content: "🔒";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: rgba(0, 0, 0, .35);
      color: #fff;
    }

    .album-card.locked img {
      filter: blur(6px) grayscale(100%);
      transform: scale(1.05);
    }

    /* Giftcon */
    .giftcon {
      background: #fff;
      border-radius: 16px;
      border: 1px dashed #ccd4e0;
      overflow: hidden;
    }

    .giftcon-header {
      padding: 14px;
      background: linear-gradient(135deg, #ffe08a, #ffd166);
      font-weight: 700;
      text-align: center;
    }

    .giftcon-body {
      padding: 16px;
    }

    .barcode-wrap {
      background: #111;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }

    .toast.dark-bg {
      background: rgba(0, 0, 0, .85);
      color: #fff;
    }

    .toast.dark-bg .toast-header {
      background: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }

    .toast.dark-bg .btn-close {
      filter: invert(1);
    }

    /* Loader */
    #fullScreenLoader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 3000;
    }

    .loader-content {
      text-align: center;
      color: #fff;
      animation: pulse 1.5s infinite;
    }

    .loader-text {
      font-size: 1.4rem;
      margin-top: .5rem;
      font-family: 'Poor Story', sans-serif;
    }

    @keyframes pulse {
      0% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.06)
      }

      100% {
        transform: scale(1)
      }
    }
  </style>
</head>

<body>
  <!-- Fullscreen Loader -->
  <div id="fullScreenLoader">
    <div class="loader-content">
      <div class="emoji-large" style="font-size:3rem">🐱‍💻</div>
      <p class="loader-text">처리 중이냥~ 기다려줘냥~</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="menu-container"></div>

  <section class="hero-section">
    <h1 class="hero-title">뉴프로 카드 앨범</h1>
    <p class="hero-subtitle">카드를 모아모아~ 전부 모으면 🎁 기프트콘이 짜잔!</p>
  </section>

  <div class="container pb-5">
    <!-- Draw Area -->
    <div class="glass-card p-3 p-md-4 mb-4 draw-area">
      <div class="d-flex justify-content-between flex-wrap align-items-center gap-2 mb-3">
        <div>
          <span class="badge badge-soft me-2">수집 현황</span>
          <span class="fw-bold" id="progressText">0 / 0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-light btn-sm" id="showGiftBtn" disabled>🎁 기프트 확인</button>
          <button class="btn btn-draw" id="drawBtn">🎲 카드 뽑기</button>
        </div>
      </div>

      <div class="single-wrap d-flex justify-content-center align-items-center">
        <div class="single-card" id="card3d">
          <div class="face back" id="cardBack">?</div>
          <div class="face front"><img id="frontImg" src="" alt="card"></div>
        </div>
      </div>
      <small class="text-muted d-block mt-2">버튼을 누르면 카드가 섞이다가 번쩍! 앞면이 공개돼요. (결과 카드는 Firebase Functions에서 리턴!)</small>
    </div>

    <!-- Album -->
    <div class="glass-card p-3 p-md-4">
      <h5 class="mb-3 adventure">내 사진첩</h5>
      <div class="album-grid" id="albumGrid"></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cardModalTitle">카드</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="cardModalImg" src="" alt="card"
            style="max-width:100%; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2)" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Giftcon Modal -->
  <div class="modal fade" id="giftModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">축하해요! 모든 카드 모음 완료 🎉</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="giftcon">
            <div class="giftcon-header">뉴프로 기프트콘</div>
            <div class="giftcon-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="p-3 rounded" style="background:#f8fafc; border:1px solid #e9eef6">
                    <h6 class="mb-2">🎁 상품명</h6>
                    <div class="fs-5 fw-bold">뉴프로 모험가 기프트</div>
                    <div class="small text-muted">모은 날짜: <span id="giftDate">-</span></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="barcode-wrap">
                    <canvas id="barcodeCanvas" width="420" height="120" aria-label="barcode"></canvas>
                  </div>
                  <div class="text-center mt-2 small text-muted">바코드 번호: <span id="barcodeNum">-</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal">꺄~ 고마워요!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 로그인/회원가입 모달 -->
  <div id="auth-modal-container"></div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="./common/common.js"></script>
  <script type="module" src="./common/auth.js"></script>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { auth, db, functions, storage, analytics } from './common/firebase-init.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app-check.js';
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, where } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-functions.js';

    /* ------------------ UI Helpers ------------------ */
    const toastEl = document.getElementById('liveToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMsg = document.getElementById('toastMessage');
    function showToast(message, title = '알림', duration = 4000) {
      toastTitle.textContent = title; toastMsg.innerHTML = message.replace(/\n/g, '<br/>');
      const bsToast = new bootstrap.Toast(toastEl, { delay: duration }); bsToast.show();
    }
    function showLoader(show) { document.getElementById('fullScreenLoader').style.display = show ? 'flex' : 'none'; }
    function launchFireworks(ms = 1600) {
      const end = Date.now() + ms; const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2000 };
      const interval = setInterval(() => { const timeLeft = end - Date.now(); if (timeLeft <= 0) { clearInterval(interval); return; } const particleCount = 50 * (timeLeft / ms); confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } })); }, 250);
    }

    /* ------------------ Cards Data ------------------ */
    const CARDS = [
      { key: 'ddaknim', name: '딱님', file: './images/ddaknim.png' },
      { key: 'hellmaster', name: '헬마스터', file: './images/hellmaster.png' },
      { key: 'newpro_fairy', name: '뉴프로 요정', file: './images/newpro_fairy.png' },
      { key: 'svn', name: 'svn', file: './images/svn.png' },
      { key: 'pierrot', name: '피에로가르뎅', file: './images/pierrot.png' },
      { key: 'aska', name: '아스카', file: './images/aska.png' },
      { key: 'mungyu', name: '멍규', file: './images/mungyu.png' },
      { key: 'ryudog_master', name: '류독 마스터', file: './images/ryudog_master.png' },
      { key: 'gayuna', name: '가유나', file: './images/gayuna.png' },
      { key: 'mungmyu', name: '멍뮤', file: './images/mungmyu.png' },
      { key: 'tdt', name: 'TDT', file: './images/tdt.png' }
    ];

    const progressText = document.getElementById('progressText');
    const albumGrid = document.getElementById('albumGrid');
    const reelStrip = document.getElementById('reelStrip');
    const reelWrap = document.getElementById('reelWrap');
    const drawBtn = document.getElementById('drawBtn');
    const showGiftBtn = document.getElementById('showGiftBtn');
    // (single card mode - no reel build)

    // Album grid
    function renderAlbum(collectedSet) {
      albumGrid.innerHTML = '';
      CARDS.forEach(card => {
        const isOwned = collectedSet.has(card.key);
        const div = document.createElement('div');
        div.className = 'album-card' + (isOwned ? '' : ' locked');
        div.innerHTML = `<span class="label">${card.name}</span><img src="${card.file}" alt="${card.name}">`;
        if (isOwned) {
          div.addEventListener('click', () => openCardModal(card));
        }
        albumGrid.appendChild(div);
      });
      progressText.textContent = `${collectedSet.size} / ${CARDS.length}`;
      showGiftBtn.disabled = !(collectedSet.size === CARDS.length);
    }

    // Modals
    const cardModal = new bootstrap.Modal(document.getElementById('cardModal'));
    function openCardModal(card) {
      document.getElementById('cardModalTitle').textContent = card.name;
      document.getElementById('cardModalImg').src = card.file;
      cardModal.show();
    }

    // Giftcon
    const giftModal = new bootstrap.Modal(document.getElementById('giftModal'));
    function drawBarcode(canvas, code) {
      const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height;
      ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#000';
      // simple pseudo barcode: map digits to bar widths
      let x = 10; const top = 10; const bottom = H - 10;
      for (let i = 0; i < code.length; i++) {
        const d = code.charCodeAt(i) % 7 + 1; // 1..7
        ctx.fillRect(x, top, d + 1, bottom - top);
        x += d + 2; // gap
        if (x > W - 10) break;
      }
    }
    function openGift() {
      const now = new Date();
      document.getElementById('giftDate').textContent = now.toLocaleString();
      (async () => {
        try {
          const getGiftcon = httpsCallable(functions, 'getGiftcon');
          const res = await getGiftcon();
          const url = res?.data?.url || null;
          const barcode = res?.data?.barcode || null;
          const body = document.querySelector('#giftModal .giftcon-body');
          let img = document.getElementById('giftImg');
          if (!img) { img = document.createElement('img'); img.id = 'giftImg'; img.alt = 'gift'; img.style.cssText = 'width:100%;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);margin-bottom:12px'; body.prepend(img); }
          if (url) img.src = url;
          const canvas = document.getElementById('barcodeCanvas');
          const numEl = document.getElementById('barcodeNum');
          if (barcode) { numEl.textContent = barcode; drawBarcode(canvas, barcode); }
          else {
            const code = 'NP-' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + Math.random().toString(36).slice(2, 8).toUpperCase();
            numEl.textContent = code; drawBarcode(canvas, code);
          }
          giftModal.show(); launchFireworks(2000);
        } catch (e) {
          // 폴백: 로컬 바코드만 표시
          const code = 'NP-' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + Math.random().toString(36).slice(2, 8).toUpperCase();
          document.getElementById('barcodeNum').textContent = code;
          drawBarcode(document.getElementById('barcodeCanvas'), code);
          giftModal.show(); launchFireworks(2000);
        }
      })();
    }
    document.getElementById('showGiftBtn').addEventListener('click', openGift);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        collected = await fetchMyCards(user.uid); renderAlbum(collected);
      } else {
        collected = new Set(); renderAlbum(collected);
      }
    });

    async function getNickname(uid) {
      try { const snap = await getDoc(doc(db, 'users', uid)); return snap.exists() ? (snap.data().nickname || '익명') : '익명'; } catch { return '익명'; }
    }

    /* ------------------ Draw Animation (single card shuffle + flip reveal) ------------------ */
    let collected = new Set();
    const card3d = document.getElementById('card3d');
    const backFace = document.getElementById('cardBack');
    const frontImg = document.getElementById('frontImg');
    let isShuffling = false;

    const SOUND_ENABLED = true;     // 소리 끄려면 false로!
    const MIN_WAIT = 1200;          // 최소 섞는 시간(ms)
    const TICK_EVERY = 160;         // 딱- 소리 템포

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    function playTick() {
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        const ctx = new Ctx(); const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square'; o.frequency.value = 1000; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.05);
        o.start(); o.stop(ctx.currentTime + 0.06);
      } catch (_) { }
    }

    async function fetchChosenKey() {
      try { const drawCard = httpsCallable(functions, 'drawCard'); const res = await drawCard(); return res?.data?.cardKey; }
      catch (_) { /* ignore */ }
      const notOwned = CARDS.filter(c => !collected.has(c.key));
      const pool = notOwned.length ? notOwned : CARDS;
      return pool[Math.floor(Math.random() * pool.length)].key;
    }

    let tickTimer = null, faceTimer = null; // 사운드 & 물음표 애니메이션
    const BACK_GLYPHS = ['?', '★', '☆', '❋', '✦', '✧', '❖', '♦'];

    async function drawOnce() {
      const user = auth.currentUser;
      if (!user) { showToast('로그인해줘~ 카드 뽑으려면 필요해!', '반가워'); const modal = new bootstrap.Modal(document.getElementById('loginModal')); modal.show(); return; }
      if (isShuffling) return;

      isShuffling = true; drawBtn.disabled = true;
      card3d.classList.remove('revealed');
      card3d.classList.add('shuffling');
      backFace.textContent = BACK_GLYPHS[0];

      if (SOUND_ENABLED) tickTimer = setInterval(playTick, TICK_EVERY);
      faceTimer = setInterval(() => {
        const i = Math.floor(Math.random() * BACK_GLYPHS.length);
        backFace.textContent = BACK_GLYPHS[i];
      }, 120);

      const keyPromise = fetchChosenKey();
      await Promise.all([keyPromise, wait(MIN_WAIT)]);

      let chosenKey = null; try { chosenKey = await keyPromise; } catch { }
      const card = CARDS.find(c => c.key === chosenKey) || CARDS[Math.floor(Math.random() * CARDS.length)];

      if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
      if (faceTimer) { clearInterval(faceTimer); faceTimer = null; }

      frontImg.src = card.file;          // 앞면 세팅
      card3d.classList.remove('shuffling');
      card3d.classList.add('flash');     // 반짝!
      setTimeout(() => { card3d.classList.remove('flash'); card3d.classList.add('revealed'); }, 120);

      openCardModal(card);

      collected = await fetchMyCards(user.uid);
      console.log('collected', collected);
      renderAlbum(collected);
      if (collected.size === CARDS.length) { openGift(); }

      isShuffling = false; drawBtn.disabled = false;
    }

    drawBtn.addEventListener('click', drawOnce);

    async function fetchMyCards(uid) {
      try {
        // /users_private/{uid}/cards에서 pulls >= 1 인 문서만!
        const q = query(
          collection(db, 'users_private', uid, 'cards'),
          where('pulls', '>=', 1)
        );
        const snap = await getDocs(q);
        const set = new Set();
        snap.forEach(d => {
          const data = d.data();
          // 문서 id가 key일 수도, 필드로 key를 갖고 있을 수도 있으니 둘 다 케어!
          const k = (data && data.key) ? data.key : d.id;
          // pulls가 1 이상이면 앨범에서 컬러로 보여줄 대상이야
          if (typeof data?.pulls === 'number' && data.pulls >= 1) {
            set.add(k);
          }
        });
        return set;
      } catch {
        return new Set();
      }
    }
  </script>
</body>

</html>