<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ë‰´í”„ë¡œ ì¹´ë“œ ì‚¬ì§„ì²© & ì¹´ë“œ ë½‘ê¸°" />
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="ë‰´í”„ë¡œ ì¹´ë“œ ì•¨ë²”" />
  <meta property="og:description" content="ì¹´ë“œë¥¼ ëª¨ì•„ ê¸°í”„íŠ¸ì½˜ì„ ë°›ì•„ê°€ìš”!" />
  <title>ë‰´í”„ë¡œ ì¹´ë“œ ì•¨ë²”</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Jua&family=Comic+Neue:wght@400;700&family=Poor+Story&display=swap"
    rel="stylesheet">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="./common/common.css" />
  <style>
    .gift-image {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    .badge-soft {
      background: rgba(42, 64, 101, .15);
      color: #2a4065;
      border: 1px solid rgba(42, 64, 101, .25);
    }

    /* Reel (ë£°ë ›) */
    .reel-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      background: #0e1a31;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .08);
    }

    .reel-strip {
      display: flex;
      gap: 12px;
      padding: 12px;
      will-change: transform;
    }

    .reel-card {
      width: 110px;
      height: 150px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .5);
    }

    .reel-card img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }

    .reel-card::after {
      content: '?';
      position: absolute;
      inset: 0;
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 0 2px 8px rgba(0, 0, 0, .6);
    }

    .reel-indicator {
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 14px solid #ffd166;
      filter: drop-shadow(0 0 6px rgba(255, 209, 102, .9));
      z-index: 2;
    }

    .draw-area .btn-draw {
      position: relative;
      overflow: hidden;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(255, 105, 180, .6);
      background: #ff69b4;
    }

    .btn-draw::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, rgba(255, 255, 255, .6), rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0) 60%, rgba(255, 255, 255, .6));
      animation: shine 2.5s infinite;
    }

    @keyframes shine {
      0% {
        transform: translate(-100%, -100%)
      }

      50% {
        transform: translate(100%, 100%)
      }

      100% {
        transform: translate(-100%, -100%)
      }
    }

    /* Single Card Spinner */
    .single-wrap {
      height: 240px;
      position: relative;
    }

    .single-card {
      width: 180px;
      height: 260px;
      border-radius: 14px;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
      position: relative;
      transform-style: preserve-3d;
      transition: transform 600ms cubic-bezier(.2, .8, .2, 1);
      margin: 0 auto;
    }

    .single-card.shuffling {
      animation: jiggle 800ms ease-in-out infinite;
      box-shadow: 0 10px 28px rgba(255, 105, 180, .35), 0 0 0 3px rgba(255, 255, 255, .06) inset;
    }

    .single-card.flash::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0) 60%);
      opacity: 0;
      pointer-events: none;
      animation: flash 240ms ease-out;
      border-radius: 14px;
    }

    .single-card.revealed {
      transform: rotateY(180deg);
    }

    .face {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      border-radius: 14px;
      overflow: hidden;
    }

    .face.back {
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 64px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .6);
    }

    .face.front {
      transform: rotateY(180deg);
      background: #000;
    }

    .face.front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @keyframes jiggle {
      0% {
        transform: rotateY(-12deg) scale(1.0);
      }

      50% {
        transform: rotateY(0deg) scale(1.02);
      }

      100% {
        transform: rotateY(12deg) scale(1.0);
      }
    }

    @keyframes flash {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* ì•¨ë²” ê·¸ë¦¬ë“œ */
    .album-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 14px;
    }

    .album-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #f0f3f8;
      border: 1px solid #e5eaf2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
    }

    .album-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .album-card .label {
      position: absolute;
      left: 8px;
      top: 8px;
      background: rgba(0, 0, 0, .6);
      color: #fff;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: .9rem;
    }

    .album-card.locked::before {
      content: "ğŸ”’";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: rgba(0, 0, 0, .35);
      color: #fff;
    }

    .album-card.locked img {
      filter: blur(6px) grayscale(100%);
      transform: scale(1.05);
    }

    /* Giftcon */
    .giftcon {
      background: #fff;
      border-radius: 16px;
      border: 1px dashed #ccd4e0;
      overflow: hidden;
    }

    .giftcon-header {
      padding: 14px;
      background: linear-gradient(135deg, #ffe08a, #ffd166);
      font-weight: 700;
      text-align: center;
    }

    .giftcon-body {
      padding: 16px;
    }

    .barcode-wrap {
      background: #111;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }

    .toast.dark-bg {
      background: rgba(0, 0, 0, .85);
      color: #fff;
    }

    .toast.dark-bg .toast-header {
      background: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }

    .toast.dark-bg .btn-close {
      filter: invert(1);
    }

    /* Loader */
    #fullScreenLoader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 3000;
    }

    .loader-content {
      text-align: center;
      color: #fff;
      animation: pulse 1.5s infinite;
    }

    .loader-text {
      font-size: 1.4rem;
      margin-top: .5rem;
      font-family: 'Poor Story', sans-serif;
    }

    @keyframes pulse {
      0% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.06)
      }

      100% {
        transform: scale(1)
      }
    }

    /* --- ì¹´ë“œ ëª¨ë‹¬ ì „ìš© --- */
    #cardModal .modal-content {
      background: transparent !important;
      border: none;
      box-shadow: none;
    }

    #cardModal .modal-header,
    #cardModal .modal-footer {
      display: none;
    }

    #cardModal .modal-body {
      padding: 0;
    }

    /* ì¹´ë“œ ì´ë¯¸ì§€ */
    #cardModalImg {
      max-width: 90%;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.65);
      transform: translateY(0);
      transition: transform 0.35s ease, box-shadow 0.35s ease;
    }

    #cardModalImg:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
    }

    /* ì œëª© (ìº¡ì…˜ ìŠ¤íƒ€ì¼) */
    #cardModalTitle.card-caption {
      font-family: 'Jua', cursive;
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 
        0 2px 4px rgba(0,0,0,0.6),
        0 0 8px rgba(255,255,255,0.2);
      letter-spacing: 1px;
      animation: fadeInUp 0.5s ease;
    }

    /* ë’·ë°°ê²½ */
    #cardModal.modal.fade .modal-backdrop.show {
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(4px);
    }

    /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #cardModalTitle.card-caption {
      cursor: default;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Fullscreen Loader -->
  <div id="fullScreenLoader">
    <div class="loader-content">
      <div class="emoji-large" style="font-size:3rem">ğŸ±â€ğŸ’»</div>
      <p class="loader-text">ì²˜ë¦¬ ì¤‘ì´ëƒ¥~ ê¸°ë‹¤ë ¤ì¤˜ëƒ¥~</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="menu-container"></div>

  <section class="hero-section">
    <h1 class="hero-title">ë‰´í”„ë¡œ ì¹´ë“œ ì•¨ë²”</h1>
    <p class="hero-subtitle">ì¹´ë“œë¥¼ ëª¨ì•„ëª¨ì•„~ ì „ë¶€ ëª¨ìœ¼ë©´ ğŸ ê¸°í”„íŠ¸ì½˜ì´ ì§œì”!</p>
  </section>

  <div class="container pb-5">
    <!-- Draw Area -->
    <div class="glass-card p-3 p-md-4 mb-4 draw-area">
      <div class="d-flex justify-content-between flex-wrap align-items-center gap-2 mb-3">
        <div>
          <span class="badge badge-soft me-2">ìˆ˜ì§‘ í˜„í™©</span>
          <span class="fw-bold" id="progressText">0 / 0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-light btn-sm" id="showGiftBtn">ğŸ ê¸°í”„íŠ¸ í™•ì¸</button>
          <button class="btn btn-draw" id="drawBtn">ğŸ² ì¹´ë“œ ë½‘ê¸°</button>
        </div>
      </div>

      <div class="single-wrap d-flex justify-content-center align-items-center">
        <div class="single-card" id="card3d">
          <div class="face back" id="cardBack">?</div>
          <div class="face front"><img id="frontImg" src="" alt="card"></div>
        </div>
      </div>

      <small id="eventInfoText" class="text-muted d-block mt-3"></small>
    </div>

    <!-- Album -->
    <div class="glass-card p-3 p-md-4">
      <h5 class="mb-3 adventure">ë‚´ ì‚¬ì§„ì²©</h5>
      <div class="album-grid" id="albumGrid"></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade card-preview-modal" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <!-- ì¹´ë“œ ì´ë¯¸ì§€ -->
          <img id="cardModalImg" src="" alt="card" />

          <!-- ì¹´ë“œ ì œëª© (card.name ì„¸íŒ…ë¨) -->
          <h5 id="cardModalTitle" class="card-caption mt-3" data-bs-dismiss="modal" aria-label="Close"></h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Giftcon Modal -->
  <div class="modal fade" id="giftModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
        
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">ì¶•í•˜í•´ìš”! ëª¨ë“  ì¹´ë“œ ëª¨ìŒ ì™„ë£Œ ğŸ‰</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <!-- ì •ë³´ ì¹´ë“œ -->
          <div class="p-3 rounded" style="background:#f8fafc; border:1px solid #e9eef6">
            <h6 class="mb-2">ğŸ ìƒí’ˆëª…</h6>
            <div class="fs-5 fw-bold">ë‰´í”„ë¡œ ëª¨í—˜ê°€ ê¸°í”„íŠ¸</div>
            <div class="small text-muted">ëª¨ì€ ë‚ ì§œ: <span id="giftDate">-</span></div>
            <img id="giftImg" alt="gift" class="gift-image mt-3" />
            <div class="small text-danger mt-3">
              ì´ë²¤íŠ¸ ì¢…ë£Œì¼ê¹Œì§€ë§Œ ì €ì¥ ê°€ëŠ¥í•˜ë‹ˆ ê¼­ ë¯¸ë¦¬ ë‹¤ìš´ë°›ì•„ì£¼ì„¸ìš”!
            </div>
          </div>
        </div> 

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary" id="saveGiftBtn">ì´ë¯¸ì§€ ì €ì¥</button>
          <button class="btn btn-primary" data-bs-dismiss="modal">êº„~ ê³ ë§ˆì›Œìš”!</button>
        </div>
  
      </div>
    </div>
  </div>

  <!-- Submit Winner Confirm Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px; overflow:hidden;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">ì¹´ë“œ ì œì¶œ & ê¸°í”„íŠ¸ì½˜ ë°›ê¸°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ëª¨ë“  ì¹´ë“œë¥¼ ëª¨ì•˜ì–´ìš”! ì§€ê¸ˆ ë°”ë¡œ ì œì¶œí•˜ê³  ê¸°í”„íŠ¸ì½˜ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ¥³
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" id="cancelSubmitBtn" data-bs-dismiss="modal">ìŒ.. ë‚˜ì¤‘ì—</button>
          <button type="button" class="btn btn-primary" id="confirmSubmitBtn">ë„¤! ì œì¶œí• ë˜ìš” ğŸ’</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div id="auth-modal-container"></div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script type="module" src="./common/common.js"></script>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { auth, db, functions, storage, analytics } from './common/firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';
    import { doc, getDoc, setDoc, getDocs, collection, query, where, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-functions.js';

    const getGiftcon = httpsCallable(functions, 'getGiftcon');
    const drawCard = httpsCallable(functions, 'drawCard'); 
    const addWinner  = httpsCallable(functions, 'addWinner');

    /* ------------------ UI Helpers ------------------ */
    function showLoader(show) { document.getElementById('fullScreenLoader').style.display = show ? 'flex' : 'none'; }
    function launchFireworks(ms = 1600) {
      const end = Date.now() + ms; const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2000 };
      const interval = setInterval(() => { const timeLeft = end - Date.now(); if (timeLeft <= 0) { clearInterval(interval); return; } const particleCount = 50 * (timeLeft / ms); confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } })); }, 250);
    }

    /* ------------------ Cards Data ------------------ */
    const CARDS = [
      { key: 'ddaknim', name: 'ë”±ë‹˜', file: './images/ddaknim.png' },
      { key: 'hellmaster', name: 'í—¬ë§ˆìŠ¤í„°', file: './images/hellmaster.png' },
      { key: 'newpro_fairy', name: 'ë‰´í”„ë¡œ ìš”ì •', file: './images/newpro_fairy.png' },
      { key: 'svn', name: 'svn', file: './images/svn.png' },
      { key: 'pierrot', name: 'í”¼ì—ë¡œê°€ë¥´ë…', file: './images/pierrot.png' },
      { key: 'aska', name: 'ì•„ìŠ¤ì¹´', file: './images/aska.png' },
      { key: 'mungyu', name: 'ë©ìœ ', file: './images/mungyu.png' },
      { key: 'ryudog_master', name: 'ë£¨ë„ê·¸ë‘ ë‘¥', file: './images/ryudog_master.png' },
      { key: 'gayuna', name: 'ê°€ì—°ì•„', file: './images/gayuna.png' },
      { key: 'mungmyu', name: 'ë©ë®¤', file: './images/mungmyu.png' },
      { key: 'tdt', name: 'ã…†ã…‡ã…†', file: './images/tdt.png' }
    ];

    const progressText = document.getElementById('progressText');
    const albumGrid = document.getElementById('albumGrid');
    const reelStrip = document.getElementById('reelStrip');
    const reelWrap = document.getElementById('reelWrap');
    const drawBtn = document.getElementById('drawBtn');
    const showGiftBtn = document.getElementById('showGiftBtn');
    // (single card mode - no reel build)

    const submitModalEl = document.getElementById('submitModal');
    const submitModal   = new bootstrap.Modal(submitModalEl, { backdrop: 'static', keyboard: false });
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const cancelSubmitBtn  = document.getElementById('cancelSubmitBtn');

    function confirmSubmitModal() {
      return new Promise((resolve) => {
        let decision = null;

        const onHidden = () => { off(); resolve(!!decision); };
        const onConfirm = () => { decision = true;  submitModal.hide(); };
        const onCancel  = () => { decision = false; submitModal.hide(); };

        function off() {
          confirmSubmitBtn.removeEventListener('click', onConfirm);
          cancelSubmitBtn.removeEventListener('click', onCancel);
          submitModalEl.removeEventListener('hidden.bs.modal', onHidden);
        }

        confirmSubmitBtn.addEventListener('click', onConfirm, { once: true });
        cancelSubmitBtn.addEventListener('click', onCancel,  { once: true });
        submitModalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });

        submitModal.show();
      });
    }

    // Album grid
    function renderAlbum(collectedSet) {
      albumGrid.innerHTML = '';
      CARDS.forEach(card => {
        const isOwned = collectedSet.has(card.key);
        const div = document.createElement('div');
        div.className = 'album-card' + (isOwned ? '' : ' locked');
        div.innerHTML = `<span class="label">${card.name}</span><img src="${card.file}" alt="${card.name}">`;
        if (isOwned) {
          div.addEventListener('click', () => openCardModal(card));
        }
        albumGrid.appendChild(div);
      });
      progressText.textContent = `${collectedSet.size} / ${CARDS.length}`;
      // showGiftBtn.disabled = !(collectedSet.size === CARDS.length);
    }

    // Modals
    const cardModal = new bootstrap.Modal(document.getElementById('cardModal'));
    function openCardModal(card) {
      document.getElementById('cardModalTitle').textContent = card.name;
      document.getElementById('cardModalImg').src = card.file;
      cardModal.show();
    }

    // Giftcon
    const giftModal = new bootstrap.Modal(document.getElementById('giftModal'));
    function drawBarcode(canvas, code) {
      const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height;
      ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#000';
      // simple pseudo barcode: map digits to bar widths
      let x = 10; const top = 10; const bottom = H - 10;
      for (let i = 0; i < code.length; i++) {
        const d = code.charCodeAt(i) % 7 + 1; // 1..7
        ctx.fillRect(x, top, d + 1, bottom - top);
        x += d + 2; // gap
        if (x > W - 10) break;
      }
    }

    async function maybeSubmitWinner() {      
      // ìµœì‹  winnerUid í™•ì¸ì„ ìœ„í•´ í•œë²ˆ ë” ìƒˆë¡œê³ ì¹¨!
      await initEventInfo();

      // ì¡°ê±´: ì´ë²¤íŠ¸ ì§„í–‰ì¤‘ + ì „ì¹´ë“œ ëª¨ìŒ ì™„ë£Œ + ì•„ì§ ìš°ìŠ¹ì ë¯¸ì •
      if (eventActive && collected.size === CARDS.length && !winnerUid) {
        const ok = await confirmSubmitModal();
        if (!ok) return false;

        try {
          showLoader(true);
          // ì„œë²„ ì¸¡ addWinnerê°€ í˜„ì¬ í™œì„± ì´ë²¤íŠ¸ì˜ ìŠ¹ìë¥¼ "ë‚˜"ë¡œ ê¸°ë¡í•œë‹¤ê³  ê°€ì •!
          await addWinner();
          // ë“±ë¡ì´ ëë‚¬ìœ¼ë‹ˆ ë‹¤ì‹œ ì´ë²¤íŠ¸ ì •ë³´ ê°€ì ¸ì™€ì„œ winnerUidê°€ ì±„ì›Œì¡ŒëŠ”ì§€ ë³´ì •
          await initEventInfo();
        } catch (e) {
          showToast(e?.message ?? 'ìŠ¹ì ë“±ë¡ì— ì‹¤íŒ¨í–ˆì–´ìš” ã… ã… ');
          return false;
        } finally {
          showLoader(false);
        }
      }
      return true;
    }

    async function openGift() { 
      if (!eventActive) {
        showToast('í˜„ì¬ ì´ë²¤íŠ¸ ì§„í–‰ì¤‘ì´ ì•„ë‹ˆì—ìš”!');
        return;
      }
      const user = auth.currentUser;
      if (!user) { 
        requireLogin(); 
        return; 
      }
      if(collected.size !== CARDS.length && winnerUid !== user.uid) {
        showToast('ëª¨ë“  ì¹´ë“œë¥¼ ëª¨ì•„ ì œì¶œí•˜ì„¸ìš”!');
        return; 
      }
      // ìƒí™©ì— ë”°ë¼ ìŠ¹ì ë“±ë¡ ë¨¼ì €
      const proceed = await maybeSubmitWinner();
      if (!proceed) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆê±°ë‚˜ ì‹¤íŒ¨

      try {
        const res = await getGiftcon();
        console.log('res', res)
        const url = res.data.url;
        const strDate = moment(res.data.winnerAt).format('YYYY-MM-DD HH:mm');
        document.getElementById('giftDate').textContent = strDate;
        const img = document.getElementById('giftImg');
        img.src = url;

        giftModal.show();
        launchFireworks(2000);
      } catch (e) {
        showToast(e.message);
      }
    }

    document.getElementById('showGiftBtn').addEventListener('click', openGift);

    document.getElementById('saveGiftBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      const img = document.getElementById('giftImg');
      const filename = 'gift.png';

      // 1) fetchë¡œ Blob ë°›ì•„ì„œ ì €ì¥ (ê°€ì¥ í˜¸í™˜ì„± ì¢‹ìŒ)
      try {
        const res = await fetch(img.src, { mode: 'cors', cache: 'no-store' });
        // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” opaque ì‘ë‹µ(no-cors)ë¡œ ì˜¤ë©´ ë‹¤ìš´ë¡œë“œ ë¶ˆê°€
        if (!res.ok || !res.body) throw new Error('fetch failed');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        return;
      } catch (err) {
        console.warn('blob download failed, try canvas:', err);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        collected = await fetchMyCards(user.uid); 
        renderAlbum(collected);
      } else {
        collected = new Set();
        renderAlbum(collected);
      }
    });

    /* ------------------ Draw Animation (single card shuffle + flip reveal) ------------------ */
    let collected = new Set();
    const card3d = document.getElementById('card3d');
    const backFace = document.getElementById('cardBack');
    const frontImg = document.getElementById('frontImg');
    let isShuffling = false;

    // const SOUND_ENABLED = true;     // ì†Œë¦¬ ë„ë ¤ë©´ falseë¡œ!
    const MIN_WAIT = 1200;          // ìµœì†Œ ì„ëŠ” ì‹œê°„(ms)
    const TICK_EVERY = 160;         // ë”±- ì†Œë¦¬ í…œí¬

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    let tickTimer = null, faceTimer = null; // ì‚¬ìš´ë“œ & ë¬¼ìŒí‘œ ì• ë‹ˆë©”ì´ì…˜
    const BACK_GLYPHS = ['?', 'â˜…', 'â˜†', 'â‹', 'âœ¦', 'âœ§', 'â–', 'â™¦'];

    // --- ê³µí†µ ë¦¬ì…‹ ìœ í‹¸ ---
    function resetShuffleUI() {
      // 1) íƒ€ì´ë¨¸ ì •ë¦¬
      if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
      if (faceTimer) { clearInterval(faceTimer); faceTimer = null; }

      // 2) ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì •ë¦¬ (revealedëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
      card3d.classList.remove('shuffling', 'flash');

      // 3) ì• ë‹ˆë©”ì´ì…˜ ì”ìƒ ëŠê¸° (ë¦¬í”Œë¡œìš°)
      card3d.style.animation = 'none';
      card3d.getBoundingClientRect(); // ê°•ì œ ë¦¬í”Œë¡œìš°
      card3d.style.animation = '';

      // 4) ë°±ë©´ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” + ìƒíƒœ ë³µêµ¬
      backFace.textContent = BACK_GLYPHS[0];
      isShuffling = false;
      drawBtn.disabled = false;
    }

    async function drawOnce() {
      if (!eventActive) {
        showToast('í˜„ì¬ ì´ë²¤íŠ¸ ì§„í–‰ì¤‘ì´ ì•„ë‹ˆì—ìš”!');
        return;
      }
      if(winnerNickname) {
        showToast(`${winnerNickname}ì”¨ê°€ ì´ë¯¸ ì´ë²¤íŠ¸ ë‹¹ì²¨ì ì´ì‹­ë‹ˆë‹¤!`);

        return;
      }

      const user = auth.currentUser;
      if (!user) { requireLogin(); return; }
      if (isShuffling) return;

      isShuffling = true;
      drawBtn.disabled = true;

      // ì‹œì‘ ìƒíƒœ ì„¸íŒ…
      card3d.classList.remove('revealed', 'flash'); // ì•ë©´ ë‹«ê³ 
      card3d.classList.add('shuffling');            // í”ë“¤í”ë“¤ ì‹œì‘
      backFace.textContent = BACK_GLYPHS[0];

      // if (SOUND_ENABLED) tickTimer = setInterval(playTick, TICK_EVERY);
      faceTimer = setInterval(() => {
        backFace.textContent = BACK_GLYPHS[Math.floor(Math.random() * BACK_GLYPHS.length)];
      }, 120);

      try {
        // ì„œë²„ ê²°ê³¼ + ìµœì†Œ ëŒ€ê¸° ë™ì‹œ
        const [cardRes] = await Promise.all([drawCard(), wait(MIN_WAIT)]);
        const chosenKey = cardRes.data.cardKey
        const card = CARDS.find(c => c.key === chosenKey) || CARDS[Math.floor(Math.random() * CARDS.length)];

        // ì„ê¸° ì¢…ë£Œ
        if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
        if (faceTimer) { clearInterval(faceTimer); faceTimer = null; }
        card3d.classList.remove('shuffling');

        // ì•ë©´ ì„¸íŒ… + ë°˜ì§ â†’ ë’¤ì§‘
        frontImg.src = card.file;

        // flash íš¨ê³¼ê°€ ë§¤ë²ˆ í™•ì‹¤íˆ ì¬ìƒë˜ë„ë¡ ë¦¬í”Œë¡œìš° í›„ ì¬ì ìš©
        card3d.classList.remove('flash');
        card3d.getBoundingClientRect();
        card3d.classList.add('flash');
        await wait(120);
        card3d.classList.remove('flash');
        card3d.classList.add('revealed');

        // ë¯¸ë¦¬ë³´ê¸°, ì•¨ë²” ê°±ì‹ , ë³´ìƒ ì²´í¬
        openCardModal(card);
        collected = await fetchMyCards(user.uid);
        renderAlbum(collected);
        if (collected.size === CARDS.length) {
          // ì—¬ê¸°ì„œë„ í˜¹ì‹œ winnerUidê°€ ë¹„ì–´ìˆìœ¼ë©´ ë“±ë¡ â†’ ê·¸ ë‹¤ìŒ ê¸°í”„íŠ¸ ì—´ê¸°!
          const proceed = await maybeSubmitWinner();
          if (!proceed) { 
            return; 
          }
          await openGift();
        }

      } catch (e) {
        console.error(e);
        showToast(e?.message ?? String(e));
      } finally {
        // ì„±ê³µ/ì—ëŸ¬ ëª¨ë‘ í•­ìƒ ì •ë¦¬ (revealedëŠ” ìœ ì§€ë˜ë¯€ë¡œ ì„±ê³µ ì‹œ ì•ë©´ ê·¸ëŒ€ë¡œ!)
        resetShuffleUI();
      }
    }

    drawBtn.addEventListener('click', drawOnce);

    async function fetchMyCards(uid) {
      try {
        const q = query(
          collection(db, 'users_private', uid, 'cards'),
          where('pulls', '>=', 1)
        );
        const snap = await getDocs(q);
        const set = new Set();
        snap.forEach(d => {
          const data = d.data();
          // ë¬¸ì„œ idê°€ keyì¼ ìˆ˜ë„, í•„ë“œë¡œ keyë¥¼ ê°–ê³  ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë‘˜ ë‹¤ ì¼€ì–´!
          const k = (data && data.key) ? data.key : d.id;
          // pullsê°€ 1 ì´ìƒì´ë©´ ì•¨ë²”ì—ì„œ ì»¬ëŸ¬ë¡œ ë³´ì—¬ì¤„ ëŒ€ìƒì´ì•¼
          if (typeof data?.pulls === 'number' && data.pulls >= 1) {
            set.add(k);
          }
        });
        return set;
      } catch {
        return new Set();
      }
    }

    // ---- ì´ë²¤íŠ¸ ì•ˆë‚´ ----
    const eventInfoText = document.getElementById('eventInfoText');
    let eventActive = false;
    let winnerUid = null;
    let winnerNickname = null;

    function formatKST(ts) {
      return moment(ts.toDate()).format('YYYY.MM.DD');
    }

    // ì„œë²„(admin) ì˜ˆì‹œì™€ ë™ì¼í•œ ì¡°ê±´ìœ¼ë¡œ í™œì„± ì´ë²¤íŠ¸ 1ê±´ ì¡°íšŒ
    async function findActiveEventClient() {
      const nowTs = Timestamp.now();
      const q = query(
        collection(db, 'card_events'),
        where('startAt', '<=', nowTs),
        where('endAt', '>=', nowTs),
        orderBy('endAt'),
        orderBy('startAt', 'desc'),
        limit(1)
      );
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const docSnap = snap.docs[0];
      return { id: docSnap.id, data: docSnap.data() };
    }

    // ì´ˆê¸° í‘œì‹œ
    async function initEventInfo() {
      try {
        const active = await findActiveEventClient();
        if (active) {
          const { startAt, endAt } = active.data;
          eventInfoText.textContent = `ì´ë²¤íŠ¸ ê¸°ê°„(${formatKST(startAt)} ~ ${formatKST(endAt)})`;
          eventActive = true;
          winnerUid = active.data.winnerUid;
          winnerNickname = active.data.winnerNickname;
        } else {
          eventInfoText.textContent = 'í˜„ì¬ ì´ë²¤íŠ¸ ì§„í–‰ì¤‘ì´ ì•„ë‹ˆì—ìš”.';
          eventActive = false;
        }
      } catch (e) {
        eventInfoText.textContent = 'ì´ë²¤íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.';
        console.error(e);
      }
    }

    // ë°”ë¡œ ì‹¤í–‰
    initEventInfo();

  </script>
</body>

</html>