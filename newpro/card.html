<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Îâ¥ÌîÑÎ°ú Ïπ¥Îìú ÏÇ¨ÏßÑÏ≤© & Ïπ¥Îìú ÎΩëÍ∏∞" />
  <meta name="theme-color" content="#2a4065">
  <meta property="og:title" content="Îâ¥ÌîÑÎ°ú Ïπ¥Îìú Ïï®Î≤î" />
  <meta property="og:description" content="Ïπ¥ÎìúÎ•º Î™®ÏïÑ Í∏∞ÌîÑÌä∏ÏΩòÏùÑ Î∞õÏïÑÍ∞ÄÏöî!" />
  <title>Îâ¥ÌîÑÎ°ú Ïπ¥Îìú Ïï®Î≤î</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Jua&family=Comic+Neue:wght@400;700&family=Poor+Story&display=swap"
    rel="stylesheet">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="./common/common.css" />
  <style>
    .gift-image {
      max-width: 100%;
      height: 95vh;
      display: block;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    /* Î™®Î∞îÏùº/ÌÉúÎ∏îÎ¶øÏóêÏÑúÎßå: Í∏∞ÌîÑÌä∏ ÎÇ¥Ïó≠ Î™®Îã¨ÏùÑ ÍΩâ Ï±ÑÏö∞Í≥† Ïó¨Î∞± Ï†úÍ±∞ */
    @media (max-width: 991.98px) { /* md Ïù¥Ìïò Ï†ÑÏö© */
      #giftHistoryModal .modal-content {
        border-radius: 0;
      }
      #giftHistoryModal .modal-body,
      #giftHistoryModal .accordion-body {
        padding: 0;            /* Ïù¥ÎØ∏ÏßÄ Ï£ºÎ≥Ä Ïó¨Î∞± Ï´ô Ï†úÍ±∞ */
      }
      #giftHistoryModal .gift-image {
        display: block;
        width: 100vw;          /* ÌôîÎ©¥ Í∞ÄÎ°ú ÍΩâ Ï±ÑÏö∞Í∏∞ */
        max-width: 100%;
        height: auto !important; /* Ï†ÑÏó≠ height:95vh ÎçÆÏñ¥Ïì∞Í∏∞ */
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        object-fit: contain;   /* Î∞îÏΩîÎìú ÏûòÎ¶¨ÏßÄ ÏïäÍ≤å */
      }
    }

    .badge-soft {
      background: rgba(42, 64, 101, .15);
      color: #2a4065;
      border: 1px solid rgba(42, 64, 101, .25);
    }

    /* Reel (Î£∞Î†õ) */
    .reel-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      background: #0e1a31;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .08);
    }

    .reel-strip {
      display: flex;
      gap: 12px;
      padding: 12px;
      will-change: transform;
    }

    .reel-card {
      width: 110px;
      height: 150px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .5);
    }

    .reel-card img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }

    .reel-card::after {
      content: '?';
      position: absolute;
      inset: 0;
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 0 2px 8px rgba(0, 0, 0, .6);
    }

    .reel-indicator {
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 14px solid #ffd166;
      filter: drop-shadow(0 0 6px rgba(255, 209, 102, .9));
      z-index: 2;
    }

    .draw-area .btn-draw {
      position: relative;
      overflow: hidden;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(255, 105, 180, .6);
      background: #ff69b4;
    }

    .btn-draw::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, rgba(255, 255, 255, .6), rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0) 60%, rgba(255, 255, 255, .6));
      animation: shine 2.5s infinite;
    }

    @keyframes shine {
      0% {
        transform: translate(-100%, -100%)
      }

      50% {
        transform: translate(100%, 100%)
      }

      100% {
        transform: translate(-100%, -100%)
      }
    }

    /* Single Card Spinner */
    .single-wrap {
      height: 240px;
      position: relative;
    }

    .single-card {
      width: 180px;
      height: 260px;
      border-radius: 14px;
      background: linear-gradient(145deg, #1c2a4d, #122042);
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
      position: relative;
      transform-style: preserve-3d;
      transition: transform 600ms cubic-bezier(.2, .8, .2, 1);
      margin: 0 auto;
    }

    .single-card.shuffling {
      animation: jiggle 800ms ease-in-out infinite;
      box-shadow: 0 10px 28px rgba(255, 105, 180, .35), 0 0 0 3px rgba(255, 255, 255, .06) inset;
    }

    .single-card.flash::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0) 60%);
      opacity: 0;
      pointer-events: none;
      animation: flash 240ms ease-out;
      border-radius: 14px;
    }

    .single-card.revealed {
      transform: rotateY(180deg);
    }

    .face {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      border-radius: 14px;
      overflow: hidden;
    }

    .face.back {
      color: #fff;
      font-family: 'Comic Neue', cursive;
      font-size: 64px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .6);
    }

    .face.front {
      transform: rotateY(180deg);
      background: #000;
    }

    .face.front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @keyframes jiggle {
      0% {
        transform: rotateY(-12deg) scale(1.0);
      }

      50% {
        transform: rotateY(0deg) scale(1.02);
      }

      100% {
        transform: rotateY(12deg) scale(1.0);
      }
    }

    @keyframes flash {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Ïï®Î≤î Í∑∏Î¶¨Îìú */
    .album-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 14px;
    }

    .album-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #f0f3f8;
      border: 1px solid #e5eaf2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
    }

    .album-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .album-card .label {
      position: absolute;
      left: 8px;
      top: 8px;
      background: rgba(0, 0, 0, .6);
      color: #fff;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: .9rem;
      z-index: 3;
    }

    .album-card.locked::before {
      content: "üîí";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: rgba(0, 0, 0, .35);
      color: #fff;
      z-index: 2;
    }

    .album-card.locked img {
      filter: blur(6px) grayscale(100%);
      transform: scale(1.05);
    }

    /* Giftcon */
    .giftcon {
      background: #fff;
      border-radius: 16px;
      border: 1px dashed #ccd4e0;
      overflow: hidden;
    }

    .giftcon-header {
      padding: 14px;
      background: linear-gradient(135deg, #ffe08a, #ffd166);
      font-weight: 700;
      text-align: center;
    }

    .giftcon-body {
      padding: 16px;
    }

    .barcode-wrap {
      background: #111;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }

    .toast.dark-bg {
      background: rgba(0, 0, 0, .85);
      color: #fff;
    }

    .toast.dark-bg .toast-header {
      background: transparent;
      color: #fff;
      border-bottom: 1px solid #666;
    }

    .toast.dark-bg .btn-close {
      filter: invert(1);
    }

    /* Loader */
    #fullScreenLoader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 3000;
    }

    .loader-content {
      text-align: center;
      color: #fff;
      animation: pulse 1.5s infinite;
    }

    .loader-text {
      font-size: 1.4rem;
      margin-top: .5rem;
      font-family: 'Poor Story', sans-serif;
    }

    @keyframes pulse {
      0% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.06)
      }

      100% {
        transform: scale(1)
      }
    }

    /* --- Ïπ¥Îìú Î™®Îã¨ Ï†ÑÏö© --- */
    #cardModal .modal-content {
      background: transparent !important;
      border: none;
      box-shadow: none;
    }

    #cardModal .modal-header,
    #cardModal .modal-footer {
      display: none;
    }

    #cardModal .modal-body {
      padding: 0;
    }

    /* Ïπ¥Îìú Ïù¥ÎØ∏ÏßÄ */
    #cardModalImg {
      max-width: 90%;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.65);
      transform: translateY(0);
      transition: transform 0.35s ease, box-shadow 0.35s ease;
    }

    #cardModalImg:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
    }

    /* Ï†úÎ™© (Ï∫°ÏÖò Ïä§ÌÉÄÏùº) */
    #cardModalTitle.card-caption {
      font-family: 'Jua', cursive;
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 
        0 2px 4px rgba(0,0,0,0.6),
        0 0 8px rgba(255,255,255,0.2);
      letter-spacing: 1px;
      animation: fadeInUp 0.5s ease;
    }

    /* Îí∑Î∞∞Í≤Ω */
    #cardModal.modal.fade .modal-backdrop.show {
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(4px);
    }

    /* Îì±Ïû• Ïï†ÎãàÎ©îÏù¥ÏÖò */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #cardModalTitle.card-caption {
      cursor: default;
      user-select: none;
    }

    /* ÏûëÏùÄ Ï†êÏàò ÌîåÎ°úÌåÖ Ïπ© */
    .point-float {
      position: absolute;
      left: 50%;
      top: 40%;
      transform: translate(-50%, -50%);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 105, 180, .95);
      color: #fff;
      font-weight: 800;
      font-family: 'Comic Neue', cursive;
      pointer-events: none;
      opacity: 0;
      animation: floatPop 800ms ease-out forwards;
      box-shadow: 0 6px 16px rgba(255, 105, 180, .35);
    }

    @keyframes floatPop {
      0%   { transform: translate(-50%, -20%) scale(.85); opacity: 0; }
      20%  { transform: translate(-50%, -30%) scale(1.05); opacity: 1; }
      100% { transform: translate(-50%, -80%) scale(1.0);  opacity: 0; }
    }

    /* Ìè¨Ïù∏Ìä∏ Î∞∞ÏßÄ ÏÇ¥Ïßù Îõ∞Îäî ÎäêÎÇå */
    #scoreDisplay.pulse {
      animation: scorePulse 600ms ease;
    }
    @keyframes scorePulse {
      0% { filter: drop-shadow(0 0 0 rgba(255,105,180,0)); }
      50% { filter: drop-shadow(0 0 8px rgba(255,105,180,.8)); }
      100% { filter: drop-shadow(0 0 0 rgba(255,105,180,0)); }
    }
    /* --- Ïù¥Ï†Ñ Í∏∞ÌîÑÌä∏ Î™®Îã¨ Îπà ÏÉÅÌÉú --- */
    .gift-empty{
      background:#f8fafc;
      border:1px dashed #e2e8f0;
      border-radius:12px;
      padding:24px;
      text-align:center;
      color:#64748b;
    }
  </style>
</head>

<body>
  <!-- Fullscreen Loader -->
  <div id="fullScreenLoader">
    <div class="loader-content">
      <div class="emoji-large" style="font-size:3rem">üê±‚Äçüíª</div>
      <p class="loader-text">Ï≤òÎ¶¨ Ï§ëÏù¥ÎÉ•~ Í∏∞Îã§Î†§Ï§òÎÉ•~</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="menu-container"></div>

  <section class="hero-section">
    <h1 class="hero-title">Îâ¥ÌîÑÎ°ú Ïπ¥Îìú Ïï®Î≤î</h1>
    <p class="hero-subtitle">Ïπ¥ÎìúÎ•º Î™®ÏïÑÎ™®ÏïÑ~ Ï†ÑÎ∂Ä Î™®ÏúºÎ©¥ üéÅ Í∏∞ÌîÑÌä∏ÏΩòÏù¥ ÏßúÏûî!</p>
  </section>

  <div class="container pb-5">
    <!-- Draw Area -->
    <div class="glass-card p-3 p-md-4 mb-4 draw-area">
      <div class="d-flex justify-content-between flex-wrap align-items-center gap-2 mb-3">
        <div>
          <span class="badge badge-soft me-2">ÏàòÏßë ÌòÑÌô©</span>
          <span class="fw-bold" id="progressText">0 / 0</span>
        </div>
        <div class="ms-auto">
          <span class="badge badge-soft">
            ÎÇ¥ Ìè¨Ïù∏Ìä∏: <b id="scoreDisplay">‚Äî</b>
          </span>
        </div>
        <div class="w-100 d-sm-none"></div>
        <div class="d-flex align-items-center gap-1 gap-sm-2 ms-auto ms-sm-0 flex-wrap">        
          <button class="btn btn-light btn-sm order-3 order-sm-0 ms-auto ms-sm-0" id="showGiftHistoryBtn">üéÅ Í∏∞ÌîÑÌä∏ ÌôïÏù∏</button>
          <button class="btn btn-draw order-3 order-sm-0" id="drawBtn">üé≤ Ïπ¥Îìú ÎΩëÍ∏∞</button>
        </div>        
      </div>

      <div class="single-wrap d-flex justify-content-center align-items-center">
        <div class="single-card" id="card3d">
          <div class="face back" id="cardBack">?</div>
          <div class="face front"><img id="frontImg" src="" alt="card"></div>
        </div>
      </div>

      <small id="eventInfoText" class="text-muted d-block mt-3"></small>
    </div>

    <!-- Album -->
    <div class="glass-card p-3 p-md-4">
      <div class="d-flex align-items-center gap-2 mb-3">
        <h5 class="mb-0 adventure">ÎÇ¥ ÏÇ¨ÏßÑÏ≤©</h5>
        <button id="submitCardsBtn" class="btn btn-light btn-sm ms-auto">
          üìù Ïπ¥Îìú Ï†úÏ∂ú
        </button>
      </div>
    
      <div class="album-grid" id="albumGrid"></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade card-preview-modal" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <!-- Ïπ¥Îìú Ïù¥ÎØ∏ÏßÄ -->
          <img id="cardModalImg" src="" alt="card" />

          <!-- Ïπ¥Îìú Ï†úÎ™© (card.name ÏÑ∏ÌåÖÎê®) -->
          <h5 id="cardModalTitle" class="card-caption mt-3" data-bs-dismiss="modal" aria-label="Close"></h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Gift History Modal -->
  <div class="modal fade" id="giftHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down">
      <div class="modal-content" style="border-radius:16px; overflow:hidden;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Í∏∞ÌîÑÌä∏ ÎÇ¥Ïó≠</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="giftHistoryContainer">
            <div class="gift-empty" id="giftHistoryEmpty" style="display:none;">
              ÏïÑÏßÅ Î∞õÏùÄ Í∏∞ÌîÑÌä∏Í∞Ä ÏóÜÏñ¥Ïöî. Ïπ¥ÎìúÎ•º ÎΩëÏïÑÎ≥¥Ïûê! ‚ú®
            </div>
            <div class="accordion accordion-flush" id="giftHistoryAccordion"></div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Giftcon Modal -->
  <div class="modal fade" id="giftModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
        
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Ï∂ïÌïòÌï¥Ïöî! Î™®Îì† Ïπ¥Îìú Î™®Ïùå ÏôÑÎ£å üéâ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <!-- Ï†ïÎ≥¥ Ïπ¥Îìú -->
          <div class="p-3 rounded" style="background:#f8fafc; border:1px solid #e9eef6">
            <h6 class="mb-2">üéÅ ÏÉÅÌíàÎ™Ö</h6>
            <div class="fs-5 fw-bold">Îâ¥ÌîÑÎ°ú Î™®ÌóòÍ∞Ä Í∏∞ÌîÑÌä∏</div>
            <div class="small text-muted">Î™®ÏùÄ ÎÇ†Ïßú: <span id="giftDate">-</span></div>
            <img id="giftImg" alt="gift" class="gift-image mt-3" />
            <!-- <div class="small text-danger mt-3">
              Ïù¥Î≤§Ìä∏ Ï¢ÖÎ£åÏùºÍπåÏßÄÎßå Ï†ÄÏû• Í∞ÄÎä•ÌïòÎãà Íº≠ ÎØ∏Î¶¨ Îã§Ïö¥Î∞õÏïÑÏ£ºÏÑ∏Ïöî!
            </div> -->
          </div>
        </div> 

        <div class="modal-footer border-0">
          <!-- <button class="btn btn-outline-secondary" id="saveGiftBtn">Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</button> -->
          <button class="btn btn-primary" data-bs-dismiss="modal">Í∫Ñ~ Í≥†ÎßàÏõåÏöî!</button>
        </div>
  
      </div>
    </div>
  </div>

  <!-- Submit Winner Confirm Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px; overflow:hidden;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Ïπ¥Îìú Ï†úÏ∂ú & Í∏∞ÌîÑÌä∏ÏΩò Î∞õÍ∏∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Î™®Îì† Ïπ¥ÎìúÎ•º Î™®ÏïòÏñ¥Ïöî! ÏßÄÍ∏à Î∞îÎ°ú Ï†úÏ∂úÌïòÍ≥† Í∏∞ÌîÑÌä∏ÏΩòÏùÑ Î∞õÏúºÏãúÍ≤†ÏäµÎãàÍπå? ü•≥
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" id="cancelSubmitBtn" data-bs-dismiss="modal">Ïùå.. ÎÇòÏ§ëÏóê</button>
          <button type="button" class="btn btn-primary" id="confirmSubmitBtn">ÎÑ§! Ï†úÏ∂úÌï†ÎûòÏöî üíù</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î™®Îã¨ -->
  <div id="auth-modal-container"></div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script type="module" src="./common/common.js"></script>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { auth, db, functions, storage, analytics } from './common/firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js';
    import { doc, getDoc, setDoc, getDocs, collection, query, where, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-functions.js';

    const drawCard = httpsCallable(functions, 'drawCard'); 
    const addWinner  = httpsCallable(functions, 'addWinner');

    /* ------------------ UI Helpers ------------------ */
    function showLoader(show) { document.getElementById('fullScreenLoader').style.display = show ? 'flex' : 'none'; }
    function launchFireworks(ms = 1600) {
      const end = Date.now() + ms; const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2000 };
      const interval = setInterval(() => { const timeLeft = end - Date.now(); if (timeLeft <= 0) { clearInterval(interval); return; } const particleCount = 50 * (timeLeft / ms); confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } })); }, 250);
    }

    /* ------------------ Cards Data ------------------ */
    const CARDS = [
      { key: 'ddaknim', name: 'Îî±Îãò', file: './images/ddaknim.png' },
      { key: 'hellmaster', name: 'Ìó¨ÎßàÏä§ÌÑ∞', file: './images/hellmaster.png' },
      { key: 'newpro_fairy', name: 'Îâ¥ÌîÑÎ°ú ÏöîÏ†ï', file: './images/newpro_fairy.png' },
      { key: 'svn', name: 'svn', file: './images/svn.png' },
      { key: 'pierrot', name: 'ÌîºÏóêÎ°úÍ∞ÄÎ•¥ÎéÖ', file: './images/pierrot.png' },
      { key: 'aska', name: 'ÏïÑÏä§Ïπ¥', file: './images/aska.png' },
      { key: 'mungyu', name: 'Î©çÏú†', file: './images/mungyu.png' },
      { key: 'ryudog_master', name: 'Î£®ÎèÑÍ∑∏Îë†Îë•', file: './images/ryudog_master.png' },
      { key: 'gayuna', name: 'Í∞ÄÏó∞ÏïÑ', file: './images/gayuna.png' },
      { key: 'mungmyu', name: 'Î©çÎÆ§', file: './images/mungmyu.png' },
      { key: 'tdt', name: '„ÖÜ„Öá„ÖÜ', file: './images/tdt.png' }
    ];

    const progressText = document.getElementById('progressText');
    const albumGrid = document.getElementById('albumGrid');
    const reelStrip = document.getElementById('reelStrip');
    const reelWrap = document.getElementById('reelWrap');
    const drawBtn = document.getElementById('drawBtn');
    const showGiftHistoryBtn = document.getElementById('showGiftHistoryBtn');
    const submitCardsBtn = document.getElementById('submitCardsBtn');
    
    submitCardsBtn.addEventListener('click', submitCard);
    showGiftHistoryBtn.addEventListener('click', openGiftHistory);
    
    // (single card mode - no reel build)
    const submitModalEl = document.getElementById('submitModal');
    const submitModal   = new bootstrap.Modal(submitModalEl, { backdrop: 'static', keyboard: false });
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const cancelSubmitBtn  = document.getElementById('cancelSubmitBtn');
    
    async function submitCard() {             
      if (!eventActive) {
        showToast('ÌòÑÏû¨ Ïù¥Î≤§Ìä∏ ÏßÑÌñâÏ§ëÏù¥ ÏïÑÎãàÏóêÏöî!');
        return;
      }
      const user = auth.currentUser;
      if (!user) { 
        requireLogin(); 
        return; 
      }
      if(collected.size !== CARDS.length) {
        showToast('Î™®Îì† Ïπ¥ÎìúÎ•º Î™®ÏïÑ Ï†úÏ∂úÌïòÏÑ∏Ïöî!');
        return; 
      }
      // ÏÉÅÌô©Ïóê Îî∞Îùº ÏäπÏûê Îì±Î°ù Î®ºÏ†Ä
      const res = await maybeSubmitWinner();
      console.log('res', res)
      if (!res) return; // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜåÌñàÍ±∞ÎÇò Ïã§Ìå®

      const url = res.data.url;
      const strDate = moment(res.data.winnerAt).format('YYYY-MM-DD');
      document.getElementById('giftDate').textContent = strDate;
      const img = document.getElementById('giftImg');
      img.src = url;

      giftModal.show();
      launchFireworks(2000);

      await wait(2000);
      collected = await fetchMyCards(user.uid); 
      renderAlbum(collected);
    }

    function confirmSubmitModal() {
      return new Promise((resolve) => {
        let decision = null;

        const onHidden = () => { off(); resolve(!!decision); };
        const onConfirm = () => { decision = true;  submitModal.hide(); };
        const onCancel  = () => { decision = false; submitModal.hide(); };

        function off() {
          confirmSubmitBtn.removeEventListener('click', onConfirm);
          cancelSubmitBtn.removeEventListener('click', onCancel);
          submitModalEl.removeEventListener('hidden.bs.modal', onHidden);
        }

        confirmSubmitBtn.addEventListener('click', onConfirm, { once: true });
        cancelSubmitBtn.addEventListener('click', onCancel,  { once: true });
        submitModalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });

        submitModal.show();
      });
    }

    // Album grid
    function renderAlbum(collectedSet) {
      albumGrid.innerHTML = '';
      CARDS.forEach(card => {
        const isOwned = collectedSet.has(card.key);
        const div = document.createElement('div');
        div.className = 'album-card' + (isOwned ? '' : ' locked');
        div.innerHTML = `<span class="label">${card.name}</span><img src="${card.file}" alt="${card.name}">`;
        if (isOwned) {
          div.addEventListener('click', () => openCardModal(card));
        }
        albumGrid.appendChild(div);
      });
      progressText.textContent = `${collectedSet.size} / ${CARDS.length}`;
    }

    // Modals
    const cardModal = new bootstrap.Modal(document.getElementById('cardModal'));
    function openCardModal(card) {
      document.getElementById('cardModalTitle').textContent = card.name;
      document.getElementById('cardModalImg').src = card.file;
      cardModal.show();
    }

    // ---------- Gift History(Í∏∞ÌîÑÌä∏ ÎÇ¥Ïó≠) ----------
    const giftHistoryModal = new bootstrap.Modal(document.getElementById('giftHistoryModal'));
    const giftHistoryAccordion = document.getElementById('giftHistoryAccordion');
    const giftHistoryEmpty = document.getElementById('giftHistoryEmpty');


    function normalizeDate(input) {
      if (!input) return null;
      if (typeof input?.toDate === 'function') return input.toDate(); // Firestore Timestamp
      if (typeof input === 'number') return new Date(input);          // epoch ms
      if (input instanceof Date) return input;
      return new Date(input);
    }
    function formatDate(dt) { return moment(dt).format('YYYY-MM-DD'); }

    async function fetchGiftHistory(uid) {
      try {
        const userPrivateDoc = await getDoc(doc(db, 'users_private', uid));
        const data = userPrivateDoc.exists() ? userPrivateDoc.data() : null;
        const arr = Array.isArray(data?.gifts) ? data.gifts : [];
        arr.sort((a, b) => {
          const ad = normalizeDate(a?.winnerAt) || 0;
          const bd = normalizeDate(b?.winnerAt) || 0;
          return bd - ad; // ÏµúÏã†Ïàú
        });
        return arr;
      } catch (e) {
        console.warn('fetchGiftHistory failed', e);
        return [];
      }
    }

    function buildGiftHistoryAccordion(items) {
      giftHistoryAccordion.innerHTML = '';
      if (!items.length) {
        giftHistoryEmpty.style.display = 'block';
        return;
      }
      giftHistoryEmpty.style.display = 'none';

      items.forEach((g, idx) => {
        const when = normalizeDate(g?.winnerAt);
        const whenStr = when ? formatDate(when) : 'ÎÇ†Ïßú ÎØ∏ÏÉÅ';
        const collapseId = `giftCollapse${idx}`;
        const headerId = `giftHeader${idx}`;

        const item = document.createElement('div');
        item.className = 'accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header" id="${headerId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
              ${whenStr}
            </button>
          </h2>
          <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}"
              data-bs-parent="#giftHistoryAccordion">
            <div class="accordion-body">
              <img src="${g?.url || ''}" alt="gift ${whenStr}" class="gift-image"/>          
            </div>
          </div>`;
        giftHistoryAccordion.appendChild(item);
      });
    }

    async function openGiftHistory() {
      const user = auth.currentUser;
      if (!user) { requireLogin(); return; }
      try {
        const items = await fetchGiftHistory(user.uid);
        buildGiftHistoryAccordion(items);
        giftHistoryModal.show();

        if (!items.length) {
          return;
        }

        // 1) Î™®Îã¨Ïù¥ Î≥¥Ïù¥Í∏∞ ÏãúÏûëÌïú Îí§ ÏÇ¥Ïßù ÌÖÄÏùÑ Ï£ºÍ≥† Ï≤´ Ìï≠Î™© ÌéºÏπòÍ∏∞
        setTimeout(() => {
          const firstCollapseEl = document.getElementById('giftCollapse0');
          if (firstCollapseEl) {
            new bootstrap.Collapse(firstCollapseEl, { toggle: true });
          }
        }, 150);

        // 2) Ï≤´ Ìï≠Î™© ÎÇ†ÏßúÍ∞Ä 'ÏµúÍ∑º 3Ïùº Ïù¥ÎÇ¥'Î©¥ Î∂àÍΩÉÎÜÄÏù¥ Î∞úÏÇ¨! (ÎØ∏Îûò ÎÇ†ÏßúÎäî Ï†úÏô∏)
        const when = normalizeDate(items[0]?.winnerAt);
        if (when) {
          const diffDays = moment().diff(moment(when), 'days'); // Ïò§Îäò=0, Ïñ¥Ï†ú=1 ‚Ä¶
          if (diffDays >= 0 && diffDays <= 3) {
            setTimeout(() => launchFireworks(1600), 200);
          }
        }
      } catch (e) {
        showToast(e?.message ?? 'Í∏∞ÌîÑÌä∏ ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî.');
      }
    }

    // Giftcon
    const giftModal = new bootstrap.Modal(document.getElementById('giftModal'));
    function drawBarcode(canvas, code) {
      const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height;
      ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#000';
      // simple pseudo barcode: map digits to bar widths
      let x = 10; const top = 10; const bottom = H - 10;
      for (let i = 0; i < code.length; i++) {
        const d = code.charCodeAt(i) % 7 + 1; // 1..7
        ctx.fillRect(x, top, d + 1, bottom - top);
        x += d + 2; // gap
        if (x > W - 10) break;
      }
    }

    async function maybeSubmitWinner() {      
      await initEventInfo();

      // Ï°∞Í±¥: Ïù¥Î≤§Ìä∏ ÏßÑÌñâÏ§ë + Ï†ÑÏπ¥Îìú Î™®Ïùå ÏôÑÎ£å + ÏïÑÏßÅ Ïö∞ÏäπÏûê ÎØ∏Ï†ï
      if (eventActive && collected.size === CARDS.length) {
        const ok = await confirmSubmitModal();
        if (!ok) return null;

        try {
          showLoader(true);
          // ÏÑúÎ≤Ñ Ï∏° addWinnerÍ∞Ä ÌòÑÏû¨ ÌôúÏÑ± Ïù¥Î≤§Ìä∏Ïùò ÏäπÏûêÎ•º "ÎÇò"Î°ú Í∏∞Î°ùÌïúÎã§Í≥† Í∞ÄÏ†ï!
          const res = await addWinner();
          // Îì±Î°ùÏù¥ ÎÅùÎÇ¨ÏúºÎãà Îã§Ïãú Ïù¥Î≤§Ìä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏ÏôÄÏÑú winnerUidÍ∞Ä ÎπàÍ≤å ÏûàÎäîÏßÄ Î≥¥Ï†ï
          await initEventInfo();
          return res;
        } catch (e) {
          showToast(e?.message ?? 'ÏäπÏûê Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏñ¥Ïöî „Ö†„Ö†');
          return null;
        } finally {
          showLoader(null);
        }
      }
      return true;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        collected = await fetchMyCards(user.uid); 
        renderAlbum(collected);
        fetchMyScore(user.uid);
      } else {
        collected = new Set();
        renderAlbum(collected);
        setScoreUI('‚Äî');
      }
    });

    /* ------------------ Draw Animation (single card shuffle + flip reveal) ------------------ */
    let collected = new Set();
    const card3d = document.getElementById('card3d');
    const backFace = document.getElementById('cardBack');
    const frontImg = document.getElementById('frontImg');
    let isShuffling = false;

    // const SOUND_ENABLED = true;     // ÏÜåÎ¶¨ ÎÅÑÎ†§Î©¥ falseÎ°ú!
    const MIN_WAIT = 1200;          // ÏµúÏÜå ÏÑûÎäî ÏãúÍ∞Ñ(ms)
    const TICK_EVERY = 160;         // Îî±- ÏÜåÎ¶¨ ÌÖúÌè¨

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    let tickTimer = null, faceTimer = null; // ÏÇ¨Ïö¥Îìú & Î¨ºÏùåÌëú Ïï†ÎãàÎ©îÏù¥ÏÖò
    const BACK_GLYPHS = ['?', '‚òÖ', '‚òÜ', '‚ùã', '‚ú¶', '‚úß', '‚ùñ', '‚ô¶'];

    // --- Í≥µÌÜµ Î¶¨ÏÖã Ïú†Ìã∏ ---
    function resetShuffleUI() {
      // 1) ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
      if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
      if (faceTimer) { clearInterval(faceTimer); faceTimer = null; }

      // 2) Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÅ¥ÎûòÏä§ Ï†ïÎ¶¨ (revealedÎäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
      card3d.classList.remove('shuffling', 'flash');

      // 3) Ïï†ÎãàÎ©îÏù¥ÏÖò ÏûîÏÉÅ ÎÅäÍ∏∞ (Î¶¨ÌîåÎ°úÏö∞)
      card3d.style.animation = 'none';
      card3d.getBoundingClientRect(); // Í∞ïÏ†ú Î¶¨ÌîåÎ°úÏö∞
      card3d.style.animation = '';

      // 4) Î∞±Î©¥ ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî + ÏÉÅÌÉú Î≥µÍµ¨
      backFace.textContent = BACK_GLYPHS[0];
      isShuffling = false;
      drawBtn.disabled = false;
    }

    async function drawOnce() {
      if (!eventActive) {
        showToast('ÌòÑÏû¨ Ïù¥Î≤§Ìä∏ ÏßÑÌñâÏ§ëÏù¥ ÏïÑÎãàÏóêÏöî!');
        return;
      }

      const user = auth.currentUser;
      if (!user) { requireLogin(); return; }
      if (isShuffling) return;

      isShuffling = true;
      drawBtn.disabled = true;

      // ÏãúÏûë ÏÉÅÌÉú ÏÑ∏ÌåÖ
      card3d.classList.remove('revealed', 'flash'); // ÏïûÎ©¥ Îã´Í≥†
      card3d.classList.add('shuffling');            // ÌùîÎì§ÌùîÎì§ ÏãúÏûë
      backFace.textContent = BACK_GLYPHS[0];

      // if (SOUND_ENABLED) tickTimer = setInterval(playTick, TICK_EVERY);
      faceTimer = setInterval(() => {
        backFace.textContent = BACK_GLYPHS[Math.floor(Math.random() * BACK_GLYPHS.length)];
      }, 120);

      try {
        // ÏÑúÎ≤Ñ Í≤∞Í≥º + ÏµúÏÜå ÎåÄÍ∏∞ ÎèôÏãú
        showPointFloat(`-${drawPoint}`);
        const [cardRes] = await Promise.all([drawCard(), wait(MIN_WAIT)]);
        const { cardKey, newScore } = cardRes.data;
        const card = CARDS.find(c => c.key === cardKey);

        setScoreUI(newScore);

        // ÏÑûÍ∏∞ Ï¢ÖÎ£å
        if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
        if (faceTimer) { clearInterval(faceTimer); faceTimer = null; }
        card3d.classList.remove('shuffling');

        // ÏïûÎ©¥ ÏÑ∏ÌåÖ + Î∞òÏßù ‚Üí Îí§Ïßë
        frontImg.src = card.file;

        // flash Ìö®Í≥ºÍ∞Ä Îß§Î≤à ÌôïÏã§Ìûà Ïû¨ÏÉùÎêòÎèÑÎ°ù Î¶¨ÌîåÎ°úÏö∞ ÌõÑ Ïû¨Ï†ÅÏö©
        card3d.classList.remove('flash');
        card3d.getBoundingClientRect();
        card3d.classList.add('flash');
        await wait(120);
        card3d.classList.remove('flash');
        card3d.classList.add('revealed');

        // ÎØ∏Î¶¨Î≥¥Í∏∞, Ïï®Î≤î Í∞±Ïã†, Î≥¥ÏÉÅ Ï≤¥ÌÅ¨
        openCardModal(card);
        collected = await fetchMyCards(user.uid);
        renderAlbum(collected);

        // const remainTxt = (typeof newScore === 'number') ? ` ÎÇ®ÏùÄ Ï†êÏàò ${newScore}Ï†ê` : '';
        // showToast(`Ïπ¥Îìú ÌöçÎìù! ‚ú®${remainTxt}`);
      } catch (e) {
        console.error(e);
        showToast(e?.message ?? String(e));
      } finally {
        // ÏÑ±Í≥µ/ÏóêÎü¨ Î™®Îëê Ìï≠ÏÉÅ Ï†ïÎ¶¨ (revealedÎäî Ïú†ÏßÄÎêòÎØÄÎ°ú ÏÑ±Í≥µ Ïãú ÏïûÎ©¥ Í∑∏ÎåÄÎ°ú!)
        resetShuffleUI();
      }
    }

    drawBtn.addEventListener('click', drawOnce);

    async function fetchMyCards(uid) {
      try {
        const q = query(
          collection(db, 'users_private', uid, 'cards'),
          where('pulls', '>=', 1)
        );
        const snap = await getDocs(q);
        const set = new Set();
        snap.forEach(d => {
          const data = d.data();
          // Î¨∏ÏÑú idÍ∞Ä keyÏùº ÏàòÎèÑ, ÌïÑÎìúÎ°ú keyÎ•º Í∞ñÍ≥† ÏûàÏùÑ ÏàòÎèÑ ÏûàÏúºÎãà Îëò Îã§ ÏºÄÏñ¥!
          const k = (data && data.key) ? data.key : d.id;
          // pullsÍ∞Ä 1 Ïù¥ÏÉÅÏù¥Î©¥ Ïï®Î≤îÏóêÏÑú Ïª¨Îü¨Î°ú Î≥¥Ïó¨Ï§Ñ ÎåÄÏÉÅÏù¥Ïïº
          if (typeof data?.pulls === 'number' && data.pulls >= 1) {
            set.add(k);
          }
        });
        return set;
      } catch {
        return new Set();
      }
    }

    // ---- Ïù¥Î≤§Ìä∏ ÏïàÎÇ¥ ----
    const eventInfoText = document.getElementById('eventInfoText');
    let eventActive = false;

    function formatKST(ts) {
      return moment(ts.toDate()).format('YYYY.MM.DD');
    }

    // ÏÑúÎ≤Ñ(admin) ÏòàÏãúÏôÄ ÎèôÏùºÌïú Ï°∞Í±¥ÏúºÎ°ú ÌôúÏÑ± Ïù¥Î≤§Ìä∏ 1Í±¥ Ï°∞Ìöå
    async function findActiveEventClient() {
      const nowTs = Timestamp.now();
      const q = query(
        collection(db, 'card_events'),
        where('winnerUid', '==', null),
        limit(1)
      );
      const snap = await getDocs(q);
      return !snap.empty;
    }

    // Ï¥àÍ∏∞ ÌëúÏãú
    async function initEventInfo() {
      eventActive = await findActiveEventClient();
    }

    /* ------------------ Points UI helpers (NEW) ------------------ */
    const scoreDisplay = document.getElementById('scoreDisplay');

    let currentScore = null;
    let drawPoint = 5;

    function setScoreUI(score) {
      currentScore = score;
      if (scoreDisplay) {
        scoreDisplay.textContent = `${score}Ï†ê`;
        scoreDisplay.classList.remove('pulse');
        // Î¶¨ÌîåÎ°úÏö∞Î°ú Ïï†ÎãàÎ©î Ïû¨ÏÉù Î≥¥Ïû•
        void scoreDisplay.offsetWidth;
        scoreDisplay.classList.add('pulse');
      }
    }

    // Ïπ¥Îìú ÏúÑÎ°ú ÏûëÏùÄ "-5" Í∞ôÏùÄ Ïπ© ÎùÑÏö∞Í∏∞
    function showPointFloat(deltaText = '-5') {
      const host = document.querySelector('.single-wrap') || document.body;
      const el = document.createElement('div');
      el.className = 'point-float';
      el.textContent = deltaText;
      host.appendChild(el);
      setTimeout(() => el.remove(), 900);
    }

    /* ÎÇ¥ Ìè¨Ïù∏Ìä∏ Ï¥àÍπÉÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞ (ÌïÑÎìúÎ™ÖÏùÄ ÏÉÅÌô©Ïóê ÎßûÍ≤å Î∞îÍøîÏ§ò)
      users_private/{uid} Î£®Ìä∏ Î¨∏ÏÑúÏóê score ÌïÑÎìúÍ∞Ä ÏûàÎã§Í≥† Í∞ÄÏ†ï */
    async function fetchMyScore(uid) {
      try {
        const userDoc = await getDoc(doc(db, 'users', uid));
        const data = userDoc.exists() ? userDoc.data() : null;
        const score = data?.score ?? data?.points ?? null;
        if (score != null) setScoreUI(score);
      } catch (e) {
        console.warn('fetchMyScore failed', e);
      }
    }


    // Î∞îÎ°ú Ïã§Ìñâ
    initEventInfo();

  </script>
</body>

</html>