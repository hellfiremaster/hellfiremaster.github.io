<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check C Syntax with Tree-sitter and Report Errors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom CSS */
        #fileContent {
            border: 1px solid #ccc;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-family: monospace;
        }
        .code-line {
            display: flex;
        }
        .line-number {
            width: 50px;
            background-color: #f0f0f0;
            text-align: right;
            padding-right: 10px;
            padding-left: 5px;
            user-select: none;
        }
        .code-text {
            flex: 1;
            padding-left: 10px;
        }
        .error-line {
            background-color: rgba(255, 0, 0, 0.2);
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <h1 class="text-center mb-4">Enter C Code to Check Syntax</h1>
                <div class="form-group mb-3">
                    <textarea id="codeInput" class="form-control" rows="15" placeholder="Write your C code here...">
#include <iostream>

int main() {
  printf("Hello World!");
  return 0;
}</textarea>
                </div>
                <div class="d-grid">
                    <button id="checkButton" class="btn btn-primary btn-block">Check Syntax</button>
                </div>

                <div id="fileContent" class="mt-4 p-3 bg-light"></div>
                <div id="result" class="mt-3 fw-bold"></div>
                <div id="errorMessages"></div>
            </div>
        </div>
    </div>

    <!-- Include tree-sitter.js -->
    <script src="tree-sitter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (async function() {
            // Get references to the input and display elements
            const codeInput = document.getElementById('codeInput');
            const checkButton = document.getElementById('checkButton');
            const fileContentDiv = document.getElementById('fileContent');
            const resultDiv = document.getElementById('result');
            const errorMessagesDiv = document.getElementById('errorMessages');

            // Initialize Tree-sitter
            await TreeSitter.init();

            const parser = new TreeSitter();

            // Load the C language parser
            const C = await TreeSitter.Language.load('tree-sitter-c.wasm');
            parser.setLanguage(C);

            // Add an event listener for when the check button is clicked
            checkButton.addEventListener('click', function() {
                const code = codeInput.value;

                // Clear previous error messages
                errorMessagesDiv.innerHTML = '';

                // Parse the code using Tree-sitter
                const tree = parser.parse(code);

                // Collect error nodes
                let errorNodes = [];

                // Function to traverse the syntax tree and collect error nodes
                function traverse(node) {
                    if (node.hasError) {
                        let childHasError = false;
                        for (let i = 0; i < node.childCount; i++) {
                            const child = node.child(i);
                            if (child.hasError) {
                                childHasError = true;
                                traverse(child);
                            }
                        }
                        // If none of the children have errors, this is the smallest node with an error
                        if (!childHasError) {
                            errorNodes.push(node);
                        }
                    }
                }

                // Traverse the tree to collect error nodes
                traverse(tree.rootNode);

                // Generate code content with line numbers
                const codeLines = code.split('\n');
                let codeWithLineNumbers = '';

                // Create a Set of error line numbers
                const errorLineNumbers = new Set();
                errorNodes.forEach(node => {
                    errorLineNumbers.add(node.startPosition.row);
                });

                for (let i = 0; i < codeLines.length; i++) {
                    const lineNumber = i + 1;
                    const codeLine = codeLines[i];
                    const escapedCodeLine = escapeHTML(codeLine);

                    const lineClass = errorLineNumbers.has(i) ? 'code-line error-line' : 'code-line';

                    codeWithLineNumbers += `
                    <div class="${lineClass}">
                        <span class="line-number">${lineNumber}</span>
                        <span class="code-text">${escapedCodeLine}</span>
                    </div>`;
                }

                // Display the code content
                fileContentDiv.innerHTML = codeWithLineNumbers;

                if (tree.rootNode.hasError) {
                    resultDiv.textContent = 'Syntax Errors Found in the C Code.';
                    resultDiv.style.color = 'red';

                    // Display error messages
                    errorNodes.forEach((node, index) => {
                        const start = node.startPosition;
                        const errorMessage = document.createElement('p');
                        errorMessage.className = 'error-message';
                        errorMessage.textContent = `Error ${index + 1}: Syntax error at line ${start.row + 1}, column ${start.column + 1}.`;
                        errorMessagesDiv.appendChild(errorMessage);
                    });
                } else {
                    resultDiv.textContent = 'The C Code is Syntactically Valid.';
                    resultDiv.style.color = 'green';
                }
            });

            // Function to escape HTML special characters
            function escapeHTML(str) {
                return str.replace(/[&<>"']/g, function(match) {
                    const escapeMap = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;',
                    };
                    return escapeMap[match];
                });
            }
        })();
    </script>
</body>
</html>
